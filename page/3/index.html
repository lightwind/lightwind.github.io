<!DOCTYPE html>


<html lang="zh-Hans">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="人生是一场难得的修行，不要轻易交白卷" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     Tyler的博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  
  <div id="app">
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">Tyler的博客</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>

<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-三、打包及问题处理" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/18/三、打包及问题处理/"
    >三、打包及问题处理</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/18/三、打包及问题处理/" class="article-date">
  <time datetime="2019-09-18T07:46:21.000Z" itemprop="datePublished">2019-09-18</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a> / <a class="article-category-link" href="/categories/Flutter/学习/">学习</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>Demo地址：<a href="https://gitee.com/QingFengBaiYu/tyler_flutter_app" target="_blank" rel="noopener">tyler_flutter_app</a></p>
<h1 id="1-打包"><a href="#1-打包" class="headerlink" title="1. 打包"></a>1. 打包</h1><h2 id="1-1-Andorid打包"><a href="#1-1-Andorid打包" class="headerlink" title="1.1 Andorid打包"></a>1.1 Andorid打包</h2><img src="/2019/09/18/三、打包及问题处理/32132132132221.png">

<p>Android上和一般Android开发类似，在<code>andorid/app/build.gradle</code>下可以配置<code>applicationId</code>、<code>versionCode</code>、<code>versionName</code>和签名信息等，最后通过<code>flutter build apk</code>完成编译，编译完成的包在<code>build/app/outputs/apk/release</code>下。（截图里面签名有个小错误，注意。）</p>
<h2 id="1-2-IOS打包"><a href="#1-2-IOS打包" class="headerlink" title="1.2 IOS打包"></a>1.2 IOS打包</h2><p>关于IOS打包的部分暂时可以参考<a href="https://guoshuyu.cn/home/wx/Flutter-3.html" target="_blank" rel="noopener">https://guoshuyu.cn/home/wx/Flutter-3.html</a>。后面会实际操作看看里面可能出现的问题。</p>
<p>也可以参考<a href="https://flutterchina.club/ios-release/" target="_blank" rel="noopener">发布的IOS版APP</a>。</p>
<h1 id="2-细节点"><a href="#2-细节点" class="headerlink" title="2. 细节点"></a>2. 细节点</h1><h2 id="2-1-AppBar"><a href="#2-1-AppBar" class="headerlink" title="2.1 AppBar"></a>2.1 AppBar</h2><p>AppBar不仅可以作为标题栏，里面的<code>leading</code>和<code>bottom</code>也有相应的作用。</p>
<ul>
<li><code>bottom</code>：默认支持<code>TabBar</code>，即顶部Tab效果，因为<code>TabBar</code>实现了<code>PreferredSizeWidget</code>的<code>preferredSize</code>。所以自定义的控件只要实现了<code>preferredSize</code>，就可以放到<code>bottom</code>中。比如下面是的搜索栏。</li>
</ul>
<img src="/2019/09/18/三、打包及问题处理/1568796679.jpg">

<ul>
<li><code>leading</code>：通常是左侧按键，不设置时，一般是<code>Drawer</code>的图标或者返回按钮。</li>
<li><code>flexibleSpace</code>：位于<code>bottom</code>和<code>leading</code>之间。</li>
</ul>
<h2 id="2-2-按键"><a href="#2-2-按键" class="headerlink" title="2.2 按键"></a>2.2 按键</h2><p>Flutter中的按键，如<code>Flatbutton</code>，默认是有边距和最小大小的。如果想取消这些默认设置，其中一种方式如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> RawMaterialButton(</span><br><span class="line">    materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,</span><br><span class="line">    padding: padding ?? <span class="keyword">const</span> EdgeInsets.all(<span class="number">0.0</span>),</span><br><span class="line">    constraints: <span class="keyword">const</span> BoxConstraints(minWidth: <span class="number">0.0</span>, minHeight: <span class="number">0.0</span>),</span><br><span class="line">    child: child,</span><br><span class="line">    onPressed: onPressed);</span><br></pre></td></tr></table></figure>

<p>如果在加上<code>Flex</code>，一个可控的填充按键就出来了：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> RawMaterialButton(</span><br><span class="line">    materialTapTargetSize: MaterialTapTargetSize.shrinkWrap,</span><br><span class="line">    padding: padding ?? <span class="keyword">const</span> EdgeInsets.all(<span class="number">0.0</span>),</span><br><span class="line">        constraints: <span class="keyword">const</span> BoxConstraints(minWidth: <span class="number">0.0</span>, minHeight: <span class="number">0.0</span>),</span><br><span class="line">    <span class="comment">// flex</span></span><br><span class="line">    child: <span class="keyword">new</span> Flex(</span><br><span class="line">        mainAxisAlignment: mainAxisAlignment,</span><br><span class="line">        direction: Axis.horizontal,</span><br><span class="line">        children: &lt;Widget&gt;[],</span><br><span class="line">    ),</span><br><span class="line">    onPressed: onPressed);</span><br></pre></td></tr></table></figure>

<h2 id="2-3-StatefulWidget赋值"><a href="#2-3-StatefulWidget赋值" class="headerlink" title="2.3 StatefulWidget赋值"></a>2.3 StatefulWidget赋值</h2><p>这里以给<code>TextField</code>赋值为例，在Flutter中，给有状态的<code>Widget</code>传递状态和数据，一般都是使用<code>controller</code>。示例：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoController</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _DemoControllerState createState() =&gt; _DemoControllerState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoControllerState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">DemoController</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> TextEditingController _controller = <span class="keyword">new</span> TextEditingController();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeDependencies() &#123;</span><br><span class="line">    <span class="keyword">super</span>.didChangeDependencies();</span><br><span class="line">    <span class="comment">// 通过给 controller 的 value 新创建一个 TextEditingValue</span></span><br><span class="line">    _controller.value = <span class="keyword">new</span> TextEditingValue(text: <span class="string">"给输入框填入参数"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TextField(</span><br><span class="line">      <span class="comment">// controller</span></span><br><span class="line">      controller: _controller,</span><br><span class="line">      onChanged: onChanged,</span><br><span class="line">      obscureText: obscureText,</span><br><span class="line">      decoration: <span class="keyword">new</span> InputDecoration(</span><br><span class="line">          hintText: hintText,</span><br><span class="line">          icon: iconData == <span class="keyword">null</span> ? <span class="keyword">null</span> : <span class="keyword">new</span> Icon(iconData);</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>TextEditingValue</code>实际上是<code>ValueNotifier</code>，其中<code>Value</code>的<code>setter</code>方法被重载，一旦改变就触发<code>notifyListeners()</code>方法。而<code>TextEditingController</code>中，通过调用<code>addListener()</code>监听数据改变，从而让UI更新。</p>
<p>赋值还有一个简单的方法：传递一个对象，如class A对象，在控件内部使用对象A.b 的变量绑定控件，外部通过<code>setState({A.b = b2})</code>进行更新。</p>
<h2 id="2-4-GlobalKey"><a href="#2-4-GlobalKey" class="headerlink" title="2.4 GlobalKey"></a>2.4 GlobalKey</h2><p>在Flutter，要主动改变子控件的状态，还可以使用<code>GlobalKey</code>。比如需要主动调用<code>RefreshIndicator</code>显示刷新状态，代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">GlobalKey&lt;RefreshIndicatorState&gt; refreshIndicatorKey;</span><br><span class="line"></span><br><span class="line">showForRefresh() &#123;</span><br><span class="line">  <span class="comment">// 显示刷新</span></span><br><span class="line">  refreshIndicatorKey.currentState.show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  refreshIndicatorKey =  <span class="keyword">new</span> GlobalKey&lt;RefreshIndicatorState&gt;();</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RefreshIndicator(</span><br><span class="line">    key: refreshIndicatorKey,</span><br><span class="line">    onRefresh: onRefresh,</span><br><span class="line">    child: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">      ......</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-5-Redux与主题"><a href="#2-5-Redux与主题" class="headerlink" title="2.5 Redux与主题"></a>2.5 Redux与主题</h2><p>Redux主要用作Flutter全局State的管理器，详细内容可以查看<a href="https://tylerliu.top/2019/09/16/二、快速开发实战/#more">二、快速开发实战</a>。这里主要是通过Redux来实现切换主题的效果。</p>
<p>代码如下，通过<code>StoreProvider</code>加载<code>store</code>，再通过<code>StoreBuilder</code>将<code>store</code>中的<code>themeData</code>绑定到<code>MaterialApp</code>的<code>theme</code>下，之后，在其他<code>Widget</code>中通过<code>Theme.of(context)</code>调用需要的颜色，最终在任意位置调用<code>store.dispatch</code>实现主题颜色修改。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterReduxApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;TylerState&gt;(appReducer,</span><br><span class="line">      initialState: <span class="keyword">new</span> TylerState(</span><br><span class="line">          themeData: <span class="keyword">new</span> ThemeData(</span><br><span class="line">        primarySwatch: TylerColor.primarySwatch,</span><br><span class="line">      )));</span><br><span class="line"></span><br><span class="line">  FlutterReduxApp(&#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 通过 StoreProvider 应用 store</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StoreProvider(</span><br><span class="line">      store: store,</span><br><span class="line">      <span class="comment">// 通过 StoreBuilder 获取 themeData</span></span><br><span class="line">      child: <span class="keyword">new</span> StoreBuilder(builder: (context, store) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MaterialApp(</span><br><span class="line">          theme: store.state.themeData,</span><br><span class="line">          routes: &#123;</span><br><span class="line">            HomePage.sName: (context) &#123;</span><br><span class="line">              <span class="keyword">return</span> HomePage();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">        );</span><br><span class="line">      &#125;),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-6-Hotload与Package"><a href="#2-6-Hotload与Package" class="headerlink" title="2.6 Hotload与Package"></a>2.6 Hotload与Package</h2><p>Flutter的Debug和Release下分别是JIT和AOT模式，而在Debug下，支持Hotload。但需要注意：如果开发过程中，安装的新的第三方库，新的第三方库中包含了原生代码，就需要停止后重新运行。</p>
<p><code>pubspec.yaml</code>文件就是包的依赖目录，其中<code>^</code>表示等于等于，一般<code>upgrade</code>和<code>get</code>都能达到下载包的作用。但是：<code>upgrade</code>会在包有更新的情况下，更新<code>pubspec.lock</code>文件下包的版本。</p>
<h1 id="3-问题处理"><a href="#3-问题处理" class="headerlink" title="3. 问题处理"></a>3. 问题处理</h1><ul>
<li><code>Waiting for another flutter command to release the startup lock</code>：<ol>
<li>打开flutter安装目录 /bin/cache/</li>
<li>删除 lockfile 文件</li>
<li>重启 AndroidStudio</li>
</ol>
</li>
<li>dialog下的黄色线<a href="https://stackoverflow.com/questions/47114639/yellow-lines-under-text-widgets-in-flutter" target="_blank" rel="noopener">yellow-lines-under-text-widgets-in-flutter</a>：<code>showDialog</code>中，默认是没使用<code>Scaffold</code>，这会导致文本有黄色溢出线提示，可以使用<code>Material</code>包一层处理。</li>
<li><code>TabBar</code> + <code>TabView</code> + <code>KeepAlive</code> 的问题，可以通过<code>TabBar</code> + <code>PageView</code>解决。</li>
</ul>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/">Flutter</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-二、快速开发实战" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/16/二、快速开发实战/"
    >二、快速开发实战</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/16/二、快速开发实战/" class="article-date">
  <time datetime="2019-09-16T09:29:33.000Z" itemprop="datePublished">2019-09-16</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a> / <a class="article-category-link" href="/categories/Flutter/学习/">学习</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>Demo地址：<a href="https://gitee.com/QingFengBaiYu/tyler_flutter_app" target="_blank" rel="noopener">tyler_flutter_app</a></p>
<p>本文将介绍如何搭建一个通用的Flutter App常用功能脚手架，快速开发一个完整的Flutter应用。</p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>内容结构：</p>
<img src="/2019/09/16/二、快速开发实战/1568699853.jpg">

<h1 id="1-基础控件"><a href="#1-基础控件" class="headerlink" title="1. 基础控件"></a>1. 基础控件</h1><h2 id="1-1-TabBar控件实现"><a href="#1-1-TabBar控件实现" class="headerlink" title="1.1 TabBar控件实现"></a>1.1 TabBar控件实现</h2><p><code>TabBar</code>是常用的需求，而在Flutter中，<strong><code>Scaffold</code> + <code>AppBar</code> + <code>TabBar</code> + <code>TabBarView</code></strong>是<code>TabBar</code>页面最简单的实现，在加上<code>AutomaticKeepAliveClientMixin</code>用于页面KeepAlive之后，像<a href="https://github.com/flutter/flutter/issues/11895" target="_blank" rel="noopener">#11895</a>就会造成Crash。到flutter V0.5.7 SDK修复后，问题还是没有得到完全解决，所以修改实现方式。</p>
<p>目前是通过<strong><code>Scaffold</code> + <code>AppBar</code> + <code>TabBar</code> + <code>TabBarView</code></strong>来组合实现效果，从而解决上面的问题。地址：<a href="https://gitee.com/QingFengBaiYu/FlutterTabBar" target="_blank" rel="noopener">FlutterTabBar</a>。</p>
<p>作为一个<code>TabBar Widget</code>，肯定继承<code>StatefulWidget</code>，需要实现它的<code>State</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TylerTabBarState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TylerTabBar</span>&gt; <span class="title">with</span> <span class="title">SingleTickerProviderStateMixin</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">int</span> _type;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; _tabItems;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;Widget&gt; _tabViews;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Color _backgroundColor;</span><br><span class="line">  <span class="keyword">final</span> Color _indicatorColor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Widget _title;</span><br><span class="line">  <span class="keyword">final</span> Widget _drawer;</span><br><span class="line">  <span class="keyword">final</span> Widget _floatingActionButton;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> PageController _pageController;</span><br><span class="line"></span><br><span class="line">  _TylerTabBarState(<span class="keyword">this</span>._type, <span class="keyword">this</span>._tabItems, <span class="keyword">this</span>._tabViews, <span class="keyword">this</span>._backgroundColor, <span class="keyword">this</span>._indicatorColor,</span><br><span class="line">      <span class="keyword">this</span>._title, <span class="keyword">this</span>._drawer, <span class="keyword">this</span>._floatingActionButton, <span class="keyword">this</span>._pageController)</span><br><span class="line">      : <span class="keyword">super</span>();</span><br><span class="line"></span><br><span class="line">  TabController _tabController;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">// 初始化时创建控制器</span></span><br><span class="line">    <span class="comment">// 通过with SingleTickerProviderStateMixin 实现动画效果</span></span><br><span class="line">    _tabController = <span class="keyword">new</span> TabController(length: _tabItems.length, vsync: <span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 顶部TabBar模式</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._type == TylerTabBar.TOP_TAB) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">        <span class="comment">// 设置侧边滑出 drawer， 不需要可以不设置</span></span><br><span class="line">        drawer: _drawer,</span><br><span class="line">        <span class="comment">// 设置悬浮按钮，不需要可以不设置</span></span><br><span class="line">        floatingActionButton: _floatingActionButton,</span><br><span class="line">        <span class="comment">// 标题栏</span></span><br><span class="line">        appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">          backgroundColor: _backgroundColor,</span><br><span class="line">          title: _title,</span><br><span class="line">          <span class="comment">// TabBar控件</span></span><br><span class="line">          bottom: <span class="keyword">new</span> TabBar(</span><br><span class="line">            <span class="comment">//顶部时，tabBar为可以滑动模式</span></span><br><span class="line">            isScrollable: <span class="keyword">true</span>,</span><br><span class="line">            <span class="comment">// 必须有的控制器，与pageView的控制器同步</span></span><br><span class="line">            controller: _tabController,</span><br><span class="line">            <span class="comment">// 每一个tab item，是一个List&lt;Widget&gt;</span></span><br><span class="line">            tabs: _tabItems,</span><br><span class="line">            <span class="comment">// tab底部选中条颜色</span></span><br><span class="line">            indicatorColor: _indicatorColor,</span><br><span class="line">          ),</span><br><span class="line">        ),</span><br><span class="line">        <span class="comment">// 页面主体，PageView，用于承载Tab对应的页面</span></span><br><span class="line">        body: <span class="keyword">new</span> PageView(</span><br><span class="line">          <span class="comment">// 必须有的控制器，与tabBar的控制器同步</span></span><br><span class="line">          controller: _pageController,</span><br><span class="line">          <span class="comment">// 每一个 tab 对应的页面主体，是一个List&lt;Widget&gt;</span></span><br><span class="line">          children: _tabViews,</span><br><span class="line">          <span class="comment">// 页面触摸作用滑动回调，用于同步 tab 选中状态</span></span><br><span class="line">          onPageChanged: (index) &#123;</span><br><span class="line">            _tabController.animateTo(index);</span><br><span class="line">          &#125;,</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 底部TabBar模式</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">      <span class="comment">// 设置侧边滑出 drawer， 不需要可以不设置</span></span><br><span class="line">      drawer: _drawer,</span><br><span class="line">      <span class="comment">// 设置悬浮按钮，不需要可以不设置</span></span><br><span class="line">      floatingActionButton: _floatingActionButton,</span><br><span class="line">      <span class="comment">// 标题栏</span></span><br><span class="line">      appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">        backgroundColor: _backgroundColor,</span><br><span class="line">        title: _title,</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">// 页面主体，PageView，用于承载Tab对应的页面</span></span><br><span class="line">      body: <span class="keyword">new</span> PageView(</span><br><span class="line">        <span class="comment">// 必须有的控制器，与tabBar的控制器同步</span></span><br><span class="line">        controller: _pageController,</span><br><span class="line">        <span class="comment">// 每一个 tab 对应的页面主体，是一个List&lt;Widget&gt;</span></span><br><span class="line">        children: _tabViews,</span><br><span class="line">        <span class="comment">// 页面触摸作用滑动回调，用于同步 tab 选中状态</span></span><br><span class="line">        onPageChanged: (index) &#123;</span><br><span class="line">          _tabController.animateTo(index);</span><br><span class="line">        &#125;,</span><br><span class="line">      ),</span><br><span class="line">      bottomNavigationBar: <span class="keyword">new</span> Material(</span><br><span class="line">        color: _backgroundColor,</span><br><span class="line">        <span class="comment">// tabBar控件</span></span><br><span class="line">        child: <span class="keyword">new</span> TabBar(</span><br><span class="line">          <span class="comment">// 必须有的控制器，与pageView的控制器同步</span></span><br><span class="line">          controller: _tabController,</span><br><span class="line">          <span class="comment">// 每一个tab item，是一个List&lt;Widget&gt;</span></span><br><span class="line">          tabs: _tabItems,</span><br><span class="line">          <span class="comment">// tab底部选中条颜色</span></span><br><span class="line">          indicatorColor: _indicatorColor,</span><br><span class="line">        ),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="comment">// 页面销毁时，销毁控制器</span></span><br><span class="line">    _tabController.dispose();</span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是一个底部<code>TabBar</code>的页面效果。<code>TabBar</code>和<code>PageView</code>之间通过<code>_pageController</code>和<code>_tabController</code>实现Tab和页面的同步，通过<code>SingleTickerProvidersStateMixin</code>实现Tab的动画切换效果，如果需要多个嵌套动画效果，需要使用<code>TickerProvidersStateMixin</code>。代码中可以看到：</p>
<ul>
<li>手动左右滑动<code>PageView</code>时，通过<code>onPageChanged()</code>回调调用<code>_tabController.animateTo(index);</code>同步<code>TabBar</code>状态。</li>
<li><code>_tabItems</code>中，监听每个<code>TabBarItem</code>的点击，通过<code>_pageController</code>实现<code>PageView</code>的状态同步。</li>
</ul>
<p>上面的代码还缺少<code>TabBarItem</code>的点击，这块会被放到外部实现。也可以直接在内部封装好控件，直接传递配置数据显示。</p>
<p>外部调用如下：每个<code>TabBar</code>点击时，通过<code>pageController.jumoTo()</code>跳转页面，每个页面都需要跳转坐标为：<strong>当前屏幕大小乘以索引<code>index</code></strong>。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_tab_bar/tab_bar_page_first.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_tab_bar/tab_bar_page_second.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_tab_bar/tab_bar_page_three.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_tab_bar/tyler_tab_bar.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TabBarBottomPageWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _TabBarBottomPageWidgetState createState() =&gt; _TabBarBottomPageWidgetState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_TabBarBottomPageWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">TabBarBottomPageWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> PageController _topPageController = <span class="keyword">new</span> PageController();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">List</span>&lt;<span class="built_in">String</span>&gt; _tab = [<span class="string">"动态"</span>, <span class="string">"趋势"</span>, <span class="string">"我的"</span>];</span><br><span class="line"></span><br><span class="line">  _renderTab() &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;Widget&gt; list = <span class="keyword">new</span> <span class="built_in">List</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; _tab.length; i++) &#123;</span><br><span class="line">      list.add(<span class="keyword">new</span> FlatButton(</span><br><span class="line">          onPressed: () &#123;</span><br><span class="line">            _topPageController.jumpTo(MediaQuery.of(context).size.width * i);</span><br><span class="line">          &#125;,</span><br><span class="line">          child: <span class="keyword">new</span> Text(</span><br><span class="line">            _tab[i],</span><br><span class="line">            maxLines: <span class="number">1</span>,</span><br><span class="line">          )));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _renderPage() &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      <span class="keyword">new</span> TabBarPageFirst(),</span><br><span class="line">      <span class="keyword">new</span> TabBarPageSecond(),</span><br><span class="line">      <span class="keyword">new</span> TabBarPageThree(),</span><br><span class="line">    ];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> TylerTabBar(</span><br><span class="line">      type: TylerTabBar.BOTTOM_TAB,</span><br><span class="line">      <span class="comment">// 渲染 tab</span></span><br><span class="line">      tabItems: _renderTab(),</span><br><span class="line">      <span class="comment">// 渲染页面</span></span><br><span class="line">      tabViews: _renderPage(),</span><br><span class="line">      topPageController: _topPageController,</span><br><span class="line">      backgroundColor: Colors.black45,</span><br><span class="line">      indicatorColor: Colors.white,</span><br><span class="line">      title: <span class="keyword">new</span> Text(<span class="string">"Flutter的TabBar"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里，会发现，当页面点击切换时，<code>StatefulWidget</code>的子页面每次都会重新调用<code>initState()</code>。无法实现页面同步跳转，这时就需要<code>AutomaticKeepAliveClentMixin</code>。</p>
<p>每个Taba对应的<code>StatefulWidget</code>的<code>State</code>，需要通过<code>with AutomaticKeepAliveClentMixin</code>，然后重写：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line"><span class="built_in">bool</span> <span class="keyword">get</span> wantKeepAlive =&gt; <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>

<p>就可以实现不重新构建的效果了。</p>
<p>这样底部的Tab就实现了，再来看看顶部Tab的实现。顶部Tab和顶部Tab的区别如下：</p>
<ul>
<li>底部Tab是放在<code>Scaffold</code>的<code>bottomNavigation</code>中的。</li>
<li>顶部Tab是放在<code>AppBar</code>的<code>bottom</code>中的，即标题栏下方。</li>
</ul>
<p>同时在顶部Tab中增加了<code>isScrollable: true</code>属性，代码如下：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> Scaffold(</span><br><span class="line">    <span class="comment">// 设置侧边滑出 drawer， 不需要可以不设置</span></span><br><span class="line">    drawer: _drawer,</span><br><span class="line">    <span class="comment">// 设置悬浮按钮，不需要可以不设置</span></span><br><span class="line">    floatingActionButton: _floatingActionButton,</span><br><span class="line">    <span class="comment">// 标题栏</span></span><br><span class="line">    appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">      backgroundColor: _backgroundColor,</span><br><span class="line">      title: _title,</span><br><span class="line">      <span class="comment">// TabBar控件</span></span><br><span class="line">      bottom: <span class="keyword">new</span> TabBar(</span><br><span class="line">        <span class="comment">//顶部时，tabBar为可以滑动模式</span></span><br><span class="line">        isScrollable: <span class="keyword">true</span>,</span><br><span class="line">        <span class="comment">// 必须有的控制器，与pageView的控制器同步</span></span><br><span class="line">        controller: _tabController,</span><br><span class="line">        <span class="comment">// 每一个tab item，是一个List&lt;Widget&gt;</span></span><br><span class="line">        tabs: _tabItems,</span><br><span class="line">        <span class="comment">// tab底部选中条颜色</span></span><br><span class="line">        indicatorColor: _indicatorColor,</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">    <span class="comment">// 页面主体，PageView，用于承载Tab对应的页面</span></span><br><span class="line">    body: <span class="keyword">new</span> PageView(</span><br><span class="line">      <span class="comment">// 必须有的控制器，与tabBar的控制器同步</span></span><br><span class="line">      controller: _pageController,</span><br><span class="line">      <span class="comment">// 每一个 tab 对应的页面主体，是一个List&lt;Widget&gt;</span></span><br><span class="line">      children: _tabViews,</span><br><span class="line">      <span class="comment">// 页面触摸作用滑动回调，用于同步 tab 选中状态</span></span><br><span class="line">      onPageChanged: (index) &#123;</span><br><span class="line">        _tabController.animateTo(index);</span><br><span class="line">      &#125;,</span><br><span class="line">    ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<img src="/2019/09/16/二、快速开发实战/1568703307.jpg">

<p>在<code>TabBar</code>页面中，一般还会出现：<strong>父页面需要控制<code>PageView</code>中子页面的需求</strong>。这时，就需要用到<code>GlobalKey</code>了。比如<code>GlobalKey&lt;PageOneState&gt; stateOne = new GlobalKet&lt;PageOneState&gt;();</code>，通过<code>globalkey.currentState</code>对象，就可以调用<code>PageOneState</code>中的方法。要注意，<code>GlobalKey</code>需要是全局唯一的，一般可以在<code>build()</code>中创建。</p>
<h2 id="1-2-上下刷新列表"><a href="#1-2-上下刷新列表" class="headerlink" title="1.2 上下刷新列表"></a>1.2 上下刷新列表</h2><p>Flutter提供了<code>RefreshIndicator</code>作为内置下拉刷新控件；同时通过给<code>ListView</code>添加<code>ScrollController</code>做滑动监听，在最后添加一个<code>item</code>，作为上滑加载更多的Loading显示。</p>
<p>代码如下，通过<code>RefreshIndicator</code>控件可以简单完成下拉刷新工作。注意：<strong>可以利用<code>GlobalKey&lt;RefreshIndicatorState&gt;</code>对外提供<code>RefreshIndicator</code>的<code>RefreshIndicatorState</code>，这样外部就可以通过<code>GlobalKey</code>调用<code>globalKey.currenState.show();</code>，主动显示刷新状态并触发<code>onRefresh()</code>。</strong></p>
<p><strong>上拉加载更多</strong>在代码中是通过<code>_getListCount()</code>方法，在原本的基础数据上，增加实际需要渲染的<code>item</code>数量给<code>ListView</code>实现的，最后通过<code>ScrollController</code>监听到底部，触发<code>onLoadMore()</code>。</p>
<p>代码如下，通过<code>_getListCount()</code>，还可以配置空白页面，头布局等效果。其实就是<strong>在内部通过改变实际<code>item</code>数量与渲染<code>item</code>，以实现更多配置的效果。</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_spinkit/flutter_spinkit.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上下拉刷新控件</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullLoadWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _PullLoadWidgetState createState() =&gt; _PullLoadWidgetState(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_PullLoadWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">PullLoadWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> IndexedWidgetBuilder itemBuilder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 载更多回调</span></span><br><span class="line">  <span class="keyword">final</span> RefreshCallback onLoadMore;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 拉刷新回调</span></span><br><span class="line">  <span class="keyword">final</span> RefreshCallback onRefresh;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> Key refreshKey;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 控制器，比如数据和一些配置</span></span><br><span class="line">  <span class="keyword">final</span> PullLoadWidgetController _controller;</span><br><span class="line"></span><br><span class="line">  _PullLoadWidgetState(<span class="keyword">this</span>._controller, <span class="keyword">this</span>.itemBuilder, <span class="keyword">this</span>.onRefresh, <span class="keyword">this</span>.onLoadMore, <span class="keyword">this</span>.refreshKey);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> ScrollController _scrollController = <span class="keyword">new</span> ScrollController();</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="comment">// 添加滑动监听</span></span><br><span class="line">    _scrollController.addListener(() &#123;</span><br><span class="line">      <span class="comment">// 判断当前滑动位置是不是达到底部，触发加载更多的回调</span></span><br><span class="line">      <span class="keyword">if</span> (_scrollController.position.pixels == _scrollController.position.maxScrollExtent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.onLoadMore != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>._controller.needLoadMore.value) &#123;</span><br><span class="line">          <span class="keyword">this</span>.onLoadMore();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  根据配置状态返回实际列表数量，</span></span><br><span class="line"><span class="comment">  实际上这里可以根据需要做更多处理，</span></span><br><span class="line"><span class="comment">  比如，多个头部，是否需要空白页面，是否需要显示加载更多。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _getListCount() &#123;</span><br><span class="line">    <span class="comment">// 是否需要头部</span></span><br><span class="line">    <span class="keyword">if</span> (_controller.needHeader) &#123;</span><br><span class="line">      <span class="comment">// 如果需要，用Item 0的 Widget 作为ListView的头部</span></span><br><span class="line">      <span class="comment">// 列表数量大于0时，因为头部和底部加载更多选项，需要对列表数据总数 +2</span></span><br><span class="line">      <span class="keyword">return</span> (_controller.dataList.length &gt; <span class="number">0</span>) ? _controller.dataList.length + <span class="number">2</span> : _controller.dataList.length;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果不需要头部，在没有数据时，固定返回数量1，用于空页面呈现</span></span><br><span class="line">      <span class="keyword">if</span> (_controller.dataList.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果没有数据，因为头部加载更多选项，需要对列表总数 +1</span></span><br><span class="line">      <span class="keyword">return</span> (_controller.dataList.length &gt; <span class="number">0</span>) ? _controller.dataList.length + <span class="number">1</span> : _controller.dataList.length;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  根据配置状态返回实际列表渲染的 item</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  _getItem(<span class="built_in">int</span> index) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!_controller.needHeader &amp;&amp; index == _controller.dataList.length &amp;&amp; _controller.dataList.length != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果不需要头部，并且数据不为0，当index等于数据长度时，渲染加载更多 Item（因为index是从0开始的）</span></span><br><span class="line">      <span class="keyword">return</span> _buildProgressIndicator();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_controller.needHeader &amp;&amp; index == _getListCount() - <span class="number">1</span> &amp;&amp; _controller.dataList.length != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果需要头部，并且数据不为0，当index等于实际渲染长度 -1时，渲染加载更多 Item（因为index是从0开始的）</span></span><br><span class="line">      <span class="keyword">return</span> _buildProgressIndicator();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!_controller.needHeader &amp;&amp; _controller.dataList.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果不需要头部，并且数据为0，渲染空页面</span></span><br><span class="line">      <span class="keyword">return</span> _buildEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 回调外部，正常渲染 Item，如果这里有需要，可以直接返回相对位置的index</span></span><br><span class="line">      <span class="keyword">return</span> itemBuilder(context, index);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RefreshIndicator(</span><br><span class="line">        <span class="comment">// GlobalKey，用户外部获取RefreshIndicator的State，做显示刷新</span></span><br><span class="line">        key: refreshKey,</span><br><span class="line">        <span class="comment">// 下拉刷新触发，返回的是一个Future</span></span><br><span class="line">        onRefresh: onRefresh,</span><br><span class="line">        child: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">          <span class="comment">// 保持ListView任何情况下都能滚动，解决在RefreshIndicator的兼容问题</span></span><br><span class="line">          physics: <span class="keyword">const</span> AlwaysScrollableScrollPhysics(),</span><br><span class="line">          <span class="comment">// 根据状态返回子控件</span></span><br><span class="line">          itemBuilder: (context, index) &#123;</span><br><span class="line">            <span class="keyword">return</span> _getItem(index);</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="comment">// 根据状态返回数量</span></span><br><span class="line">          itemCount: _getListCount(),</span><br><span class="line">          <span class="comment">// 滑动监听</span></span><br><span class="line">          controller: _scrollController,</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  空页面</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Widget _buildEmpty() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Container(</span><br><span class="line">      height: MediaQuery.of(context).size.height - <span class="number">100</span>,</span><br><span class="line">      child: <span class="keyword">new</span> Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          FlatButton(</span><br><span class="line">            onPressed: () &#123;&#125;,</span><br><span class="line">            child: <span class="keyword">new</span> Image(image: <span class="keyword">new</span> AssetImage(<span class="string">'static/images/welcome.png'</span>), width: <span class="number">70.0</span>, height: <span class="number">70.0</span>),</span><br><span class="line">          ),</span><br><span class="line">          Container(</span><br><span class="line">            child: Text(<span class="string">"空白页面"</span>, style: TextStyle(color: Color(<span class="number">0xFF121917</span>))),</span><br><span class="line">          )</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  上拉加载更多</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Widget _buildProgressIndicator() &#123;</span><br><span class="line">    <span class="comment">// 是否需要显示上拉加载更多的Loading</span></span><br><span class="line">    Widget bottomWidget = (_controller.needLoadMore.value)</span><br><span class="line">        ? <span class="keyword">new</span> Row(</span><br><span class="line">            mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">            children: &lt;Widget&gt;[</span><br><span class="line">              <span class="comment">// loading框</span></span><br><span class="line">              <span class="keyword">new</span> SpinKitRotatingCircle(color: Theme.of(context).primaryColor),</span><br><span class="line">              <span class="keyword">new</span> Container(width: <span class="number">5.0</span>),</span><br><span class="line"></span><br><span class="line">              <span class="comment">//加载中文本</span></span><br><span class="line">              <span class="keyword">new</span> Text(</span><br><span class="line">                <span class="string">"正在加载更多，请稍后..."</span>,</span><br><span class="line">                style: TextStyle(</span><br><span class="line">                  color: Color(<span class="number">0xFF121917</span>),</span><br><span class="line">                  fontSize: <span class="number">14.0</span>,</span><br><span class="line">                  fontWeight: FontWeight.bold,</span><br><span class="line">                ),</span><br><span class="line">              )</span><br><span class="line">            ],</span><br><span class="line">          )</span><br><span class="line">        <span class="comment">// 不需要加载更多</span></span><br><span class="line">        : <span class="keyword">new</span> Container();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Padding(</span><br><span class="line">      padding: <span class="keyword">const</span> EdgeInsets.all(<span class="number">20.0</span>),</span><br><span class="line">      child: <span class="keyword">new</span> Center(</span><br><span class="line">        child: bottomWidget,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PullLoadWidgetController</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 数据，对齐增减，不能替换</span></span><br><span class="line">  <span class="built_in">List</span> dataList = <span class="keyword">new</span> <span class="built_in">List</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否需要加载更多</span></span><br><span class="line">  ValueNotifier&lt;<span class="built_in">bool</span>&gt; needLoadMore = <span class="keyword">new</span> ValueNotifier(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否需要头部</span></span><br><span class="line">  <span class="built_in">bool</span> needHeader = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-3-Loading框"><a href="#1-3-Loading框" class="headerlink" title="1.3 Loading框"></a>1.3 Loading框</h2><p>系统默认提供了<code>CircularProgressIndicator</code>等，但是有时无法满足需求，这里有一个第三方库：<a href="https://pub.flutter-io.cn/packages/flutter_spinkit" target="_blank" rel="noopener">flutter_spinkit</a>。</p>
<p>具体代码实现可以看前面的<code>_buildProgressIndicator()</code>中的实现。</p>
<h2 id="1-4-矢量图标库"><a href="#1-4-矢量图标库" class="headerlink" title="1.4 矢量图标库"></a>1.4 矢量图标库</h2><p>比起一般的png图片，矢量图标：</p>
<ul>
<li>可以轻松定义颜色</li>
<li>任意调整大小，且不会模糊</li>
</ul>
<p>矢量图标库是通过引入<code>ttf</code>字体库文件实现，在Flutter中，通过<code>Icon</code>控件，加载对应的<code>IconData</code>显示即可。</p>
<p>Flutter中默认内置的<code>Icons</code>类就提供了丰富的图标，直接通过<code>Icons</code>对象即可使用，同时推荐阿里的<code>iconfont</code>。代码如下，在<code>pubspec.yaml</code>中添加字体库支持：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">fonts:</span></span><br><span class="line"><span class="attr">  - family:</span> <span class="string">wxcIconFont</span></span><br><span class="line"><span class="attr">    fonts:</span></span><br><span class="line"><span class="attr">      - asset:</span> <span class="string">static/font/iconfont.ttf</span></span><br></pre></td></tr></table></figure>

<p>在代码中就可直接使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Icons</span></span><br><span class="line"><span class="keyword">new</span> Tab(</span><br><span class="line">    child: <span class="keyword">new</span> Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[<span class="keyword">new</span> Icon(Icons.list, size: <span class="number">16.0</span>), <span class="keyword">new</span> Text(<span class="string">"趋势"</span>)],</span><br><span class="line">    ),</span><br><span class="line">),</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用iconfont</span></span><br><span class="line"><span class="keyword">new</span> Tab(</span><br><span class="line">    child: <span class="keyword">new</span> Column(</span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[<span class="keyword">new</span> Icon(IconData(<span class="number">0xe6d0</span>, fontFamily: <span class="string">"wxcIconFont"</span>), size: <span class="number">16.0</span>), <span class="keyword">new</span> Text(<span class="string">"我的"</span>)],</span><br><span class="line">    ),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="1-5-路由跳转"><a href="#1-5-路由跳转" class="headerlink" title="1.5 路由跳转"></a>1.5 路由跳转</h2><p>Flutter中的页面跳转是通过<code>Navigator</code>实现的，路由跳转分为：<strong>带参数跳转和不带参数跳转。</strong></p>
<ul>
<li>不带参数跳转：默认可以通过<code>MaterialApp</code>的路由表跳转</li>
<li>带参数跳转：参数可以通过跳转页面的构造方法传递</li>
</ul>
<p>常用的跳转有如下几种使用：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不带参数的路由表跳转</span></span><br><span class="line">Navigator.pushNamed(context, routeName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳转新页面并且替换，比如登录页跳转主页</span></span><br><span class="line">Navigator.pushReplacementNamed(context, routeName);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 跳转到新的路由，并且关闭给定路由的之前的所有页面</span></span><br><span class="line">Navigator.pushNamedAndRemoveUntil(context, <span class="string">'/calendar'</span>, ModalRoute.withName(<span class="string">'/'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 带参数的路由跳转，并且监听返回</span></span><br><span class="line">Navigator.push(context, <span class="keyword">new</span> MaterialPageRoute(builder: (context) =&gt; <span class="keyword">new</span> NotifyPage())).then((res) &#123;</span><br><span class="line">    <span class="comment">// 获取返回处理</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>Navigato.push()</code>返回的是一个<code>Future</code>，这个<code>Future</code>的作用是<strong>在页面返回时被调用的</strong>。即，可以通过<code>Navigator.pop()</code>时返回参数，之后在<code>Future</code>中可以的监听中处理页面的返回结果。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@optionalTypeArgs</span></span><br><span class="line"><span class="keyword">static</span> Future&lt;T&gt; push&lt;T <span class="keyword">extends</span> <span class="built_in">Object</span>&gt;(BuildContext context, Route&lt;T&gt; route) &#123;</span><br><span class="line">    <span class="keyword">return</span> Navigator.of(context).push(route);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-数据模块"><a href="#2-数据模块" class="headerlink" title="2. 数据模块"></a>2. 数据模块</h1><h2 id="2-1-网络请求"><a href="#2-1-网络请求" class="headerlink" title="2.1 网络请求"></a>2.1 网络请求</h2><p>Flutter中，最常用的网络请求库是<a href="https://pub.flutter-io.cn/packages/dio" target="_blank" rel="noopener">dio</a>。dio中封装了网络请求的数据转换、拦截器、请求返回等。详细使用可以查看<a href="https://github.com/flutterchina/dio/blob/master/README-ZH.md" target="_blank" rel="noopener">文档</a>。</p>
<h2 id="2-2-JSON序列化"><a href="#2-2-JSON序列化" class="headerlink" title="2.2 JSON序列化"></a>2.2 JSON序列化</h2><p>Flutter中，比如使用前面的dio进行网络请求返回，如果配置了返回数据格式为JSON，实际上得到的是一个Map。在使用过程中不方便，需要对Map再次进行转化，转成Model实体。</p>
<p>可以使用<code>json_serializable</code>插件，在Flutter中文教程中<a href="https://flutterchina.club/json/" target="_blank" rel="noopener">JSON和序列化</a>已经做了介绍，这里说明一下具体的使用逻辑：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="comment"># Your other regular dependencies here</span></span><br><span class="line"><span class="attr">  json_annotation:</span> <span class="string">^3.0.0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">dev_dependencies:</span></span><br><span class="line">  <span class="comment"># Your other dev_dependencies here</span></span><br><span class="line"><span class="attr">  build_runner:</span> <span class="string">^1.7.0</span></span><br><span class="line"><span class="attr">  json_serializable:</span> <span class="string">^3.2.2</span></span><br></pre></td></tr></table></figure>

<p>使用步骤：</p>
<ol>
<li>创建实体Model，继承<code>Object</code>，然后通过<code>@JsonSerializable()</code>标记类名。</li>
<li>通过<code>with _$TemplateSerializerMixin</code>，将<code>fromJson()</code>方法委托到<code>Template.g.dart</code>的实现中。其中<code>*.g.dart</code>、<code>_$*SerializerMixin</code>、<code>_$*fromJson</code>这三个方法的引入，和<strong>Model所在的dart的文件名与Model类名</strong>有关，具体可以看代码注释。</li>
<li>最后，通过<code>flutter packages pub run build_runner build</code>编译自动生成转换对象。</li>
</ol>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:json_annotation/json_annotation.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">关联文件、允许Template访问 Template.g.dart 中的私有方法</span></span><br><span class="line"><span class="comment">Template.g.dart 是通过命令生成的文件。名称为 xxx.g.dart，xxx为当前dart文件的名称</span></span><br><span class="line"><span class="comment">Template.g.dart 中实现了 _$TemplateFromJson()和_$TemplateToJson()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">part</span> <span class="string">'Template.g.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 标志class需要实现json序列化功能</span></span><br><span class="line"><span class="meta">@JsonSerializable</span>()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> <span class="keyword">extends</span> <span class="title">Object</span></span>&#123;</span><br><span class="line">  <span class="built_in">String</span> name;</span><br><span class="line">  <span class="built_in">int</span> id;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过</span></span><br><span class="line">  <span class="meta">@JsonKey</span>(name: <span class="string">"push_id"</span>)</span><br><span class="line">  <span class="built_in">int</span> pushId;</span><br><span class="line"></span><br><span class="line">  Template(<span class="keyword">this</span>.name, <span class="keyword">this</span>.id, <span class="keyword">this</span>.pushId);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 'Xxx.g.dart'文件中，默认会根据当前类名生成 _$XxxFromJson方法</span></span><br><span class="line">  <span class="keyword">factory</span> Template.fromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>,<span class="keyword">dynamic</span>&gt; json) =&gt; _$TemplateFromJson(json);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>flutter packages pub run build_runner build</code>生成的<code>Template.g.dart</code>的代码如下，可以通过<code>_$TemplateFromJson()</code>和<code>_$TemplateToJson()</code>对实体和Map进行转化，再结合<code>json.decode()</code>和<code>json.encode()</code>，就可以在<code>String</code>、<code>Map</code>、实体间相互转化了。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GENERATED CODE - DO NOT MODIFY BY HAND</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">part</span> of <span class="string">'Template.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// **************************************************************************</span></span><br><span class="line"><span class="comment">// JsonSerializableGenerator</span></span><br><span class="line"><span class="comment">// **************************************************************************</span></span><br><span class="line"></span><br><span class="line">Template _$TemplateFromJson(<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; json) &#123;</span><br><span class="line">  <span class="keyword">return</span> Template(</span><br><span class="line">    json[<span class="string">'name'</span>] <span class="keyword">as</span> <span class="built_in">String</span>,</span><br><span class="line">    json[<span class="string">'id'</span>] <span class="keyword">as</span> <span class="built_in">int</span>,</span><br><span class="line">    json[<span class="string">'push_id'</span>] <span class="keyword">as</span> <span class="built_in">int</span>,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; _$TemplateToJson(Template instance) =&gt; &lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&#123;</span><br><span class="line">      <span class="string">'name'</span>: instance.name,</span><br><span class="line">      <span class="string">'id'</span>: instance.id,</span><br><span class="line">      <span class="string">'push_id'</span>: instance.pushId,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="2-3-Redux-State"><a href="#2-3-Redux-State" class="headerlink" title="2.3 Redux State"></a>2.3 Redux State</h2><p>Redux，全局状态管理机。可以用来实现跨控件管理、同步State。可以使用第三方库<a href="https://pub.flutter-io.cn/packages/flutter_redux" target="_blank" rel="noopener">flutter_redux</a>。</p>
<p>Flutter中是通过实现<code>State()</code>和<code>setState()</code>来渲染和改变<code>StatefulWidget</code>的。</p>
<p>使用<code>flutter_redux</code>是怎样的呢？</p>
<p>比如把用户信息存储在<code>redux</code>的<code>store</code>中，好处：比如修改某个页面修改了当前用户信息，所有绑定的该<code>State</code>的控件都将由<code>Redux</code>同步自动修改。<code>State</code>可以跨页面共享。</p>
<p><code>flutter_redux</code>的使用。在<code>redux</code>中引入了<code>action</code>、<code>reducer</code>、<code>store</code>的概念：</p>
<ul>
<li><code>action</code>：用于定义一个数据变化的请求。</li>
<li><code>reducer</code>：用于根据<code>action</code>产生新状态。</li>
<li><code>store</code>：用于存储和管理<code>state</code>，监听<code>action</code>，将<code>action</code>自动分配给<code>reducer</code>，并根据<code>reducer</code>返回的结果更新<code>state</code>。</li>
</ul>
<p>具体使用如下，首先创建一个<code>State</code>用于存储要保存的对象，其中关键代码在于<code>UserReducer</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 全局Redux State对象，用于保存State数据</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/User.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/user_reducer.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TylerState</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 用户信息</span></span><br><span class="line">  User userInfo;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 构造方法</span></span><br><span class="line">  TylerState(&#123;<span class="keyword">this</span>.userInfo&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过 Reducer 创建 用于store 的 Reducer</span></span><br><span class="line">TylerState appReducer(TylerState state, action) &#123;</span><br><span class="line">  <span class="keyword">return</span> TylerState(</span><br><span class="line">    <span class="comment">// 通过 UserReducer 将 TylerState 内的 userInfo 和 action 关联在一起</span></span><br><span class="line">    userInfo: UserReducer(state.userInfo, action),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是<code>UserReducer</code>的实现。在里面主要通过<code>TypedReducer</code>将<code>Reducer</code>的处理逻辑与定义的<code>action</code>绑定，最后通过<code>combineReducer()</code>返回<code>Reducer&lt;User&gt;</code>对象应用于上面的<code>Store</code>中。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:redux/redux.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/User.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// redux的 combineReducers，通过 TyperReducer 将 UpdateUserAction 与 UpdateUserAction 关联起来</span></span><br><span class="line"><span class="keyword">final</span> UserReducer = combineReducers&lt;User&gt;([TypedReducer&lt;User, UpdateUserAction&gt;(_updateLoaded)]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">如果由 UpdateUserAction 发起一个请求时，</span></span><br><span class="line"><span class="comment">就会调用到 _updateLoaded()</span></span><br><span class="line"><span class="comment"> _updateLoaded 这里接受一个新的userInfo，并返回</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">User _updateLoaded(User user, action) &#123;</span><br><span class="line">  user = action.userInfo;</span><br><span class="line">  <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个 action，用于发起 usrInfo的改变</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UpdateUserAction</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> User userInfo;</span><br><span class="line"></span><br><span class="line">  UpdateUserAction(<span class="keyword">this</span>.userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，通过<code>StoreProvider</code>将创建的<code>store</code>引入到Flutter中。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> main() =&gt; runApp(FlutterReducerApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlutterReducerApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 创建Store，引用 TylerState 中的 appReducer() 创建的Reducer</span></span><br><span class="line">  <span class="keyword">final</span> store = <span class="keyword">new</span> Store&lt;TylerState&gt;(appReducer, initialState: <span class="keyword">new</span> TylerState(userInfo: User.empty()));</span><br><span class="line"></span><br><span class="line">  FlutterReducerApp(&#123;Key key&#125;) : <span class="keyword">super</span>(key: key);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 通过 StoreProvider 应用 store</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StoreProvider(</span><br><span class="line">        store: store,</span><br><span class="line">        child: <span class="keyword">new</span> MaterialApp(</span><br><span class="line">          home: DemoUserStorePage(),</span><br><span class="line">        ));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>DemoUserStorePage</code>中，通过<code>StoreConnector</code>将<code>State</code>绑定到<code>Widget</code>；然后通过<code>StoreProvider.of()</code>获取<code>state</code>对象；通过<code>dispatch()</code>一个<code>Action</code>可以更新<code>State</code>。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter_redux/flutter_redux.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/User.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/tyler_state.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoUserStorePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 通过 StoreConnector 关联 TylerState 中的 User</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StoreConnector&lt;TylerState, User&gt;(</span><br><span class="line">      <span class="comment">// 通过 converter 将 TylerState 中的 userInfo 返回</span></span><br><span class="line">      converter: (store) =&gt; store.state.userInfo,</span><br><span class="line">      <span class="comment">// 在 userInfo 中返回实际渲染的控件</span></span><br><span class="line">      builder: (context, userInfo) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Text(</span><br><span class="line">          userInfo.name,</span><br><span class="line">          style: Theme.of(context).textTheme.display1,</span><br><span class="line">        );</span><br><span class="line">      &#125;,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="comment">// 通过 StoreProvider.of(context) （带有 StoreProvider 下的 context）</span></span><br><span class="line"><span class="comment">// 可以任意的位置访问到 state 中的数据</span></span><br><span class="line">StoreProvider.of(context).state.userInfo;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"><span class="comment">// 通过 dispatch UpdateUserAction，可以更新State</span></span><br><span class="line">StoreProvider.of(context).dispatch(<span class="keyword">new</span> UpdateUserAction(newUserInfo));</span><br></pre></td></tr></table></figure>

<h2 id="2-4-数据库"><a href="#2-4-数据库" class="headerlink" title="2.4 数据库"></a>2.4 数据库</h2><p>Flutter中常用的数据库第三方库是<a href="https://pub.flutter-io.cn/packages/sqflite" target="_blank" rel="noopener">sqflite</a>。完整代码如下，主要是对sqlite语法的使用。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'dart:convert'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:meta/meta.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:sqflite/sqflite.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/single_demo/User.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// 数据库管理类</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoSqlManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> _VERSION = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> _NAME = <span class="string">"demo_github_app_flutter.db"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> Database _database;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  初始化</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> init() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="comment">// 打开 Database</span></span><br><span class="line">    <span class="keyword">var</span> databasePath = <span class="keyword">await</span> getDatabasesPath();</span><br><span class="line">    <span class="built_in">String</span> path = databasePath + _NAME;</span><br><span class="line">    _database = <span class="keyword">await</span> openDatabase(path, version: _VERSION, onCreate: (Database db, <span class="built_in">int</span> version) <span class="keyword">async</span> &#123;</span><br><span class="line">      <span class="comment">// 打开 Database 时，创建一个表</span></span><br><span class="line">      <span class="keyword">await</span> db.execute(<span class="string">"CREATE TABLE Test (id INTEGER PRIMARY KEY, name TEXT, value INTEGER, num REAL)"</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  表格是否存在</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> isTableExits(<span class="built_in">String</span> tableName) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> getCurrentDatabase();</span><br><span class="line">    <span class="keyword">var</span> res = <span class="keyword">await</span> _database.rawQuery(<span class="string">"select * from Sqlite_master where type = 'table' and name = '<span class="subst">$tableName</span>'"</span>);</span><br><span class="line">    <span class="keyword">return</span> res != <span class="keyword">null</span> &amp;&amp; res.length &gt; <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  获取当前数据库对象</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> Future&lt;Database&gt; getCurrentDatabase() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_database == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">await</span> init();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _database;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">  关闭</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> close() &#123;</span><br><span class="line">    <span class="keyword">if</span> (_database != <span class="keyword">null</span>) &#123;</span><br><span class="line">      _database.close();</span><br><span class="line">      _database = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/// 数据库数据提供的基类</span></span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoBaseDbProvider</span> </span>&#123;</span><br><span class="line">  <span class="built_in">bool</span> isTableExits = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">  tableSqlString();</span><br><span class="line"></span><br><span class="line">  tableName();</span><br><span class="line"></span><br><span class="line">  tableBaseString(<span class="built_in">String</span> name, <span class="built_in">String</span> columnId) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">        create table <span class="subst">$name</span> (</span></span><br><span class="line"><span class="string">        <span class="subst">$columnId</span> integer primary key autoincrement,</span></span><br><span class="line"><span class="string">      '''</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future&lt;Database&gt; getDatabase() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> open();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  prepare(name, <span class="built_in">String</span> createSql) <span class="keyword">async</span> &#123;</span><br><span class="line">    isTableExits = <span class="keyword">await</span> DemoSqlManager.isTableExits(name);</span><br><span class="line">    <span class="keyword">if</span> (!isTableExits) &#123;</span><br><span class="line">      Database db = <span class="keyword">await</span> DemoSqlManager.getCurrentDatabase();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">await</span> db.execute(createSql);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@mustCallSuper</span></span><br><span class="line">  open() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isTableExits) &#123;</span><br><span class="line">      <span class="keyword">await</span> prepare(tableName(), tableSqlString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> DemoSqlManager.getCurrentDatabase();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">用户表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoUserInfoDbProvider</span> <span class="keyword">extends</span> <span class="title">DemoBaseDbProvider</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> name = <span class="string">'UserInfo'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> columnId = <span class="string">"_id"</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> columnUserName = <span class="string">"userName"</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> columnData = <span class="string">"data"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> id;</span><br><span class="line">  <span class="built_in">String</span> userName;</span><br><span class="line">  <span class="built_in">String</span> data;</span><br><span class="line"></span><br><span class="line">  DemoUserInfoDbProvider();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; toMap(<span class="built_in">String</span> userName, <span class="built_in">String</span> data) &#123;</span><br><span class="line">    <span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt; map = &#123;columnUserName: userName, columnData: data&#125;;</span><br><span class="line">    <span class="keyword">if</span> (id != <span class="keyword">null</span>) &#123;</span><br><span class="line">      map[columnId] = id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DemoUserInfoDbProvider.fromMap(<span class="built_in">Map</span> map) &#123;</span><br><span class="line">    id = map[columnId];</span><br><span class="line">    userName = map[columnUserName];</span><br><span class="line">    data = map[columnData];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  tableName() &#123;</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  tableSqlString() &#123;</span><br><span class="line">    <span class="keyword">return</span> tableBaseString(name, columnId) +</span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        <span class="subst">$columnUserName</span> text not null,</span></span><br><span class="line"><span class="string">        <span class="subst">$columnData</span> text not null)</span></span><br><span class="line"><span class="string">      '''</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Future _getUserProvider(Database db, <span class="built_in">String</span> userName) <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">List</span>&lt;<span class="built_in">Map</span>&lt;<span class="built_in">String</span>, <span class="keyword">dynamic</span>&gt;&gt; maps = <span class="keyword">await</span> db.query(name,</span><br><span class="line">        columns: [columnId, columnUserName, columnData], where: <span class="string">"<span class="subst">$columnUserName</span> = ?"</span>, whereArgs: [userName]);</span><br><span class="line">    <span class="keyword">if</span> (maps.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      DemoUserInfoDbProvider provider = DemoUserInfoDbProvider.fromMap(maps.first);</span><br><span class="line">      <span class="keyword">return</span> provider;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 插入到数据库</span></span><br><span class="line">  Future insert(<span class="built_in">String</span> userName, <span class="built_in">String</span> eventMapString) <span class="keyword">async</span> &#123;</span><br><span class="line">    Database db = <span class="keyword">await</span> getDatabase();</span><br><span class="line">    <span class="keyword">var</span> userProvider = <span class="keyword">await</span> _getUserProvider(db, userName);</span><br><span class="line">    <span class="keyword">if</span> (userProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="keyword">await</span> db.delete(name, where: <span class="string">"<span class="subst">$columnUserName</span> = ?"</span>, whereArgs: [userName]);</span><br><span class="line">      <span class="built_in">print</span>(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> db.insert(name, toMap(userName, eventMapString));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//获取事件数据</span></span><br><span class="line">  Future&lt;User&gt; getUserInfo(<span class="built_in">String</span> userName) <span class="keyword">async</span> &#123;</span><br><span class="line">    Database db = <span class="keyword">await</span> getDatabase();</span><br><span class="line">    <span class="keyword">var</span> userProvider = <span class="keyword">await</span> _getUserProvider(db, userName);</span><br><span class="line">    <span class="keyword">if</span> (userProvider != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> User.fromJson(json.decode(userProvider.data));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路：通过定义<code>Provider</code>操作数据库：</p>
<ul>
<li>在<code>Provider</code>中定义表名和数据库字段常量，用于创建表和字段操作；</li>
<li>提供数据库与数据实体之间的映射，比如数据库对象与<code>User</code>对象之间的转化；</li>
<li>在调用<code>Provider</code>时，先判断表是否创建，然后再返回数据库对象进行用户查询。</li>
</ul>
<p>如果结合网络请求，通过闭包实现，再需要数据库时，先返回数据库，然后通过<code>next()</code>方法将网络请求的方法返回，最后外部可以通过调用<code>next()</code>方法再执行网络请求。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">UserDao.getUserInfo(userName, needDb: <span class="keyword">true</span>).then((res) &#123;</span><br><span class="line">  <span class="comment">// 数据库结果</span></span><br><span class="line">  <span class="keyword">if</span> (res != <span class="keyword">null</span> &amp;&amp; res.result) &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      userInfo = res.data;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.next;</span><br><span class="line">&#125;).then((res) &#123;</span><br><span class="line">  <span class="comment">// 网络结果</span></span><br><span class="line">  <span class="keyword">if</span> (res != <span class="keyword">null</span> &amp;&amp; res.result) &#123;</span><br><span class="line">    setState(() &#123;</span><br><span class="line">      userInfo = res.data;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="3-其他功能"><a href="#3-其他功能" class="headerlink" title="3. 其他功能"></a>3. 其他功能</h1><h2 id="3-1-返回按键监听"><a href="#3-1-返回按键监听" class="headerlink" title="3.1 返回按键监听"></a>3.1 返回按键监听</h2><p>Flutter中，通过<code>WillPopScope</code>嵌套，可以用于监听处理Android返回键的逻辑。其实<code>WillPopScope</code>并不是监听返回键，而是当前页面将要被pop时，触发的回调。</p>
<p>通过<code>onWillPop()</code>回调返回的<code>Future</code>，判断是否响应pop。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomePage</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 单机提示退出</span></span><br><span class="line">  Future&lt;<span class="built_in">bool</span>&gt; _dialogExitApp(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> showDialog(</span><br><span class="line">        context: context,</span><br><span class="line">        builder: (context) =&gt; <span class="keyword">new</span> AlertDialog(</span><br><span class="line">              content: <span class="keyword">new</span> Text(<span class="string">"是否退出？"</span>),</span><br><span class="line">              actions: &lt;Widget&gt;[</span><br><span class="line">                <span class="keyword">new</span> FlatButton(</span><br><span class="line">                  onPressed: () =&gt; Navigator.of(context).pop(<span class="keyword">false</span>),</span><br><span class="line">                  child: <span class="keyword">new</span> Text(<span class="string">"取消"</span>),</span><br><span class="line">                ),</span><br><span class="line">                <span class="keyword">new</span> FlatButton(</span><br><span class="line">                  onPressed: () =&gt; Navigator.of(context).pop(<span class="keyword">true</span>),</span><br><span class="line">                  child: <span class="keyword">new</span> Text(<span class="string">"确定"</span>),</span><br><span class="line">                )</span><br><span class="line">              ],</span><br><span class="line">            ));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> WillPopScope(</span><br><span class="line">      onWillPop: () &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        如果 return new Future.value(false); popped就不会被处理，</span></span><br><span class="line"><span class="comment">        如果 return new Future.value(true); popped就会触发，</span></span><br><span class="line"><span class="comment">        这里可以通过 showDialog() 弹出确定框，在返回时通过 Navigator.of(context).pop(true/false);</span></span><br><span class="line"><span class="comment">        决定是否退出</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> _dialogExitApp(context);</span><br><span class="line">      &#125;,</span><br><span class="line">      child: <span class="keyword">new</span> Container(</span><br><span class="line">        color: Colors.white,</span><br><span class="line">        child: <span class="keyword">new</span> Text(<span class="string">"测试"</span>),</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-前后台监听"><a href="#3-2-前后台监听" class="headerlink" title="3.2 前后台监听"></a>3.2 前后台监听</h2><p><code>WidgetBindingObserver</code>包含了各种控件的生命周期通知，其中<code>didChangeAppLifecycleState()</code>可以用于做前后台状态监听。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_HomePageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">HomePage</span>&gt; <span class="title">with</span> <span class="title">WidgetsBindingObserver</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 重写 WidgetsBindingObserver 中的 didChangeAppLifecycleState()</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeAppLifecycleState(AppLifecycleState state) &#123;</span><br><span class="line">    <span class="comment">// 通过state判断App前后台切换</span></span><br><span class="line">    <span class="keyword">if</span> (state == AppLifecycleState.resumed) &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Container();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-3-键盘焦点处理"><a href="#3-3-键盘焦点处理" class="headerlink" title="3.3 键盘焦点处理"></a>3.3 键盘焦点处理</h2><p>触摸收起键盘，<code>GestureDetector</code> + <code>FocusScope</code>实现。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_LoginPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">LoginPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">      <span class="comment">// 定义触摸层</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> GestureDetector(</span><br><span class="line">        <span class="comment">// 透明也响应处理</span></span><br><span class="line">        behavior: HitTestBehavior.translucent,</span><br><span class="line">        onTap: () &#123;</span><br><span class="line">          <span class="comment">// 触摸收起键盘</span></span><br><span class="line">          FocusScope.of(context).requestFocus(<span class="keyword">new</span> FocusNode());</span><br><span class="line">        &#125;,</span><br><span class="line">        child: <span class="keyword">new</span> Container(</span><br><span class="line">        ),</span><br><span class="line">      );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-4-启动页"><a href="#3-4-启动页" class="headerlink" title="3.4 启动页"></a>3.4 启动页</h2><p>IOS启动页，在ios/Runner/Assets.xcassets/LaunchImage.imageset/下，<code>Contents.json</code>文件和启动图片，将你的启动页放置在这个目录下，并且修改<code>Contents.json</code>即可，具体尺寸自行谷歌即可。</p>
<p>Android启动页，在android/app/src/main/res/drawable/launch_background.xml中已经有写好的启动页，<code>&lt;item&gt;&lt;bitmap&gt;</code>部分被屏蔽，只需要打开这个屏蔽，并且将你启动图修改为<code>launch_image</code>并放置到各个<code>mipmap</code>文件夹即可，记得各个文件夹下提供相对于大小尺寸的文件。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/">Flutter</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-一、Dart语言和Flutter基础" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/16/一、Dart语言和Flutter基础/"
    >一、Dart语言和Flutter基础</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/16/一、Dart语言和Flutter基础/" class="article-date">
  <time datetime="2019-09-16T02:15:07.000Z" itemprop="datePublished">2019-09-16</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Flutter/">Flutter</a> / <a class="article-category-link" href="/categories/Flutter/学习/">学习</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <p>Demo地址：<a href="https://gitee.com/QingFengBaiYu/tyler_flutter_app" target="_blank" rel="noopener">tyler_flutter_app</a></p>
<h1 id="1-基础"><a href="#1-基础" class="headerlink" title="1. 基础"></a>1. 基础</h1><h2 id="1-1-环境搭建"><a href="#1-1-环境搭建" class="headerlink" title="1.1 环境搭建"></a>1.1 环境搭建</h2><p>参照<a href="https://flutterchina.club/get-started/install/" target="_blank" rel="noopener">Flutter中文网</a>进行环境搭建即可。</p>
<p>需要注意，国内由于一些原因，有时需要配置Flutter的代理，并且国内在搜索Flutter第三方包时，也是在<a href="https://pub.flutter-io.cn/" target="_blank" rel="noopener">https://pub.flutter-io.cn/</a>中搜索，下面是需要配置的环境变量的地址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// win直接配置到环境编辑即可，mac配置到bash_profile</span><br><span class="line">export PUB_HOSTED_URL=https://pub.flutter-io.cn</span><br><span class="line">export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn</span><br></pre></td></tr></table></figure>

<h1 id="2-Dart语言下的Flutter"><a href="#2-Dart语言下的Flutter" class="headerlink" title="2. Dart语言下的Flutter"></a>2. Dart语言下的Flutter</h1><h2 id="2-1-基本类型"><a href="#2-1-基本类型" class="headerlink" title="2.1 基本类型"></a>2.1 基本类型</h2><ul>
<li><code>var</code>：可以定义变量，如<code>var tag = &quot;1111&quot;</code>，这和JS、Kotlin类似，同时Dart算半个动态类型语言，同时支持闭包。</li>
<li>Darrt属于<strong>强类型语言</strong>，但可以用<code>var</code>声明变量，Dart会<strong>自动推导出数据类型</strong>，<code>var</code>实际上是编译器的“语法糖”。<strong><code>dynamic</code>表示动态类型</strong>，被编译后，实际是一个<code>Object</code>类型，在编译期间不进行任何的类型检查，而是在运行期进行类型检查。</li>
<li>Dart的number类型分为<code>int</code>和<code>double</code>，其中Java的long对应的也是Dart中的<code>int</code>类型。Dart中没有<code>float</code>类型。</li>
<li>Dart下只有<code>bool</code>类型可以用于<code>if</code>判断，不同于JS这种使用方式是不合法的<code>var g = &quot;null&quot;;  if(g){}</code>。</li>
<li>Dart中，switch支持<code>String</code>类型。</li>
</ul>
<h2 id="2-2-变量"><a href="#2-2-变量" class="headerlink" title="2.2 变量"></a>2.2 变量</h2><ul>
<li>Dart不需要给变量设置<code>setter</code>、<code>getter</code>方法，这和Kotlin类似。Dart中所有的基础类型、类都继承<code>Object</code>，默认值是<code>null</code>，自带<code>setter</code>、<code>getter</code>。如果是<code>final</code>或<code>const</code>的话，那么它只有一个<code>getter</code>方法。</li>
<li>Dart中<code>final</code>和<code>const</code>表示常量，比如<code>final name = &quot;111&quot;; const value = 10000</code>；同时<code>static const</code>组合代表了静态常量。其中<code>const</code>的值在编译期确定，<code>final</code>的值要到运行时才确定。<strong>Flutter在Release下是AOT模式。</strong></li>
<li>Dart下的数值，在作为字符串使用时，需要显示指定。比如，<code>int i = 0; print(&quot;aaa&quot; + i);</code>，这样是不支持的，需要<code>print(&quot;aaa&quot; + i.toString());</code>。<strong>所以在使用动态类型时，需要注意不要将number类型当作<code>String</code>类型使用。</strong></li>
<li>Dart中数组等于列表，所以<code>var list = [];</code>和<code>List list = new List();</code>可以简单看作是一样的。</li>
</ul>
<h2 id="2-3-方法"><a href="#2-3-方法" class="headerlink" title="2.3 方法"></a>2.3 方法</h2><ul>
<li>Dart下，<code>??</code>、<code>??=</code>属于操作符，如<code>AA ?? &quot;999&quot;</code>表示如果<code>AA</code>为空，返回<code>&quot;999&quot;</code>；<code>AA ??= &quot;999&quot;</code>表示如果<code>AA</code>为空，给<code>AA</code>设置成<code>&quot;999&quot;</code>。</li>
<li>Dart方法可以设置<strong>参数默认值</strong>和<strong>指定名称</strong>。如：<code>getDetail(String userName, reponsName, {branch = &quot;master&quot;}){}</code>方法，这里<code>branch</code>不设置的话，默认<code>&quot;master&quot;</code>。<strong>参数类型</strong>可以指定或不指定。调用效果：<code>getRepositoryDetailDao(&quot;aaa&quot;, &quot;bbb&quot;, branch : &quot;dev&quot;);</code>。</li>
<li>Dart不像Java，没有关键词<code>public</code>、<code>private</code>等修饰符，<code>_</code>表示<code>private</code>，但是有<code>@protected</code>注解。</li>
<li>Dart中多构造函数可以通过如下代码实现。默认构造方法只能有一个，而通过<code>Model.empty()</code>方法可以创建一个空参数的类，其实方法名可以随意创建。而变量初始化值时，只需要通过<code>this.name</code>在构造方法中指定即可：<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelA</span> </span>&#123;</span><br><span class="line">    <span class="built_in">String</span> name;</span><br><span class="line">    <span class="built_in">String</span> tag;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">///默认构造方法，赋值给name和tag</span></span></span><br><span class="line">    ModelA(<span class="keyword">this</span>.name, <span class="keyword">this</span>.tag);</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">///返回一个空的ModelA</span></span></span><br><span class="line">    ModelA.empty();</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="markdown">///返回一个设置了name的ModelA</span></span></span><br><span class="line">    ModelA.forName(<span class="keyword">this</span>.name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="2-4-Flutter"><a href="#2-4-Flutter" class="headerlink" title="2.4 Flutter"></a>2.4 Flutter</h2><p>Flutter支持<code>async</code>、<code>await</code>。这个E7类似，代码如下，只是定义的位置不同。同时异步操作也和E7中的<code>Promise</code>类似，只是Flutter中返回的是<code>Future</code>对象，通过<code>then</code>可以执行下一步。如果返回的还是<code>Future</code>，就可以通过<code>then().then()...</code>进行流式操作。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">///模拟等待两秒，返回OK</span></span></span><br><span class="line">request() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> Future.delayed(<span class="built_in">Duration</span>(seconds: <span class="number">1</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ok!"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">///得到"ok!"后，将"ok!"修改为"ok from request"</span></span></span><br><span class="line">doSomeThing() <span class="keyword">async</span> &#123;</span><br><span class="line">    <span class="built_in">String</span> data = <span class="keyword">await</span> request();</span><br><span class="line">    data = <span class="string">"ok from request"</span>;</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">///打印结果</span></span></span><br><span class="line">renderSome() &#123;</span><br><span class="line">    doSomeThing().then((value) &#123;</span><br><span class="line">        <span class="built_in">print</span>(value);</span><br><span class="line">        <span class="comment"><span class="markdown">///输出ok from request</span></span></span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Flutter中也是通过<code>state</code>跨帧实现管理数据状态的。</li>
<li>Flutter中一切都是由<code>Widget</code>呈现的，通过<code>build()</code>返回<code>Widget</code>。</li>
<li>Stream对应的<code>async</code>/<code>yield</code>也可用于异步。</li>
</ul>
<h1 id="3-Flutter-Widget"><a href="#3-Flutter-Widget" class="headerlink" title="3. Flutter Widget"></a>3. Flutter Widget</h1><p>在Flutter中，一切的显示都是<code>Widget</code>。<code>Widget</code>是一切的基础，作为响应式的渲染，类似MVVM的实现机制。</p>
<p>可以通过修改数据，再用<code>setState()</code>设置数据，Flutter会自动通过绑定的数据更新<code>Widget</code>。<strong>所以开发者要做的就是实现<code>Widget</code>界面，并且和数据绑定起来。</strong></p>
<p><code>Widget</code>分为<strong>有状态</strong>和<strong>无状态</strong>，在Flutter中每个页面都是一帧，无状态就是保持在那一帧，而有状态的<code>Widget</code>当数据更新时，其实是绘制了新的<code>Widget</code>，只是<code>State</code>实现了跨帧的数据同步保存。</p>
<blockquote>
<p>Tip：当代码框中输入<code>stl</code>时，可以自动弹出创建无状态控件的模板选项，而输入<code>stf</code>时，会弹出创建有状态<code>Widget</code>的模板选项。</p>
<p>代码格式化时，括号内外的逗号都会影响格式化时换行的位置。</p>
<p>如果默认换行的线太短，可以在Setting - Editor - Code - Style - Dart - Wrapping and Braces - Hard wrap at设置数值。</p>
</blockquote>
<h2 id="3-1-StatelessWidget"><a href="#3-1-StatelessWidget" class="headerlink" title="3.1 StatelessWidget"></a>3.1 StatelessWidget</h2><p>下面代码是无状态<code>Widget</code>的简单实现。</p>
<p><strong>继承<code>StatelessWidget</code>，通过<code>build()</code>方法返回一个布局好的控件。</strong></p>
<p><code>Widget</code>和<code>Widget</code>之间通过<code>child</code>进行嵌套。其中有的<code>Widget</code>只能有一个<code>child</code>，比如下面的<code>Container</code>；有的<code>Widget</code>可以有多个<code>child</code>，也就是<code>children</code>，比如<code>Column</code>布局。下面代码是<code>Container Widget</code>嵌套了<code>Text Widget</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoWidget</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> text;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 数据可以通过构造方法传递进来</span></span><br><span class="line">  DemoWidget(<span class="keyword">this</span>.text);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 这里返回你需要的控件</span></span><br><span class="line">    <span class="comment">// 这里末尾有没有的逗号，对于格式化代码而已是不一样的</span></span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      <span class="comment">// 白色背景</span></span><br><span class="line">      color: Colors.white,</span><br><span class="line">      <span class="comment">// ?? 表示如果text为空，就返回尾号后的内容</span></span><br><span class="line">      child: Text(text ?? <span class="string">"无状态Demo"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-StatefulWidget"><a href="#3-2-StatefulWidget" class="headerlink" title="3.2 StatefulWidget"></a>3.2 StatefulWidget</h2><p>下面是有状态<code>widget</code>的实现。</p>
<p>需要创建管理的主要是<code>State</code>，通过<code>State</code>的<code>build()</code>方法去构建控件。在<code>State</code>中，可以动态改变数据，这类似MVVM的实现，在<code>setState()</code>之后，改变的数据会触发<code>Widget</code>重新构建刷新。下面代码中，通过延迟两秒之后，让文本显示为<code>“数值改变”</code>。</p>
<p>如下代码还可以看到，<code>State</code>中主要的生命周期有：</p>
<ul>
<li><code>initState()</code>：初始化，理论上只有初始化一次，后面会说一个特殊情况。</li>
<li><code>didChangeDependencies</code>：在<code>initState()</code>之后调用，此时可以获取其他<code>State</code>。</li>
<li><code>dispose()</code>：销毁，只会调用一次。</li>
</ul>
<p>Flutter关注点在于创建<code>StatelessWidget</code>或者<code>StatefulWidget</code>。<strong>在<code>build()</code>中添加布局，然后将数据添加到<code>Widget</code>中，最后通过<code>setState()</code>改变数据，从而实现画面变化。</strong></p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoStatefulWidget</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="built_in">String</span> text;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过构造方法传值</span></span><br><span class="line">  DemoStatefulWidget(<span class="keyword">this</span>.text);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 主要是负责创建state</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _DemoStatefulWidgetState createState() =&gt; _DemoStatefulWidgetState(text);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoStatefulWidgetState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">DemoStatefulWidget</span>&gt; </span>&#123;</span><br><span class="line">  <span class="built_in">String</span> text;</span><br><span class="line"></span><br><span class="line">  _DemoStatefulWidgetState(<span class="keyword">this</span>.text);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> initState() &#123;</span><br><span class="line">    <span class="comment">// 初始化，这个函数在生命周期中只调用一次</span></span><br><span class="line">    <span class="keyword">super</span>.initState();</span><br><span class="line">    <span class="comment">// 定时2秒</span></span><br><span class="line">    <span class="keyword">new</span> Future.delayed(<span class="keyword">const</span> <span class="built_in">Duration</span>(seconds: <span class="number">1</span>), () &#123;</span><br><span class="line">      setState(() &#123;</span><br><span class="line">        text = <span class="string">"数值改变"</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> didChangeDependencies() &#123;</span><br><span class="line">    <span class="comment">// 在initState()之后调 Called when a dependency of this [State] object changes.</span></span><br><span class="line">    <span class="keyword">super</span>.didChangeDependencies();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  <span class="keyword">void</span> dispose() &#123;</span><br><span class="line">    <span class="comment">// 销毁</span></span><br><span class="line">    <span class="keyword">super</span>.dispose();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> Container(</span><br><span class="line">      child: Text(text ?? <span class="string">"这就是有状态Demo"</span>),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-Flutter布局"><a href="#4-Flutter布局" class="headerlink" title="4. Flutter布局"></a>4. Flutter布局</h1><p>Flutter内置了近30多种<a href="https://flutterchina.club/widgets/layout/" target="_blank" rel="noopener">布局<code>Widget</code></a>。下面是常用的布局。</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="left">作用特点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Container</td>
<td align="left">只有一个子Widget。默认充满，包含了<code>padding</code>、<code>margin</code>、<code>color</code>、<code>height</code>、<code>width</code>、<code>decoration</code>等配置。</td>
</tr>
<tr>
<td align="center">Padding</td>
<td align="left">只有一个子Widget。只用于设置Padding，常用于嵌套<code>child</code>，给<code>child</code>设置<code>padding</code>。</td>
</tr>
<tr>
<td align="center">Center</td>
<td align="left">只有一个子Widget。只用于居中显示，常用于嵌套<code>child</code>，给<code>child</code>设置居中。</td>
</tr>
<tr>
<td align="center">Stack</td>
<td align="left">可以有多个子Widget。子Widget堆叠在一起。</td>
</tr>
<tr>
<td align="center">Column</td>
<td align="left">可以有多个子Widget。垂直布局。</td>
</tr>
<tr>
<td align="center">Row</td>
<td align="left">可以有多个子Widget。水平布局。</td>
</tr>
<tr>
<td align="center">Expanded</td>
<td align="left">只有一个子Widget。在<code>Column</code>和<code>Row</code>中充满。</td>
</tr>
<tr>
<td align="center">ListView</td>
<td align="left">可以有多个子Widget。</td>
</tr>
</tbody></table>
<ul>
<li><p><code>Container</code>：最常用的默认布局。只能包含一个<code>child</code>，支持配置<code>padding</code>、<code>margin</code>、<code>color</code>、<code>height</code>、<code>width</code>、<code>decoration</code>（一般配置边框和阴影）等配置。在Flutter中，不是所有的控件都有<code>padding</code>、<code>margin</code>、<code>color</code>、<code>height</code>、<code>width</code>等属性，所有才会有<code>Padding</code>、<code>Center</code>等<code>Widget</code>的存在。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Container(</span><br><span class="line">    <span class="comment">// 四周都是10的margin</span></span><br><span class="line">    margin: EdgeInsets.all(<span class="number">10.0</span>),</span><br><span class="line">    height: <span class="number">120.0</span>,</span><br><span class="line">    width: <span class="number">500.0</span>,</span><br><span class="line">    <span class="comment">// 透明黑色遮罩</span></span><br><span class="line">    decoration: <span class="keyword">new</span> BoxDecoration(</span><br><span class="line">        <span class="comment">// 弧度</span></span><br><span class="line">        borderRadius: BorderRadius.all(Radius.circular(<span class="number">10.0</span>)),</span><br><span class="line">        <span class="comment">// 设置了decoration的color，就不能设置Container的color</span></span><br><span class="line">        color: Colors.black,</span><br><span class="line">        <span class="comment">// 边框</span></span><br><span class="line">        border: <span class="keyword">new</span> Border.all(color: Colors.indigo, width: <span class="number">3.0</span>)),</span><br><span class="line">    child: <span class="keyword">new</span> Text(<span class="string">"77777"</span>),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Column</code>和<code>Row</code>也是最常见的布局。如下，它们常用的属性配置有：主轴方向是<code>start</code>或<code>center</code>等；副轴方向是<code>start</code>或<code>center</code>等；<code>mainAxisSize</code>是充满最大尺寸，或者只根据子Widget显示最小尺寸。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主轴方向，Column的竖向、Row的横向</span></span><br><span class="line">mainAxisAlignment: MainAxisAlignment.start,</span><br><span class="line"><span class="comment">// 默认是最大充满或根据child显示最小大小</span></span><br><span class="line">mainAxisSize: MainAxisSize.max,</span><br><span class="line"><span class="comment">// 副轴方向，Column的横向、Row我的竖向</span></span><br><span class="line">crossAxisAlignment :CrossAxisAlignment.center,</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>Expanded</code>：在<code>Column</code>和<code>Row</code>中表示平均充满，当有两个存在的时候，默认均分充满。同时页面可以设置<code>flex</code>属性决定比例。</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Column(</span><br><span class="line">    <span class="comment">// 主轴居中，即竖直向居中</span></span><br><span class="line">    mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">    <span class="comment">// 大小按照最小显示</span></span><br><span class="line">    mainAxisSize: MainAxisSize.min,</span><br><span class="line">    <span class="comment">// 横向居中</span></span><br><span class="line">    crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">    children: &lt;Widget&gt;[</span><br><span class="line">    <span class="comment">// flex默认为1</span></span><br><span class="line">    <span class="keyword">new</span> Expanded(child: <span class="keyword">new</span> Text(<span class="string">"111"</span>), flex: <span class="number">2</span>),</span><br><span class="line">    <span class="keyword">new</span> Expanded(child: <span class="keyword">new</span> Text(<span class="string">"222"</span>)),</span><br><span class="line">    ],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>下面来写一个复杂的控件。首先创建一个私有方法<code>_getBottomItem()</code>，返回一个<code>Expanded Widget</code>，后面会将这个方法返回的<code>Widget</code>在<code>Row</code>下平均充满。</p>
<p>如代码中注释，布局内主要实现一个居中的Icon图标和文本，中间间隔5.0的<code>padding</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回一个居中带图标和文本的Item</span></span><br><span class="line">_getBottomItem(IconData icon, <span class="built_in">String</span> text) &#123;</span><br><span class="line">  <span class="comment">// 充满 Row 横向的布局</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Expanded(</span><br><span class="line">    flex: <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 居中显示</span></span><br><span class="line">    child: <span class="keyword">new</span> Center(</span><br><span class="line">      <span class="comment">// 横向布局</span></span><br><span class="line">      child: <span class="keyword">new</span> Row(</span><br><span class="line">        <span class="comment">// 主轴居中,即是横向居中</span></span><br><span class="line">        mainAxisAlignment: MainAxisAlignment.center,</span><br><span class="line">        <span class="comment">// 大小按照最大充满</span></span><br><span class="line">        mainAxisSize: MainAxisSize.max,</span><br><span class="line">        <span class="comment">// 竖向居中</span></span><br><span class="line">        crossAxisAlignment: CrossAxisAlignment.center,</span><br><span class="line">        children: &lt;Widget&gt;[</span><br><span class="line">          <span class="comment">// 一个图标，大小16.0，灰色</span></span><br><span class="line">          <span class="keyword">new</span> Icon(icon, size: <span class="number">16.0</span>, color: Colors.grey),</span><br><span class="line">          <span class="comment">// 间隔</span></span><br><span class="line">          <span class="keyword">new</span> Padding(padding: <span class="keyword">new</span> EdgeInsets.only(left: <span class="number">5.0</span>)),</span><br><span class="line">          <span class="comment">// 显示文本</span></span><br><span class="line">          <span class="keyword">new</span> Text(</span><br><span class="line">            text,</span><br><span class="line">            <span class="comment">// 设置字体样式：颜色灰色，字体大小14.0</span></span><br><span class="line">            style: <span class="keyword">new</span> TextStyle(color: Colors.grey, fontSize: <span class="number">14.0</span>),</span><br><span class="line">            <span class="comment">// 超过的省略为...显示</span></span><br><span class="line">            overflow: TextOverflow.ellipsis,</span><br><span class="line">            <span class="comment">// 最长一行</span></span><br><span class="line">            maxLines: <span class="number">1</span>,</span><br><span class="line">          ),</span><br><span class="line">        ],</span><br><span class="line">      ),</span><br><span class="line">    ),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着将上面的方法放到新的布局中。</p>
<ul>
<li>首先<code>Container</code>包含了<code>Card</code>，用于快速简单的实现圆角和阴影。</li>
<li>然后包含了<code>FlatButton</code>实现了点击，通过<code>Padding</code>实现边距。</li>
<li>接着通过<code>Column</code>垂直包含了两个子Widget，一个是<code>Contain</code>，一个是<code>Row</code>。</li>
<li><code>Row</code>内使用的是<code>_getBottomItem()</code>方法返回的<code>Widget</code>，效果图如下。<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@override</span></span><br><span class="line">Widget build(BuildContext context) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Container(</span><br><span class="line">    <span class="comment">// 卡片包装</span></span><br><span class="line">    child: <span class="keyword">new</span> Card(</span><br><span class="line">        <span class="comment">// 点击效果</span></span><br><span class="line">        child: <span class="keyword">new</span> FlatButton(</span><br><span class="line">            onPressed: () &#123;</span><br><span class="line">              <span class="built_in">print</span>(<span class="string">"点击了"</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            child: <span class="keyword">new</span> Padding(</span><br><span class="line">              padding: <span class="keyword">new</span> EdgeInsets.only(</span><br><span class="line">                  left: <span class="number">0.0</span>, top: <span class="number">10.0</span>, right: <span class="number">10.0</span>, bottom: <span class="number">10.0</span>),</span><br><span class="line">              child: <span class="keyword">new</span> Column(</span><br><span class="line">                mainAxisSize: MainAxisSize.min,</span><br><span class="line">                children: &lt;Widget&gt;[</span><br><span class="line">                  <span class="comment">// 文本描述</span></span><br><span class="line">                  <span class="keyword">new</span> Container(</span><br><span class="line">                      child: <span class="keyword">new</span> Text(</span><br><span class="line">                        <span class="string">"这是一点描述"</span>,</span><br><span class="line">                        style: TextStyle(</span><br><span class="line">                          color: Colors.amber,</span><br><span class="line">                          fontSize: <span class="number">14.0</span>,</span><br><span class="line">                        ),</span><br><span class="line">                        <span class="comment">// 最长三行，超过 ... 显示</span></span><br><span class="line">                        maxLines: <span class="number">3</span>,</span><br><span class="line">                        overflow: TextOverflow.ellipsis,</span><br><span class="line">                      ),</span><br><span class="line">                      margin: <span class="keyword">new</span> EdgeInsets.only(top: <span class="number">6.0</span>, bottom: <span class="number">2.0</span>),</span><br><span class="line">                      alignment: Alignment.topLeft),</span><br><span class="line">                  <span class="keyword">new</span> Padding(padding: EdgeInsets.all(<span class="number">10.0</span>)),</span><br><span class="line">                  <span class="comment">// 三个平均分配的横向图标文字</span></span><br><span class="line">                  <span class="keyword">new</span> Row(</span><br><span class="line">                    crossAxisAlignment: CrossAxisAlignment.start,</span><br><span class="line">                    children: &lt;Widget&gt;[</span><br><span class="line">                      _getBottomItem(Icons.star, <span class="string">"1000"</span>),</span><br><span class="line">                      _getBottomItem(Icons.link, <span class="string">"1000"</span>),</span><br><span class="line">                      _getBottomItem(Icons.subject, <span class="string">"1000"</span>),</span><br><span class="line">                    ],</span><br><span class="line">                  ),</span><br><span class="line">                ],</span><br><span class="line">              ),</span><br><span class="line">            ))),</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<img src="/2019/09/16/一、Dart语言和Flutter基础/1568624171.jpg">

<h1 id="5-Flutter页面"><a href="#5-Flutter页面" class="headerlink" title="5. Flutter页面"></a>5. Flutter页面</h1><p>Flutter中除了布局的<code>Widget</code>，还有交互显示的<code>Widget</code>和完整页面呈现的<code>Widget</code>。常见的有<code>MaterialApp</code>、<code>Scaffold</code>、<code>Appbar</code>、<code>Text</code>、<code>Image</code>、<code>FlatBotton</code>等。</p>
<table>
<thead>
<tr>
<th align="center">类型</th>
<th align="left">作用特点</th>
</tr>
</thead>
<tbody><tr>
<td align="center">MaterialApp</td>
<td align="left">一般作为App顶层的主页入口，可配置主题、多语言、路由等</td>
</tr>
<tr>
<td align="center">Scaffold</td>
<td align="left">一般用户页面的承载Widget，包含<code>appbar</code>、<code>snackbar</code>、<code>drawer</code>等Material Design设定</td>
</tr>
<tr>
<td align="center">Appbar</td>
<td align="left">一般用于<code>Scaffold</code>的<code>appbar</code>，内有标题，二级页面返回按键等</td>
</tr>
<tr>
<td align="center">Text</td>
<td align="left">显示文本，主要是通过<code>style</code>设置<code>TextStyle</code>来设置字体样式等</td>
</tr>
<tr>
<td align="center">RichText</td>
<td align="left">富文本，通过设置<code>TextSpan</code>，可以拼接出富文本场景</td>
</tr>
<tr>
<td align="center">TextField</td>
<td align="left">文本输入框，<code>new TextField(controller: // 文本控制器, obscureText: &quot;hint文本&quot;);</code></td>
</tr>
<tr>
<td align="center">Image</td>
<td align="left">图片加载，<code>new FadeInImage.assetNetWork(placeholder: &quot;预览图&quot;, fit: BoxFit.fitWindth, image: &quot;url&quot;);</code></td>
</tr>
<tr>
<td align="center">FlatBotton</td>
<td align="left">按键点击，<code>new FlatBotton(onPressed:(){}, child: new Container());</code></td>
</tr>
</tbody></table>
<p>下面再实现一个完整的页面，实现：</p>
<ul>
<li>创建一个<code>StatefulWidget</code>：<code>DemoPage</code>。</li>
<li>在<code>_DemoPageState()</code>中，通过<code>build()</code>创建一个<code>Scaffold</code>。</li>
<li><code>Scaffold</code>内包含一个<code>Appbar</code>和一个<code>ListView</code>。</li>
<li><code>Appbar</code>类似标题区域，其中设置了<code>title</code>为<code>Text Widget</code>。</li>
<li><code>body</code>是<code>ListView</code>，返回20个之前创建的<code>DemoItem Widget</code>。<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/widget/demo_stateless_widget.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DemoPage</span> <span class="keyword">extends</span> <span class="title">StatefulWidget</span> </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  _DemoPageState createState() =&gt; _DemoPageState();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_DemoPageState</span> <span class="keyword">extends</span> <span class="title">State</span>&lt;<span class="title">DemoPage</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="comment">// 一个页面的开始，如果是新页面，会自带返回按键</span></span><br><span class="line">    <span class="keyword">return</span> Scaffold(</span><br><span class="line">      <span class="comment">// 背景</span></span><br><span class="line">      backgroundColor: Colors.blue,</span><br><span class="line">      <span class="comment">// 标题栏</span></span><br><span class="line">      appBar: <span class="keyword">new</span> AppBar(</span><br><span class="line">        title: <span class="keyword">new</span> Text(<span class="string">"一个标题"</span>),</span><br><span class="line">      ),</span><br><span class="line">      <span class="comment">// 正式页面开始，一个ListView，内有20个ItemView</span></span><br><span class="line">      body: <span class="keyword">new</span> ListView.builder(</span><br><span class="line">        itemBuilder: (context, index) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> DemoItem();</span><br><span class="line">        &#125;,</span><br><span class="line">        itemCount: <span class="number">20</span>,</span><br><span class="line">      ),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>将创建的<code>DemoPage</code>传入<code>main</code>：</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'package:flutter/material.dart'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'package:tyler_flutter_app/widget/demo_page.dart'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> main() =&gt; runApp(MyApp());</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyApp</span> <span class="keyword">extends</span> <span class="title">StatelessWidget</span> </span>&#123;</span><br><span class="line">  <span class="comment">// This widget is the root of your application.</span></span><br><span class="line">  <span class="meta">@override</span></span><br><span class="line">  Widget build(BuildContext context) &#123;</span><br><span class="line">    <span class="keyword">return</span> MaterialApp(</span><br><span class="line">      title: <span class="string">'Tyler Flutter Demo'</span>,</span><br><span class="line">      theme: ThemeData(</span><br><span class="line">        primarySwatch: Colors.blue,</span><br><span class="line">      ),</span><br><span class="line">      home: DemoPage(),</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2019/09/16/一、Dart语言和Flutter基础/1568625942.jpg">
      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Flutter/">Flutter</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/12/Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理/"
    >Android深入理解ActivityManagerService 02：ActivityTask和Activity栈管理</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/12/Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理/" class="article-date">
  <time datetime="2019-09-12T01:42:50.000Z" itemprop="datePublished">2019-09-12</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解ActivityManagerService/">深入理解ActivityManagerService</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="1-ActivityTask"><a href="#1-ActivityTask" class="headerlink" title="1. ActivityTask"></a>1. ActivityTask</h1><p><code>ActivityTask</code>是一个管理类，用来管理系统所有Activity的各种状态，其内部维护了<code>TaskRecord</code>的列表，因此从Activity任务栈这一角度来说，<code>ActivityTask</code>也可以理解为Activity堆栈。它由<code>ActivityStackSupervisor</code>来进行管理的，而<code>ActivityStackSupervisor</code>是在AMS中的构造方法中被创建。frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerService</span><span class="params">(Context systemContext)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    mStackSupervisor = <span class="keyword">new</span> ActivityStackSupervisor(<span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-1-ActivityStack的实例类型"><a href="#1-1-ActivityStack的实例类型" class="headerlink" title="1.1 ActivityStack的实例类型"></a>1.1 ActivityStack的实例类型</h2><p><code>ActivityStackSupervisor</code>中有多种<code>ActivityStack</code>实例，如下：frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityStackSupervisor</span> <span class="keyword">implements</span> <span class="title">DisplayListener</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ActivityStack mHomeStack;</span><br><span class="line">    ActivityStack mFocusedStack;</span><br><span class="line">    <span class="keyword">private</span> ActivityStack mLastFocusedStack;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>mHomeStack</code>用来存储Launcher App的所有Activity</li>
<li><code>mFocusedStack</code>表示当前正在接收输入或启动下一个Activity的所有Activity</li>
<li><code>mLastFocusedStack</code>表示当前接收输入的所有Activity</li>
</ul>
<p>通过<code>ActiviyStackSupervisor</code>提供了获取上述<code>ActivityStack</code>的方法，如，要获取<code>mFocusedStack</code>，就可以调用：frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ActivityStack <span class="title">getFocusedStack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mFocusedStack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="1-2-ActivityState"><a href="#1-2-ActivityState" class="headerlink" title="1.2 ActivityState"></a>1.2 ActivityState</h2><p><code>ActivityStack</code>中通过枚举存储了Activity的所有状态，如下：frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> ActivityState &#123;</span><br><span class="line">    INITIALIZING,</span><br><span class="line">    RESUMED,</span><br><span class="line">    PAUSING,</span><br><span class="line">    PAUSED,</span><br><span class="line">    STOPPING,</span><br><span class="line">    STOPPED,</span><br><span class="line">    FINISHING,</span><br><span class="line">    DESTROYING,</span><br><span class="line">    DESTROYED</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用<code>ActivityState</code>的场景会有很多，比如：frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">overridePendingTransition</span><span class="params">(IBinder token, String packageName, <span class="keyword">int</span> enterAnim, <span class="keyword">int</span> exitAnim)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (self.state == ActivityState.RESUMED || self.state == ActivityState.PAUSING) &#123; <span class="comment">// 1</span></span><br><span class="line">        mWindowManager.overridePendingAppTransition(packageName, enterAnim, exitAnim, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>overridePendingAppTransition()</code>用于设置Activity的切换动画，注释1，可以看到只有<code>ActivityState</code>为<code>RESUMED</code>状态或<code>PASUED</code>状态时，才会调用WMS类型的<code>mWindowManager</code>对象的<code>overridePendingAppTransition()</code>来进行切换动画。</p>
<h2 id="1-3-特殊状态的Activity"><a href="#1-3-特殊状态的Activity" class="headerlink" title="1.3 特殊状态的Activity"></a>1.3 特殊状态的Activity</h2><p>在<code>ActivityStack</code>中定义了一些特殊状态的Activity，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 正在暂停的Activity</span></span><br><span class="line">ActivityRecord mPausingActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上一个已经暂停的Activity</span></span><br><span class="line">ActivityRecord mLastPausedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最近一次没有历史记录的Activity</span></span><br><span class="line">ActivityRecord mLastNoHistoryActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 已经Resume的Activity</span></span><br><span class="line">ActivityRecord mResumedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最近一次启动的Activity</span></span><br><span class="line">ActivityRecord mLastStartedActivity = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传递给convertToTranslucent方法的最上层的Activity</span></span><br><span class="line">ActivityRecord mTranslucentActivityWaiting = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>

<p>这些特殊状态都是<code>ActivityRecord</code>类型的，<code>ActivityRecord</code>用来记录一个Activity的所有信息。从Activity任务栈的角度来说，一个或多个<code>ActivityRecord</code>会组成一个<code>TaskRecord</code>，<code>TaskRecors</code>用来记录Activity的栈，而<code>ActivityStack</code>包含了一个或多个<code>TaskRecord</code>。</p>
<img src="/2019/09/12/Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理/VeivrR.png">

<h2 id="1-4-维护的ArrayList"><a href="#1-4-维护的ArrayList" class="headerlink" title="1.4 维护的ArrayList"></a>1.4 维护的ArrayList</h2><p><code>ActivityStack</code>内部维护了多个<code>ArrayList</code>，主要用来存储<code>ActivityRecord</code>和<code>TaskRecord</code>，其中<code>TaskRecord</code>用来记录Activity的Task。</p>
<table>
<thead>
<tr>
<th align="center">ArrayList</th>
<th align="center">元素类型</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">mTaskHistory</td>
<td align="center">TaskRecord</td>
<td align="center">所有没有被销毁的Task</td>
</tr>
<tr>
<td align="center">mLRUActivvities</td>
<td align="center">ActivtiyRecord</td>
<td align="center">正在运行的Activity，列表中第一个条目是最近最少使用的元素</td>
</tr>
<tr>
<td align="center">mNoAnimActivities</td>
<td align="center">ActivityRecord</td>
<td align="center">不考虑转换动画的Activity</td>
</tr>
<tr>
<td align="center">mValidateAppTokens</td>
<td align="center">TaskGroup</td>
<td align="center">用于与窗口管理器验证应用令牌</td>
</tr>
</tbody></table>
<h1 id="2-Activity栈管理"><a href="#2-Activity栈管理" class="headerlink" title="2. Activity栈管理"></a>2. Activity栈管理</h1><p>Activity是由任务栈来进行管理的，有了栈管理，就可以对应用程序进行操作，应用可以复用自身应用中以及其他应用的Activity，节省资源。</p>
<p>比如，使用一个App，这个App的联系人详情界面提供了联系人的邮箱，当点击邮箱时会跳转到发送邮件的界面。</p>
<img src="/2019/09/12/Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理/VeiL24.png">

<p>App和系统Email中的Activity是处于不同程序进程的，而有了栈管理，就可以把发送邮件界面放到社交应用中详情界面所在栈的栈顶，来做到跨进程操作。</p>
<p>为了更灵活的进行栈管理，Android系统提供了很多配置，下面分别进行讨论。</p>
<h2 id="2-1-Launch-Mode"><a href="#2-1-Launch-Mode" class="headerlink" title="2.1 Launch Mode"></a>2.1 Launch Mode</h2><p>用于设定Activity的启动模式：</p>
<ul>
<li>standerd：默认模式，每次启动Activity都会创建一个新的Activity实例。</li>
<li>singleTop：如果要启动的Activity已经在栈顶，则不会重新创建Activity，同时该Activity的<code>onNewIntent()</code>方法会被调用。如果要启动Activity的不在栈顶，就会重新创建该Activity的实例。</li>
<li>singleTask：如果要启动的Activity已经存在栈中，就不会创建该Activity的实例，而是将栈中位于该Activity上的所有Activity出栈，同时该Activity的<code>onNewIntnent()</code>会被调用。如果要启动的Activity不存在在该栈中，则要先创建一个新栈，然后创建该Activity的实例，并入栈。</li>
<li>singleInstance：和singleTask类似，不同的是启动Activity时，首先要创建在一个新栈，然后创建该Activity实例并入栈，新栈中只会存在这一个Activity实例。</li>
</ul>
<h2 id="2-2-Intent的FLAG"><a href="#2-2-Intent的FLAG" class="headerlink" title="2.2 Intent的FLAG"></a>2.2 Intent的FLAG</h2><p><code>Intent</code>中定义了很多<code>FLAG</code>，其中有几个<code>FLAG</code>也可以设定Activity的启动方式，如果Launch Mode设定与<code>FLAG</code>设定的Activity的启动方式不同，则以<code>FLAG</code>设定的为准。</p>
<ul>
<li><code>FLAG_ACTIVITY_SINGLE_TOP</code>：与Launch Mode中的singleTop相同。</li>
<li><code>FLAG_ACTIVITY_NEW_TASK</code>：与Launch Mode中的singleTask相同。</li>
<li><code>FLAG_ACTIVITY_CLEAR_TOP</code>：Launch Mode中没有与之对应的模式，如果要启动Activity已经存在与栈中，则将所有位于它上面的Activity出栈。singleTop默认具有此标记位的效果。</li>
</ul>
<p>除了上面的三种<code>FLAG</code>，还有一些对分析栈管理有帮助的。</p>
<ul>
<li><code>FLAG_ACTIVITY_NO_HISTORY</code>：Activity一旦退出，就不会存在于栈中。同样的，也可以在<code>AndroidManifest.xml</code>中设置<code>&quot;android:noHistory&quot;</code>。</li>
<li><code>FLAG_ACTIVITY_MULTIPLE_TASK</code>：需要和<code>FLAG_ACTIVITY_NEW_TASK</code>共同使用才有效果，系统会启动一个新的栈来容纳新启动的Activity。</li>
<li><code>FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</code>：Activity不会被放入到“最近启动的Activity”列表中。</li>
<li><code>FLAG_ACTIVITY_BROUGHT_TO_FRONT</code>：这个标志位通常不是由应用程序中的代码设置的，而是由Launch Mode为singleTask时，系统自动添加上的。</li>
<li><code>FLAG_ACTIVITY_LAUNCHED_FROM_HISTORY</code>：这个标志位通常不是由应用程序中的代码设置的，而是从历史记录中启动的（长按HOME键调出）。</li>
<li><code>FLAG_ACTIVITY_CLEAR_TASK</code>：需要和<code>FLAG_ACTIVITY_NEW_TASK</code>共同使用才有效果，用于清除于启动的Activity相关的栈的所有其他Activity。</li>
</ul>
<p>下面通过源码查看<code>FLAG</code>的应用，在<a href="https://tylerliu.top/2019/09/02/Andorid深入理解四大组件-02%EF%BC%9A应用程序启动过程%EF%BC%88下%EF%BC%89/">Andorid深入理解四大组件 02：应用程序启动过程（下）</a>中讲过，根Activity启动时会调用AMS的<code>startActivity()</code>，经过层层调用，最终会调用<code>ActivityServer</code>的<code>startActivityUnchecked()</code>，如下时序图：</p>
<img src="/2019/09/12/Android深入理解ActivityManagerService-02：ActivityTask和Activity栈管理/VeiOxJ.png">

<p>frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    setInitialState(r, options, inTask, doResume, startFlags, sourceRecord, voiceSession, voiceInteractor); <span class="comment">// 1</span></span><br><span class="line">    computeLaunchingTaskFlags(); <span class="comment">// 2</span></span><br><span class="line">    computeSourceStack();</span><br><span class="line">    mIntent.setFlags(mLaunchFlags); <span class="comment">// 3</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，初始化启动Activity的各种配置，在初始化前会重置各种配置再进行配置，这些配置包括：<code>ActivityRecord</code>、<code>Intent</code>、<code>TaskReccord</code>和<code>LaunchFlags</code>（启动的<code>FLAG</code>）等。</p>
<p>注释2，用于计算出启动的<code>FLAG</code>，并将其赋值给<code>mLaunchFlags</code>。</p>
<p>注释3，将<code>mLaunchFlags</code>设置给<code>Intent</code>，达到设定Activity启动方式的目的。</p>
<p>再来看<code>computeLaunchingTaskFlags()</code>：frameworks/base/services/core/java/com/android/server/am/ActivityStarter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">computeLaunchingTaskFlags</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (mInTask == <span class="keyword">null</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (mSourceRecord == <span class="keyword">null</span>) &#123; <span class="comment">// 2</span></span><br><span class="line">            <span class="keyword">if</span> ((mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span> &amp;&amp; mInTask == <span class="keyword">null</span>) &#123; <span class="comment">// 3</span></span><br><span class="line">                Slog.w(TAG, <span class="string">"startActivity called from non-Activity context; forcing "</span> + <span class="string">"Intent.FLAG_ACTIVITY_NEW_TASK for: "</span> + mIntent);</span><br><span class="line">                mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mSourceRecord.launchMode == LAUNCH_SINGLE_INSTANCE) &#123; <span class="comment">// 4</span></span><br><span class="line">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLaunchSingleInstance || mLaunchSingleTask) &#123; <span class="comment">// 5</span></span><br><span class="line">            mLaunchFlags |= FLAG_ACTIVITY_NEW_TASK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算启动的<code>FLAG</code>逻辑比较复杂，这里截取了部分代码。</p>
<p>注释1，<code>TaskRecord</code>类型的<code>mInTask</code>为空时，说明Activity要加入的栈不存在。这段代码就是要解决Activity要加入的栈不存在时，如何计算出启动的<code>FLAG</code>的问题。</p>
<p>注释2，<code>ActivityRecord</code>类型的<code>mSourceRecord</code>是用于描述“初始Activity”的。比如ActivityA启动了ActivityB，ActivityA就是“初始Activity”。</p>
<p>同时满足了注释1和2的条件时，就需要创建一个新的栈。</p>
<p>注释4，如果“初始Activity”所在的栈只允许有一个Activity实例，则也需要创建一个新栈。</p>
<p>注释5，如果Launch Mode设置了singleTask或singleInstance，则也需要创建一个新栈。</p>
<h2 id="2-3-taskAffinity"><a href="#2-3-taskAffinity" class="headerlink" title="2.3 taskAffinity"></a>2.3 taskAffinity</h2><p>可以在<code>AndoridManifest.xml</code>中设置<code>&quot;android:taskAffinity&quot;</code>，用来指定Activity希望归属的栈，默认，同一个应用程序的所有Activity都有着相同的<code>taskAffinity</code>。</p>
<p><code>taskAffinity</code>会在下面两种情况产生效果：</p>
<ol>
<li><code>taskAffinity</code>与<code>FLAG_ACTIVITY_NEW_TASK</code>或者singleTask配合。如果新启动Activity的<code>taskAffinity</code>与栈的<code>taskAffiniy</code>相同（栈的<code>taskAffinity</code>取决于根Activity的<code>taskAffinity</code>），则加入到该栈中。如果不相同，就会创建新栈。</li>
<li><code>taskAffinity</code>与<code>allowTaskReparenting</code>配合。如果<code>allowTaskReparenting</code>为<code>true</code>，说明Activity具有转移的能力。用之前的邮件为例，当App启动了发送邮件的Activity，此时发送邮件的Activity和App应用处于同一个栈中。如果发送邮件的Activity的<code>allowTaskReparenting</code>设为<code>false</code>，此后邮件程序所在的栈就位于前台，这时发送邮件的Activity就会由App的栈中转移到与它更关系密切的邮件程序（<code>taskAffinity</code>相同）所在的栈中。</li>
</ol>
<p>接着通过源码查看<code>taskAffinity</code>的应用。<code>ActivityStackSupervisor</code>的<code>findTaskLocked</code>方法用于找到Activity最匹配的栈，最终会调用<code>ActivityTask</code>的<code>findTaskLocked()</code>：frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">findTaskLocked</span><span class="params">(ActivityRecord target, FindTaskResult result)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;<span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">final</span> TaskRecord task = mTaskHistory.get(taskNdx);<span class="comment">// 2</span></span><br><span class="line">        ......</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isDocument &amp;&amp; !taskIsDocument &amp;&amp; result.r == <span class="keyword">null</span> &amp;&amp; task.canMatchRootAffinity()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (task.rootAffinity.equals(target.taskAffinity)) &#123; <span class="comment">// 3</span></span><br><span class="line">                ......</span><br><span class="line">                result.r = r;</span><br><span class="line">                result.matchedByRootAffinity = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (DEBUG_TASKS) Slog.d(TAG_TASKS, <span class="string">"Not a match: "</span> + task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，遍历<code>mTaskHistory</code>列表，列表的元素为<code>TaskRecord</code>，用于存储没有被销毁的Task。</p>
<p>注释2，得到某个Task的信息。</p>
<p>注释3，将Task的<code>rootAffinity</code>（初始的<code>taskAffinity</code>）和目标Activity的<code>taskAffinity</code>做对比，如果相同，则将<code>FindTaskResult</code>的<code>matchedByRootAffinity</code>属性设置为<code>true</code>，说明找到了匹配的<code>Task</code>。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ActivityManagerService/">ActivityManagerService</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解ActivityManagerService-01：AMS启动流程和相关类" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/10/Android深入理解ActivityManagerService-01：AMS启动流程和相关类/"
    >Android深入理解ActivityManagerService 01：AMS启动流程和相关类</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/10/Android深入理解ActivityManagerService-01：AMS启动流程和相关类/" class="article-date">
  <time datetime="2019-09-10T08:08:38.000Z" itemprop="datePublished">2019-09-10</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解ActivityManagerService/">深入理解ActivityManagerService</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>AMS是系统的引导服务，应用程序进程的启动、切换和调度、四大组件的启动和管理都需要AMS的支持。当然，并不是AMS一个类去完成这些，还有一些其他关联的类共同完成，后面会讲到。本文主要涉及以下要点：</p>
<ul>
<li>AMS的启动流程</li>
<li>AMS与进程的启动</li>
<li>AMS相关（关联）的类</li>
</ul>
<h1 id="2-AMS的启动流程"><a href="#2-AMS的启动流程" class="headerlink" title="2. AMS的启动流程"></a>2. AMS的启动流程</h1><p>AMS的启动是在SystemServer进程中启动的，在<a href="https://tylerliu.top/2019/08/27/Android系统启动流程03%EF%BC%9ASystemServer进程/">Android系统启动流程 03：SystemServer进程</a>中提过，这里从SystemServer进程的<code>main()</code>开始讲起：frameworks/base/services/java/com/android/server/SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SystemServer().run();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>main()</code>调用了<code>SystemServer</code>的<code>run()</code>：frameworks/base/services/java/com/android/server/SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        System.loadLibrary(<span class="string">"android_servers"</span>); <span class="comment">// 1</span></span><br><span class="line">    ......</span><br><span class="line">        mSystemServiceManager = <span class="keyword">new</span> SystemServiceManager(mSystemContext); <span class="comment">// 2</span></span><br><span class="line">        LocalServices.addService(SystemServiceManager.class, mSystemServiceManager);</span><br><span class="line">    ......  </span><br><span class="line">     <span class="keyword">try</span> &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_SYSTEM_SERVER, <span class="string">"StartServices"</span>);</span><br><span class="line">        startBootstrapServices(); <span class="comment">// 3</span></span><br><span class="line">        startCoreServices(); <span class="comment">// 4</span></span><br><span class="line">        startOtherServices(); <span class="comment">// 5</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，加载动态库<code>&quot;android_servers.so&quot;</code>。</p>
<p>注释2，创建<code>SystemServerManager</code>，它会对系统的服务进行创建、启动和生命周期管理。</p>
<p>注释3，<code>startBootstrapServices()</code>中，用<code>SystemServiceManager</code>启动了<code>ActivityManagerService</code>、<code>PowerManagerService</code>、<code>PackageManagerService</code>等服务。</p>
<p>注释4，<code>startCoreServices()</code>中，启动了<code>BatteryService</code>、<code>UsageStatsService</code>、和<code>WebViewUpdateSeervice</code>。</p>
<p>注释5，<code>startOtherServices()</code>中，启动了<code>CameraService</code>、<code>AlarmManagerService</code>、<code>VrManagerService</code>等服务。</p>
<p>这些服务的父类均为<code>SystemService</code>。从注释3、4、5可以看出，系统将服务分成三类，引导服务、核心服务和其他服务，其他服务是一些不紧要的和一些不需要立即启动的服务。系统服务总共有80多个，这里主要看看引导服务中的AMS是如何启动的，注释3的<code>startBootstrapServices()</code>：frameworks/base/services/java/com/android/server/SystemServer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startBootstrapServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Installer installer = mSystemServiceManager.startService(Installer.class);</span><br><span class="line">    <span class="comment">// Activity manager runs the show.</span></span><br><span class="line">    mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService(); <span class="comment">// 1</span></span><br><span class="line">    mActivityManagerService.setSystemServiceManager(mSystemServiceManager);</span><br><span class="line">    mActivityManagerService.setInstaller(installer);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，调用了<code>SystemServiceManager</code>的<code>startService()</code>，方法的参数是<code>ActivityManagerService.Lifecycle.class</code>：frameworks/base/services/core/java/com/android/server/SystemServiceManager.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">public</span> &lt;T extends SystemService&gt; <span class="function">T <span class="title">startService</span><span class="params">(Class&lt;T&gt; serviceClass)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> T service;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class); <span class="comment">// 1</span></span><br><span class="line">        service = constructor.newInstance(mContext); <span class="comment">// 2</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException ex) &#123;</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Register it.</span></span><br><span class="line">        mServices.add(service); <span class="comment">// 3</span></span><br><span class="line">        <span class="comment">// Start it.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            service.onStart(); <span class="comment">// 4</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failed to start service "</span> + name + <span class="string">": onStart threw an exception"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> service;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_SYSTEM_SERVER);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>startService()</code>传入的参数是<code>Lifecycle.class</code>，<code>Lifecycle</code>继承自<code>SystemService</code>。首先，通过反射来创建<code>Lifecycle</code>实例，注释1得到传进来的<code>Lifecycle</code>的构造器<code>Constructor</code>，在注释2调用<code>Constructor</code>的<code>newInstance()</code>来创建<code>Lifecycle</code>类型的<code>service</code>对象。</p>
<p>注释3，将刚创建的<code>service</code>添加到<code>ArrayList</code>类型的<code>mService</code>中来完成注册。</p>
<p>注释4，调用<code>onStart()</code>启动<code>service</code>，并返回该<code>service</code>。<code>Lifecycle</code>是AMS的内部类：frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Lifecycle</span> <span class="keyword">extends</span> <span class="title">SystemService</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Lifecycle</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        mService = <span class="keyword">new</span> ActivityManagerService(context); <span class="comment">// 1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mService.start(); <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActivityManagerService <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mService; <span class="comment">// 3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码结合<code>SystemServiceManager</code>的<code>startService()</code>来分析，当通过反射来创建<code>Lifecycle</code>实例时，会调用注释1的方法创建ASM实例，当调用<code>Lifecycle</code>类型的<code>service</code>的<code>onStart()</code>时，实际上调用的是注释2处AMS的<code>start()</code>。在<code>SystemServer</code>的<code>startBootstrapService()</code>的注释1处，调用了如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mActivityManagerService = mSystemServiceManager.startService(ActivityManagerService.Lifecycle.class).getService();</span><br></pre></td></tr></table></figure>

<p><code>SystemServiceManager</code>的<code>startService()</code>最终会返回<code>Lifecycle</code>类型的对象，接着又调用<code>Lifecycle</code>的<code>getService()</code>，这个方法会返回AMS类型的<code>mService</code>对象，见注释3，这样AMS实例就会被创建并返回。</p>
<h1 id="3-AMS与进程启动"><a href="#3-AMS与进程启动" class="headerlink" title="3. AMS与进程启动"></a>3. AMS与进程启动</h1><p>在<a href="https://tylerliu.top/2019/08/27/Android系统启动流程02%EF%BC%9Azygote进程/">Android系统启动流程 02：zygote进程</a>中，在Zygote的Java框架层中，会创建一个Server端的Socket，这个Socket用来等待AMS请求Zygote来创建新的应用程序进程。要启动一个应用程序，首先要保证这个应用程序所需要的应用程序进程已经被启动。AMS在启动应用程序时，会检查这个应用程序需要的应用程序进程是否存在，不存在就会请求Zygote进程将需要的应用程序进程启动。Service的启动过程中会调用<code>ActiveService</code>的<code>bringUpServiceLocked()</code>：frameworks/base/services/core/java/com/android/server/am/ActiveServices.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">bringUpServiceLocked</span><span class="params">(ServiceRecord r, <span class="keyword">int</span> intentFlags, <span class="keyword">boolean</span> execInFg, <span class="keyword">boolean</span> whileRestarting, <span class="keyword">boolean</span> permissionsReviewRequired)</span> <span class="keyword">throws</span> TransactionTooLargeException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">final</span> String procName = r.processName; <span class="comment">// 1</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">if</span> (!isolated) &#123;</span><br><span class="line">        app = mAm.getProcessRecordLocked(procName, r.appInfo.uid, <span class="keyword">false</span>); <span class="comment">// 2</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123; <span class="comment">// 3</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                app.addPackage(r.appInfo.packageName, r.appInfo.versionCode, mAm.mProcessStats);</span><br><span class="line">                realStartServiceLocked(r, app, execInFg); <span class="comment">// 4</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125; </span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = r.isolatedProc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (app == <span class="keyword">null</span> &amp;&amp; !permissionsReviewRequired) &#123; <span class="comment">// 5</span></span><br><span class="line">        <span class="keyword">if</span> ((app=mAm.startProcessLocked(procName, r.appInfo, <span class="keyword">true</span>, intentFlags, <span class="string">"service"</span>, r.name, <span class="keyword">false</span>, isolated, <span class="keyword">false</span>)) == <span class="keyword">null</span>) &#123; <span class="comment">// 6</span></span><br><span class="line">           ......</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isolated) &#123;</span><br><span class="line">            r.isolatedProc = app;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，得到<code>ServiceRecorder</code>的<code>processName</code>，并赋值给<code>procName</code>，其中<code>ServiceRecorder</code>是用来描述<code>Service</code>的<code>andorid:process</code>属性。</p>
<p>注释2，将<code>procName</code>和<code>Service</code>的<code>uid</code>传入到AMS的<code>getProcessRecorderLocked()</code>中，来查询是否存在一个<code>Service</code>对应的<code>ProcessRecorder</code>类型的对象<code>app</code>，<code>ProcessRecorder</code>主要用来记录运行的应用程序进程的信息。</p>
<p>注释5，判断<code>Service</code>对应的<code>app</code>为空，则说明来运行<code>Service</code>的应用程序进程不存在，则调用注释6的<code>startProcessLocked()</code>来创建对应的应用程序进程，具体可以查看<a href="https://tylerliu.top/2019/08/30/Android应用程序进程启动过程01/">Android应用程序进程启动过程 01</a>。</p>
<h1 id="4-与AMS相关的类"><a href="#4-与AMS相关的类" class="headerlink" title="4. 与AMS相关的类"></a>4. 与AMS相关的类</h1><p><code>ActivityManager</code>是一个和AMS相关联的类，它主要对运行中的Activity进行管理，这些管理工作并不是由<code>ActivitManager</code>来处理的，而是交由AMS来处理，<code>ActivityManager</code>中的方法会通过<code>ActivityManagerNative</code>（后面简称AMN）的<code>getDefaule()</code>来得到<code>ActivityManagerProxy</code>（后面简称AMP），通过AMP就可以和AMN进行通信，而AMN是一个抽象类，它会将功能交给它的子类AMS来处理，因此，AMP是AMS的代理类。AMS作为系统核心服务，很多API不能直接暴露给<code>ActivityManager</code>的，例如Activity的启动过程中会调用<code>Instrumentation</code>的<code>execStartActivity()</code>：frameworks/base/core/java/android/app/Instrumentation.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault().startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>, requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>execStartActivity()</code>中会调用AMN的<code>getDefault()</code>来获取AMS的代理类AMP。接着调用AMP的<code>startActivity()</code>，先来看AMN的<code>getDefault()</code>：frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> gDefault.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>); <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</span><br><span class="line">        &#125;</span><br><span class="line">        IActivityManager am = asInterface(b); <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> am;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注释1，得到名为<code>&quot;activity&quot;</code>的Service引用，也就是Binder类型的AMS的引用。</p>
<p>注释2，将它封装成AMP类型对象，并将它保存到<code>gDefault</code>中，此后调用AMN的<code>getDefault()</code>就会直接获得AMS的代理对象AMP。注释2的<code>asInterface()</code>：frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IActivityManager in = (IActivityManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">    <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ActivityManagerProxy(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要作用是将IBinder类型的AMS引用封装成AMP，AMP的构造方法如下：frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>AMP的构造方法中将AMS的引用赋值给了变量<code>mRemote</code>，这样在AMP中就可以使用AMS了。其中<code>IActivityManager</code>是一个接口，AMN和AMP都实现了这个接口，用于实现代理模式和Binder通信。</p>
<p>再回到<code>Instrumentation</code>的<code>execStartActivity()</code>，查看AMP的<code>startActivity()</code>，AMP是AMN的内部类：frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    data.writeInt(requestCode);</span><br><span class="line">    data.writeInt(startFlags);</span><br><span class="line">    ......</span><br><span class="line">    mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>); <span class="comment">// 1</span></span><br><span class="line">    reply.readException();+</span><br><span class="line">    <span class="keyword">int</span> result = reply.readInt();</span><br><span class="line">    reply.recycle();</span><br><span class="line">    data.recycle();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先会将传入的参数写入到<code>Parce</code>类型的<code>data</code>中。</p>
<p>注释1，通过<code>IBinder</code>类型对象<code>mRemote</code>（AMS的引用）向服务端的AMS发送一个<code>START_ACTIVITY_TRANSACTION</code>类型的进程间通信请求。那么服务端AMS就会从Binder线程池中读取客户端发送来的数据，最终会调用AMN的<code>onTransact()</code>：frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</span><br><span class="line">    &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</span><br><span class="line">        reply.writeNoException();</span><br><span class="line">        reply.writeInt(result);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onTransact()</code>中会调用AMS的<code>startActivity()</code>：frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>startActivity()</code>的最后会<code>return</code>了<code>starttActivityAsUser()</code>：frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法中最后<code>return</code>了<code>startActivityMayWait()</code>，这里不再详细介绍，具体可以查看<a href="https://tylerliu.top/2019/09/02/Andorid深入理解四大组件-02%EF%BC%9A应用程序启动过程%EF%BC%88下%EF%BC%89/">Andorid深入理解四大组件 02：应用程序启动过程（下）</a>。</p>
<p>在Activity中启动过程中提到了AMP、AMN和AMS，如下所示：</p>
<img src="/2019/09/10/Android深入理解ActivityManagerService-01：AMS启动流程和相关类/VeigPS.png">

<p>AMP是AMN的内部类，它们都实现了<code>IActivityManager</code>接口，这样它们就实现了代理模式，具体来讲是远程代理：AMP和AMN的运行在两个进程，AMP是Client端，AMN是Server端，Server端具体的功能都是由AMN的子类AMS来实现，因此，AMP是AMS在Client端的一个代理类。AMN又实现了<code>Binder</code>，这样AMP和AMS就可以通过<code>Binder</code>来进行进程间通信。</p>
<p><code>ActivityManager</code>通过AMN的<code>getDefault()</code>得到AMP，通过AMP就可以和AMN进行通信，也就间接的与AMS进行通信。除了<code>ActiviyManager</code>，其他要想与AMS进行通信的类都需要通过AMP。</p>
<img src="/2019/09/10/Android深入理解ActivityManagerService-01：AMS启动流程和相关类/Vei658.png">
      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ActivityManagerService/">ActivityManagerService</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解JNI-02：类型转换、方法签名和JNIEnv" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/10/Android深入理解JNI-02：类型转换、方法签名和JNIEnv/"
    >Android深入理解JNI 02：类型转换、方法签名和JNIEnv</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/10/Android深入理解JNI-02：类型转换、方法签名和JNIEnv/" class="article-date">
  <time datetime="2019-09-10T05:35:32.000Z" itemprop="datePublished">2019-09-10</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解JNI/">深入理解JNI</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="1-数据类型的转换"><a href="#1-数据类型的转换" class="headerlink" title="1. 数据类型的转换"></a>1. 数据类型的转换</h1><p>首先看看上篇文章中andorid_media_MediaRecorder.cpp中的<code>android_media_MediaRecorder_staret()</code>：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static void android_media_MediaRecorder_start(JNIEnv *env, jobject thiz) &#123;</span><br><span class="line">    ALOGV(&quot;start&quot;);</span><br><span class="line">    sp&lt;MediaRecorder&gt; mr = getMediaRecorder(env, thiz);</span><br><span class="line">    process_media_recorder_call(env, mr-&gt;start(), &quot;java/lang/RuntimeException&quot;, &quot;start failed.&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>里面有一个参数是<code>Object</code>类型，它是JNI层的数据类型，Java的数据类型到了JNI层就需要转换为JNI层的数据类型。Java的数据类型分为基本数据类型和引用数据类型，JNI层对于这两种类型也做了区分，先来看看基本数据类型的转换。</p>
<h2 id="1-1-基本数据类型的转换"><a href="#1-1-基本数据类型的转换" class="headerlink" title="1.1 基本数据类型的转换"></a>1.1 基本数据类型的转换</h2><table>
<thead>
<tr>
<th align="center">Java</th>
<th align="center">Native</th>
<th align="center">Signature（签名格式）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">byte</td>
<td align="center">jbyte</td>
<td align="center">B</td>
</tr>
<tr>
<td align="center">char</td>
<td align="center">jchar</td>
<td align="center">C</td>
</tr>
<tr>
<td align="center">double</td>
<td align="center">jdouble</td>
<td align="center">D</td>
</tr>
<tr>
<td align="center">float</td>
<td align="center">jfloat</td>
<td align="center">F</td>
</tr>
<tr>
<td align="center">int</td>
<td align="center">jint</td>
<td align="center">I</td>
</tr>
<tr>
<td align="center">short</td>
<td align="center">jshort</td>
<td align="center">S</td>
</tr>
<tr>
<td align="center">long</td>
<td align="center">jlong</td>
<td align="center">J</td>
</tr>
<tr>
<td align="center">boolean</td>
<td align="center">jboolean</td>
<td align="center">Z</td>
</tr>
<tr>
<td align="center">void</td>
<td align="center">void</td>
<td align="center">V</td>
</tr>
</tbody></table>
<h2 id="1-2-引用数据类型的转换"><a href="#1-2-引用数据类型的转换" class="headerlink" title="1.2 引用数据类型的转换"></a>1.2 引用数据类型的转换</h2><table>
<thead>
<tr>
<th align="center">Java</th>
<th align="center">Native</th>
<th align="center">Signature（签名格式）</th>
</tr>
</thead>
<tbody><tr>
<td align="center">所有对象</td>
<td align="center">jobject</td>
<td align="center">L+classname+;</td>
</tr>
<tr>
<td align="center">Class</td>
<td align="center">jclass</td>
<td align="center">Ljava/lang/Class;</td>
</tr>
<tr>
<td align="center">String</td>
<td align="center">jstring</td>
<td align="center">Ljava/lang/String;</td>
</tr>
<tr>
<td align="center">Throwable</td>
<td align="center">jthrowable</td>
<td align="center">Ljava/lang/Throwable;</td>
</tr>
<tr>
<td align="center">Object[]</td>
<td align="center">jobjectArray</td>
<td align="center">[L+Classname+;</td>
</tr>
<tr>
<td align="center">byte[]</td>
<td align="center">jbyteArray</td>
<td align="center">[B</td>
</tr>
<tr>
<td align="center">char[]</td>
<td align="center">jcharArray</td>
<td align="center">[C</td>
</tr>
<tr>
<td align="center">double[]</td>
<td align="center">jdoubleArray</td>
<td align="center">[D</td>
</tr>
<tr>
<td align="center">float[]</td>
<td align="center">jfloatArray</td>
<td align="center">[F</td>
</tr>
<tr>
<td align="center">int[]</td>
<td align="center">jintArray</td>
<td align="center">[I</td>
</tr>
<tr>
<td align="center">short[]</td>
<td align="center">jshortArray</td>
<td align="center">[S</td>
</tr>
<tr>
<td align="center">long[]</td>
<td align="center">jlongArray</td>
<td align="center">[J</td>
</tr>
<tr>
<td align="center">boolean[]</td>
<td align="center">jbooleanArray</td>
<td align="center">[Z</td>
</tr>
</tbody></table>
<p>引用数据类型还具有继承关系：</p>
<img src="/2019/09/10/Android深入理解JNI-02：类型转换、方法签名和JNIEnv/VmCKhD.jpg">

<p>再来例举<code>MediaRecorder</code>框架的Java方法：frameworks/base/media/java/android/media/MediaRecorder.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">_setOutputFile</span><span class="params">(FileDescriptor fd, <span class="keyword">long</span> offset, <span class="keyword">long</span> length)</span> <span class="keyword">throws</span> IllegalStateException, IOException</span></span><br></pre></td></tr></table></figure>

<p><code>_setOutputFile()</code>方法对应的JNI层的方法为：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_setOutputFileFD</span><span class="params">(JNIEnv *env, jobject thiz, jobject fileDescriptor, jlong offset, jlong length)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比这两个方法可以看到，<code>FileDescriptor</code>转成了<code>jobject</code>类型，<code>long</code>转成了<code>jlong</code>类型。</p>
<h1 id="2-方法签名"><a href="#2-方法签名" class="headerlink" title="2. 方法签名"></a>2. 方法签名</h1><p>前面已经列举了数据类型的签名格式，方法签名就是由签名格式组成的，方法签名有什么作用呢？</p>
<p>frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    ......</span><br><span class="line">    &#123;<span class="string">"native_init"</span>,       <span class="string">"()V"</span>,        (<span class="keyword">void</span> *)android_media_MediaRecorder_native_init&#125;,</span><br><span class="line">    &#123;<span class="string">"native_setup"</span>,      <span class="string">"(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/String;)V"</span>,</span><br><span class="line">    (<span class="keyword">void</span> *)android_media_MediaRecorder_native_setup&#125;,</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>gMethods[]</code>数组中存储的是<code>MediaRecorder</code>的Native方法与JNI层方法的对应关系，其中<code>&quot;()V&quot;</code>和<code>&quot;(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/String;)V&quot;</code>就是方法签名。Java有重载方法，可以定义方法名相同，参数不同的方法，因此，在JNI中仅仅通过方法名是为u发找到对应Java的具体方法的，JNI为了解决这一问题，就将参数类型和返回值类型组合在一起作为方法签名。通过方法签名和方法名就可以找到对应的Java方法了。</p>
<p>JNI方法签名的格式为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(参数签名格式...)返回值签名格式</span><br></pre></td></tr></table></figure>

<p>拿上面的<code>gMethods()</code>数组的<code>native_setup()</code>为例，在Java中的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">native_setup</span><span class="params">(Object mediarecorder_this, String clientName, String opPackageName)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>

<p>它在JNI中的方法签名为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Ljava/lang/Object;Ljava/lang/String;Ljava/lang/String;)V&quot;</span><br></pre></td></tr></table></figure>

<p>参照前面的类型转换表格，<code>native_setup()</code>方法的第一个参数的签名为<code>&quot;Ljava/lang/Obnject;&quot;</code>，后面两个参数签名为<code>&quot;Ljava/lang/String;&quot;</code>，返回值的类型<code>Void</code>的签名为<code>&quot;V&quot;</code>，组合起来就是上面的签名了。</p>
<p>Java提供了<code>javap</code>命令来自动生成方法签名。</p>
<p>先写一个简单的<code>MediaRecorder.java</code>包含上面的<code>native_sertup()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaRecorder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"media_jni"</span>);</span><br><span class="line">        native_init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">native_init</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">native_setup</span><span class="params">(Object mediarecorder_this, String clientName, String opPackageName)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该文件的绝对路径为E:\Project\MyStudy\JNISample\media\src\main\java\com\example\MediaRecorder.java，接着执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac E:\Project\MyStudy\JNISample\media\src\main\java\com\example\MediaRecorder.java</span><br></pre></td></tr></table></figure>

<p>执行后会生成MediaRecorder.class文件，然后执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -s -p E:\Project\MyStudy\JNISample\media\src\main\java\com\example\MediaRecorder.class</span><br></pre></td></tr></table></figure>

<p>其中<code>s</code>表示输出内部类型签名，<code>p</code>表示打印出所有的方法和成员（默认打印public成员），最终打印如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\AHXIUWU_RJ_LY&gt;javap -s -p E:\Project\MyStudy\JNISample\media\src\main\java\com\example\MediaRecorder.class</span><br><span class="line">Compiled from &quot;MediaRecorder.java&quot;</span><br><span class="line">public class com.example.MediaRecorder &#123;</span><br><span class="line">  public com.example.MediaRecorder();</span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">  private static final native void native_init();</span><br><span class="line">    descriptor: ()V</span><br><span class="line"></span><br><span class="line">  private final native void native_setup(java.lang.Object, java.lang.String, java.lang.String) throws java.lang.IllegalStateException;</span><br><span class="line">    descriptor: (Ljava/lang/Object;Ljava/lang/String;Ljava/lang/String;)V</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到输出的<code>native_setup</code>方法的签名和前面给出的一致。</p>
<h1 id="3-JNIEnv"><a href="#3-JNIEnv" class="headerlink" title="3. JNIEnv"></a>3. JNIEnv</h1><p>JNIEnv是一个指向全部JNI方法的指针，该指针只在创建它的线程有效，不能跨线程传递，因此，不同线程的JNIEnv是独立的，JNIEnv的主要作用：</p>
<ol>
<li>调用Java方法。</li>
<li>操作Java（获取Java中的对象和变量等）。</li>
</ol>
<p>先看看JNIEnv的定义：libnativehelper/include/nativehelper/jni.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> _JNIEnv JNIEnv; <span class="comment">// C++中JNIEnv的类型</span></span><br><span class="line"><span class="keyword">typedef</span> _JavaVM JavaVM; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNINativeInterface</span>* <span class="title">JNIEnv</span>;</span> <span class="comment">// C中JNIEnv的类型</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">JNIInvokeInterface</span>* <span class="title">JavaVM</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>这里使用预定义宏<code>__cplusplus</code>来区分C和C++两种代码，如果定义了<code>__cplusplus</code>，则是C++代码中的定义，否则就是C代码中的定义。</p>
<p>在这里也看到了<code>JavaVM</code>，它是虚拟机在JNI层中的代表，在一个虚拟机进程中只有一个JavaVM，因此，该进程的所有线程都可以使用这个JavaVM。通过JavaVM的<code>AttachCurrentThread</code>函数可以获取这个线程的JNIEnv，这样就可以在不同的线程中调用Java方法了。要注意在使用<code>AttachCurrentThread</code>函数的线程推出前，使用<code>DetachCurrentThread</code>函数来释放资源。</p>
<h2 id="3-1-jfieldID和jmethodID"><a href="#3-1-jfieldID和jmethodID" class="headerlink" title="3.1 jfieldID和jmethodID"></a>3.1 jfieldID和jmethodID</h2><p>在JNI中使用<code>jfieldID</code>和<code>jmethodID</code>来代表Java类中的成员变量和方法，可以通过JNIEnv的下面两个方法来分别得到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jfieldID  <span class="title">GetFieldID</span><span class="params">(jclass clazz,<span class="keyword">const</span> <span class="keyword">char</span> *name,<span class="keyword">const</span> <span class="keyword">char</span> *sig)</span></span>;</span><br><span class="line"><span class="function">jmethodID  <span class="title">GetFieldID</span><span class="params">(jclass clazz,<span class="keyword">const</span> <span class="keyword">char</span> *name,<span class="keyword">const</span> <span class="keyword">char</span> *sig)</span></span>;</span><br></pre></td></tr></table></figure>

<p>其中，<code>jclass</code>代表Java类，<code>name</code>代表成员方法或成员变量的名字，<code>sig</code>为这个方法和变量的签名。再来查看<code>MediaRecorder</code>框架的JNI层是如何使用上述两个方法的：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_native_init</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"android/media/MediaRecorder"</span>); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fields.context = env-&gt;GetFieldID(clazz, <span class="string">"mNativeContext"</span>, <span class="string">"J"</span>); <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">if</span> (fields.context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fields.surface = env-&gt;GetFieldID(clazz, <span class="string">"mSurface"</span>, <span class="string">"Landroid/view/Surface;"</span>); <span class="comment">// 3</span></span><br><span class="line">    <span class="keyword">if</span> (fields.surface == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    jclass surface = env-&gt;FindClass(<span class="string">"android/view/Surface"</span>);</span><br><span class="line">    <span class="keyword">if</span> (surface == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fields.post_event = env-&gt;GetStaticMethodID(clazz, <span class="string">"postEventFromNative"</span>, <span class="string">"(Ljava/lang/Object;IIILjava/lang/Object;)V"</span>); <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">if</span> (fields.post_event == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，通过<code>FindClass</code>来找到Java层的<code>MediaRecorder</code>的Class对象，并赋值给jclass类型的变量<code>clazz</code>，因此，<code>clazz</code>是Java层的<code>MediaRecorder</code>在JNI层的代表。</p>
<p>注释2和注释3，用来找到Java层的<code>MediaRecorder</code>中名为<code>mNativeContext</code>和<code>Surface</code>的成员变量，并分别赋值给<code>context</code>和<code>surface</code>。</p>
<p>注释4，获取Java层的<code>MediaRecorder</code>中名为<code>postEventFromNative()</code>的静态方法，并赋值给<code>post_event</code>。其中<code>fields</code>的定义为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fields_t</span> &#123;</span></span><br><span class="line">    jfieldID    context;</span><br><span class="line">    jfieldID    surface;</span><br><span class="line">    jmethodID   post_event;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">fields_t</span> fields;</span><br></pre></td></tr></table></figure>

<p>这些成员变量和方法赋值给<code>jfieldID</code>和<code>jmethodID</code>类型的变量，主要是为了效率考虑，如果每次调用相关方法都要进行查询方法和变量，显然效率会很低，因此在<code>MediaRecorder</code>框架JNI层的初始化方法<code>andorid_media_MediaRecorder_native_init()</code>中，将这些<code>jfieldID</code>和<code>jmethodID</code>类型的变量保存起来，以供后面使用。</p>
<h2 id="3-2-使用jfieldID和jmethodID"><a href="#3-2-使用jfieldID和jmethodID" class="headerlink" title="3.2 使用jfieldID和jmethodID"></a>3.2 使用jfieldID和jmethodID</h2><p>前面保存了<code>jfieldID</code>和<code>jmethodID</code>的变量，下面如何使用呢？frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> JNIMediaRecorderListener::notify(<span class="keyword">int</span> msg, <span class="keyword">int</span> ext1, <span class="keyword">int</span> ext2) &#123;</span><br><span class="line">    ALOGV(<span class="string">"JNIMediaRecorderListener::notify"</span>);</span><br><span class="line">    JNIEnv *env = AndroidRuntime::getJNIEnv();</span><br><span class="line">    env-&gt;CallStaticVoidMethod(mClass, fields.post_event, mObject, msg, ext1, ext2, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在里面调用了JNIEnv的<code>CallStaticVoidMethod()</code>，其中传入了<code>fields.post_event</code>，从上面可以得知，它其实是保存了Java层的<code>MediaRecorder</code>的静态方法<code>postEventFromNative()</code>：frameworks/base/media/java/android/media/MediaRecorder.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">postEventFromNative</span><span class="params">(Object mediarecorder_ref, <span class="keyword">int</span> what, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, Object obj)</span> </span>&#123;</span><br><span class="line">    MediaRecorder mr = (MediaRecorder)((WeakReference)mediarecorder_ref).get();</span><br><span class="line">    <span class="keyword">if</span> (mr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mr.mEventHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Message m = mr.mEventHandler.obtainMessage(what, arg1, arg2, obj);</span><br><span class="line">        mr.mEventHandler.sendMessage(m);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能在JNI层中访问Java的静态方法了。同理，要想访问Java的方法，则可以使用JNIEnv的<code>CallVoidMethod()</code>函数。</p>
<p>上面例子是使用了<code>jmethodID</code>，下面再来看看<code>jfieldID</code>：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_prepare</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    ALOGV(<span class="string">"prepare"</span>);</span><br><span class="line">    sp&lt;MediaRecorder&gt; mr = getMediaRecorder(env, thiz);</span><br><span class="line">    jobject surface = env-&gt;GetObjectField(thiz, fields.surface); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (surface != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> sp&lt;Surface&gt; native_surface = get_surface(env, surface);</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    process_media_recorder_call(env, mr-&gt;prepare(), <span class="string">"java/io/IOException"</span>, <span class="string">"prepare failed."</span>);</span><br></pre></td></tr></table></figure>

<p>注释1，调用了JNIEnv的<code>GetObjectField()</code>，参数中的<code>fields.surface</code>用来保存Java层<code>MediaRecorder</code>中的成员变量<code>mSurface</code>，<code>mSurface</code>的类型为<code>Surface</code>，这样通过<code>GetObjectField()</code>函数就可以得到<code>mSurface</code>在JNI层中对应的<code>jobject</code>类型的变量<code>mSurface</code>。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JNI/">JNI</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解JNI-01：JNI原理与静态、动态注册" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/09/Android深入理解JNI-01：JNI原理与静态、动态注册/"
    >Android深入理解JNI 01：JNI原理与静态、动态注册</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/09/Android深入理解JNI-01：JNI原理与静态、动态注册/" class="article-date">
  <time datetime="2019-09-09T08:57:27.000Z" itemprop="datePublished">2019-09-09</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解JNI/">深入理解JNI</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>JNI不仅在NDK开发中应用，更是Android系统中Java与Native交互的桥梁。</p>
<h1 id="1-JNI概述"><a href="#1-JNI概述" class="headerlink" title="1. JNI概述"></a>1. JNI概述</h1><p>Android系统按语言可以分成两个部分：Java部分和Native部分。这样分的原因是，一方面是性能，一方面是在Java诞生之前，就有很多程序和库是用Native编写的。Native编写的库具有更好的性能。</p>
<p>Java是如何使用Native的代码呢？可以使用桥梁JNI。</p>
<h1 id="2-MediaRecorder框架概述"><a href="#2-MediaRecorder框架概述" class="headerlink" title="2. MediaRecorder框架概述"></a>2. MediaRecorder框架概述</h1><p><code>MediaRecorder</code>，用于录音和录像。这里主要介绍其中用到的JNI。</p>
<img src="/2019/09/09/Android深入理解JNI-01：JNI原理与静态、动态注册/VmSY7T.png">

<p>Java对应的是<code>MediaRecorder.java</code>，也就是应用开发中直接调用的类。JNI层对应的是<code>libmedia_jni.so</code>，它是一个JNI的动态库。Native层对应的是<code>libmedia.so</code>，这个动态库完成了实际的调用的功能。</p>
<h1 id="3-Java层的MediaRecorder"><a href="#3-Java层的MediaRecorder" class="headerlink" title="3. Java层的MediaRecorder"></a>3. Java层的MediaRecorder</h1><p>先来看看<code>MediaRecorder.java</code>的源码，下面截取了和JNI有关的部分：frameworks/base/media/java/android/media/MediaRecorder.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaRecorder</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"media_jni"</span>); <span class="comment">// 1</span></span><br><span class="line">        native_init(); <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    .......</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">native_init</span><span class="params">()</span></span>; <span class="comment">// 3</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在静态代码块中，首先调用了注释1，用来加载名为<code>&quot;media_jni&quot;</code>的动态库，也就是<code>&quot;libmedia_jni.so&quot;</code>。接着调用注释2的<code>native_init()</code>。注释3的<code>native_init()</code>是用<code>native</code>来修饰的，说明它是一个<code>native</code>方法，表示会由JNI来实现。<code>MediaRecorder</code>的<code>start()</code>方法同样是一个<code>native</code>方法。</p>
<p>对于Java层楼来说，只要加载对应的JNI库，接着声明<code>native</code>方法就可以了，剩下的工作会由JNI层来完成。</p>
<h1 id="4-JNI层的MediaRecorder"><a href="#4-JNI层的MediaRecorder" class="headerlink" title="4. JNI层的MediaRecorder"></a>4. JNI层的MediaRecorder</h1><p><code>MediaRecorder</code>的JNI层是由<code>android_media_recorder.cpp</code>实现的，<code>native</code>方法<code>native_init()</code>和<code>start()</code>的JNI层实现如下：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_native_init</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    jclass clazz;</span><br><span class="line"></span><br><span class="line">    clazz = env-&gt;FindClass(<span class="string">"android/media/MediaRecorder"</span>);</span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   ......</span><br><span class="line">    fields.post_event = env-&gt;GetStaticMethodID(clazz, <span class="string">"postEventFromNative"</span>, <span class="string">"(Ljava/lang/Object;IIILjava/lang/Object;)V"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fields.post_event == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_media_MediaRecorder_start</span><span class="params">(JNIEnv *env, jobject thiz)</span> </span>&#123;</span><br><span class="line">    ALOGV(<span class="string">"start"</span>);</span><br><span class="line">    sp&lt;MediaRecorder&gt; mr = getMediaRecorder(env, thiz);</span><br><span class="line">    process_media_recorder_call(env, mr-&gt;start(), <span class="string">"java/lang/RuntimeException"</span>, <span class="string">"start failed."</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>android_media_MediaRecorder_native_init()</code>方法是<code>native_init()</code>方法在JNI层的实现，<code>android_media_MediaRecorder_start()</code>方法是<code>start()</code>在JNI层的实现。<code>native_init()</code>是如何找到对应的<code>android_media_MediaRecorder_native_init()</code>的呢？这就需要了解JNI方法注册的知识。</p>
<h1 id="5-JNI方法的注册"><a href="#5-JNI方法的注册" class="headerlink" title="5. JNI方法的注册"></a>5. JNI方法的注册</h1><p>JNI方法的注册分成静态注册和动态注册，其中静态注册多用于NDK开发，动态注册多用于Framework开发。</p>
<h2 id="5-1-静态注册"><a href="#5-1-静态注册" class="headerlink" title="5.1 静态注册"></a>5.1 静态注册</h2><p>在AS中新建一个Java Library名为media，这里参照系统的<code>MediaRecorder.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MediaRecorder</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"media_jni"</span>);</span><br><span class="line">        native_init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">native_init</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入项目的media/src/main/java目录中执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac com/example/MediaRecorder.java</span><br><span class="line">javah com.example.MediaRecorder</span><br></pre></td></tr></table></figure>

<p>在执行第二条命令后，会在当前目录下生成com_example_MediaRecorder.h文件：E:\Project\MyStudy\JNISample\media\src\main\java\com_example_MediaRecorder.h</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></span><br><span class="line"><span class="comment">/* Header for class com_example_MediaRecorder */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_com_example_MediaRecorder</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_com_example_MediaRecorder</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_MediaRecorder</span></span><br><span class="line"><span class="comment"> * Method:    native_init</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_com_example_MediaRecorder_native_1init</span><br><span class="line">  (JNIEnv *, jclass); <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Class:     com_example_MediaRecorder</span></span><br><span class="line"><span class="comment"> * Method:    start</span></span><br><span class="line"><span class="comment"> * Signature: ()V</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_com_example_MediaRecorder_start</span><br><span class="line">  (JNIEnv *, jobject);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>navite_init()</code>被声明为注释1的方法，即<code>Java_com_example_MediaRecorder_native_1init</code>，<code>Java</code>开头，说明是在Java平台中调用JNI方法，后面的<code>com_example_MediaRecorder_native_1init</code>指的是包名+类名+方法名的格式，原本在Java中是以<code>.</code>来进行分割，这里使用的是<code>_</code>，因为在Native中，<code>.</code>由特殊的含义。同时在里面多了一个<code>1</code>，这是因为Java的<code>native_init()</code>中包含了<code>&quot;&quot;</code>，转成JNI方法后，就变成了<code>_1</code>。</p>
<p>其中<code>JNIEnv</code>是一个指向全部JNI方法的指针，该指针只在创建它的线程有效，不能跨线程传递。<code>jclass</code>是JNI的数据类型，对应Java的java.lang.Class实例。<code>jobject</code>也是JNI的数据类型，对应Java的Object实例。</p>
<p>当在Java中调用<code>native_init()</code>时，就会从JNI中寻找<code>Java_com_example_MediaRecorder_native_1init()</code>，如果没有，就会报错，如果有，就会为<code>native_init()</code>和<code>Java_com_example_MediaRecorder_native_1init</code>建立关联，其实是保存JNI的方法指针，这样再次调用<code>native_init()</code>，就会直接使用这个方法指针了。</p>
<p>静态注册就是根据方法名，将Java方法和JNI方法建立关联，但它有一些缺点：</p>
<ul>
<li>JNI层的方法名称过长；</li>
<li>声明Native方法的类需要通过javah生成头文件；</li>
<li>初次调用JNI方法时，需要建立关联，影响效率。</li>
</ul>
<p>静态注册就是Java的Native方法通过方法指针来与JNI进行关联，如果Native方法知道它在JNI中对应的方法指针，就可以避免上面的缺点，这就是动态注册。</p>
<h2 id="5-2-动态注册"><a href="#5-2-动态注册" class="headerlink" title="5.2 动态注册"></a>5.2 动态注册</h2><p>JNI中有一种结构用来记录Java的Native方法和JNI方法的关联关系，它就是JNINativemethod，它在jni.h中被定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* name; <span class="comment">// Java方法的名字</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* signature; <span class="comment">// Java方法的签名信息</span></span><br><span class="line">    <span class="keyword">void</span>*       fnPtr; <span class="comment">// JNI中对应的方法指针</span></span><br><span class="line">&#125; JNINativeMethod;</span><br></pre></td></tr></table></figure>

<p>系统的<code>MediaRecorder</code>采用的就是动态注册，来看看它的JNI层是如何定义的：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    ......</span><br><span class="line">    &#123;<span class="string">"start"</span>,            <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_start&#125;, <span class="comment">// 1</span></span><br><span class="line">    &#123;<span class="string">"stop"</span>,             <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_stop&#125;,</span><br><span class="line">    &#123;<span class="string">"pause"</span>,            <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_pause&#125;,</span><br><span class="line">    &#123;<span class="string">"resume"</span>,           <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_resume&#125;,</span><br><span class="line">    &#123;<span class="string">"native_reset"</span>,     <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_native_reset&#125;,</span><br><span class="line">    &#123;<span class="string">"release"</span>,          <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_release&#125;,</span><br><span class="line">    &#123;<span class="string">"native_init"</span>,      <span class="string">"()V"</span>,      (<span class="keyword">void</span> *)android_media_MediaRecorder_native_init&#125;,</span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>上面定义了一个<code>JNINativeMethod</code>类型的<code>gMethods[]</code>数组，里面存储的就是<code>MediaRecorder</code>的Native方法与JNI层方法的对应关系，其中注释1处<code>&quot;start&quot;</code>是Java层的Native方法，它对应的JNI层的方法为<code>android_media_MediaRecorder_start()</code>。<code>&quot;()V&quot;</code>是<code>start()</code>方法的签名信息，会在后面介绍。</p>
<p>只定义<code>JNINativeMethod</code>类型的数组是没有用的，还需要注册它，注册的方法为<code>register_andorid_media_MediaRecorder()</code>：frameworks/base/media/jni/android_media_MediaRecorder.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//JNI_OnLoad in android_media_MediaPlayer.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_media_MediaRecorder</span><span class="params">(JNIEnv *env)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> AndroidRuntime::registerNativeMethods(env, <span class="string">"android/media/MediaRecorder"</span>, gMethods, NELEM(gMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>register_android_media_MediaRecorder()</code>中<code>return</code>了<code>AndroidRuntime</code>的<code>registerNativeMethods()</code>方法，如下：frameworks/base/core/jni/AndroidRuntime.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*static*/</span></span><br><span class="line"><span class="keyword">int</span> AndroidRuntime::registerNativeMethods(JNIEnv* env, <span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> JNINativeMethod* gMethods, <span class="keyword">int</span> numMethods) &#123;</span><br><span class="line">    <span class="keyword">return</span> jniRegisterNativeMethods(env, className, gMethods, numMethods);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>registerNativeMethods()</code>中，又<code>return</code>了<code>jniRegisterNativeMethods()</code>：libnativehelper/JNIHelp.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">"C"</span> <span class="function"><span class="keyword">int</span> <span class="title">jniRegisterNativeMethods</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> <span class="keyword">char</span>* className,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> JNINativeMethod* gMethods, <span class="keyword">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;RegisterNatives(c.get(), gMethods, numMethods) &lt; <span class="number">0</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">char</span>* msg;</span><br><span class="line">        (<span class="keyword">void</span>)asprintf(&amp;msg, <span class="string">"RegisterNatives failed for '%s'; aborting..."</span>, className);</span><br><span class="line">        env-&gt;FatalError(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1可以看出，最终调用的<code>JNIEnv</code>的<code>RegisterNatives()</code>，<code>JNIEnv</code>在JNI中很重要，在后面会介绍。</p>
<p>所以，<code>register_android_media_MediaRecorder()</code>最终调用的是<code>JNIEnv</code>的<code>RegisterNatives()</code>。但是<code>register_android_media_MediaRecorder()</code>是在哪里被调用的呢？在它的注释上可以看到<code>&quot;&quot;JNI_OnLoad in android_media_MediaPlayer.cpp</code>。这个<code>JNI_OnLoad</code>方法会在<code>System.loadLibrary()</code>方法后调用，因为多媒体框架中的很多框架都要进行<code>JNINativeMethods</code>数组注册，因此，注册方法就被统一定义在<code>andorid_media_MediaPlayer.cpp</code>中的<code>JNI_OnLoad()</code>中：frameworks/base/media/jni/android_media_MediaPlayer.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM* vm, <span class="keyword">void</span>* <span class="comment">/* reserved */</span>)</span> </span>&#123;</span><br><span class="line">    JNIEnv* env = <span class="literal">NULL</span>;</span><br><span class="line">    jint result = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (vm-&gt;GetEnv((<span class="keyword">void</span>**) &amp;env, JNI_VERSION_1_4) != JNI_OK) &#123;</span><br><span class="line">        ALOGE(<span class="string">"ERROR: GetEnv failed\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> *bail;</span><br><span class="line">    &#125;</span><br><span class="line">    assert(env != <span class="literal">NULL</span>);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (register_android_media_MediaPlayer(env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        ALOGE(<span class="string">"ERROR: MediaPlayer native registration failed\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> *bail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (register_android_media_MediaRecorder(env) &lt; <span class="number">0</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        ALOGE(<span class="string">"ERROR: MediaRecorder native registration failed\n"</span>);</span><br><span class="line">        <span class="keyword">goto</span> *bail;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    result = JNI_VERSION_1_4;</span><br><span class="line">bail:</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>JNI_OnLoad()</code>中调用了整个多媒体框架的注册<code>JNINativeMethod</code>数组的方法。注释1调用了<code>register_android_media_MediaRecorder()</code>方法，同样的，<code>MediaPlayer</code>框架的注册<code>JNINativeMethod</code>数组的方法<code>register_android_media_MediaPlayer</code>也被调用了。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JNI/">JNI</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解Context-02" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/09/Android深入理解Context-02/"
    >Android深入理解Context 02</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/09/Android深入理解Context-02/" class="article-date">
  <time datetime="2019-09-09T06:06:04.000Z" itemprop="datePublished">2019-09-09</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解Context/">深入理解Context</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="1-Activity的Context创建过程"><a href="#1-Activity的Context创建过程" class="headerlink" title="1. Activity的Context创建过程"></a>1. Activity的Context创建过程</h1><p>当在Activity中调用<code>startActivity()</code>时，实际上调用的是<code>Context</code>的<code>startActivity()</code>，如果想要在Activity中使用<code>Context</code>提供的方法，务必要先创建<code>Context</code>。Activity的<code>Context</code>会在Activity的启动过程中被创建，在<a href="https://tylerliu.top/2019/09/02/Andorid深入理解四大组件-02%EF%BC%9A应用程序启动过程%EF%BC%88下%EF%BC%89/#more">Andorid深入理解四大组件 02：应用程序启动过程（下）</a>第二节中，讲到<code>ActivityThread</code>启动Activity的过程，现在从这里开始分析。</p>
<p><code>ActivityThread</code>是应用程序进程的核心类，它的内部类<code>ApplicatonThread</code>会调用<code>scheduleLaunchActivity()</code>来启动Activity：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line">    updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line">    r.token = token;</span><br><span class="line">    ......</span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>scheduleLaunchActivity()</code>中会将启动Activity的参数封装成<code>ActivityClientRecord</code>，<code>sendMessage()</code>会向<code>H</code>类发送类型为<code>LAUNCH_ACTIVITY</code>的消息，并将<code>ActivityClientRecord</code>传递过去。<code>sendMessage()</code>的目的是将启动Activity的逻辑放在主线程中的消息队列中，这样启动Activity的逻辑就会在主线程中执行。<code>H</code>类中在<code>handleMessage()</code>的<code>LAUNCH_ACTIVITY</code>类型的消息进行处理，其中调用了<code>handleLaunchActivity()</code>，而<code>handleLaunchActivity()</code>中又调用了<code>performLaunchActivity()</code>，这个过程在上篇已经讲过，再来看看<code>performLaunchActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent); <span class="comment">// 1</span></span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity); <span class="comment">// 2</span></span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 3</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); <span class="comment">// 4</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        ......</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，创建Activity的实例。</p>
<p>注释2，通过<code>createBaseContextForActivity()</code>创建Activity的<code>ContextImpl</code>，并将<code>ContextImpl</code>传入注释3的<code>activity</code>的<code>attach()</code>。</p>
<p>注释4，<code>Instrumentation</code>的<code>callActivityOnCreate()</code>中会调用Activiy的<code>onCreate()</code>。</p>
<p>先来看看注释2的<code>createBaseContextForActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    ContextImpl appContext = ContextImpl.createActivityContext(<span class="keyword">this</span>, r.packageInfo, r.token, displayId, r.overrideConfig); <span class="comment">// 1</span></span><br><span class="line">    appContext.setOuterContext(activity); <span class="comment">// 2</span></span><br><span class="line">    Context baseContext = appContext;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> baseContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，调用<code>ContextImpl.createActivityContext()</code>来创建<code>ContextImpl</code>。</p>
<p>注释2，调用<code>Context.setOuterContext()</code>，将前面创建的Activity实例赋值给<code>ContextImpl</code>的成员变量<code>mOuterContext</code>，这样<code>ContextImpl</code>也可以访问Activity的变量和方法。</p>
<p>再回到<code>ActivityThread</code>的<code>performLaunchActivity()</code>，在注释3的<code>attach()</code>：frameworks/base/core/java/android/app/Activity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></span><br><span class="line"><span class="function"><span class="params">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        Application application, Intent intent, ActivityInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">        CharSequence title, Activity parent, String id,</span></span></span><br><span class="line"><span class="function"><span class="params">        NonConfigurationInstances lastNonConfigurationInstances,</span></span></span><br><span class="line"><span class="function"><span class="params">        Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        Window window)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context); <span class="comment">// 1</span></span><br><span class="line">    mFragments.attachHost(<span class="keyword">null</span> <span class="comment">/*parent*/</span>);</span><br><span class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>, window); <span class="comment">// 2</span></span><br><span class="line">    mWindow.setWindowControllerCallback(<span class="keyword">this</span>);</span><br><span class="line">    mWindow.setCallback(<span class="keyword">this</span>); <span class="comment">// 3</span></span><br><span class="line">    mWindow.setOnWindowDismissedCallback(<span class="keyword">this</span>);</span><br><span class="line">    ......</span><br><span class="line">    mWindow.setWindowManager((WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>); <span class="comment">// 4</span></span><br><span class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mWindow.setContainer(mParent.getWindow());</span><br><span class="line">    &#125;</span><br><span class="line">    mWindowManager = mWindow.getWindowManager(); <span class="comment">// 5</span></span><br><span class="line">    mCurrentConfig = config;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释2，创建<code>PhoneWindow</code>，代表应用程序窗口。<code>PhoneWindow</code>在运行中会间接触发很多事件，比如点击事件、菜单弹出、屏幕焦点变化等事件，这些事件需要转发给与<code>PhoneWindow</code>关联的Activity，转发操作是通过<code>Window.Callback</code>接口实现，Activity实现了这个接口，在注释3处将当前Activity通过Window的<code>setCallback()</code>传递给<code>PhoneWindow</code>。</p>
<p>注释4，给<code>PhoneWindow</code>设置<code>WindowManager</code>，并在注释5处获取<code>WindowManager</code>并赋值给Activity的成员变量<code>mWindowManager</code>，这样在Activity中就可以通过<code>getWindowManager()</code>来获取<code>WindowManager</code>。</p>
<p>注释1，调用了<code>ContextThemeWrapper</code>的<code>attachBaseContext()</code>：frameworks/base/core/java/android/view/ContextThemeWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context newBase)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.attachBaseContext(newBase);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在里面调用了<code>ContextThemeWrapper</code>的父类<code>ContextWrapper</code>的<code>attachBaseContext()</code>：frameworks/base/core/java/android/content/ContextWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base; <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>base</code>指的是从前面传过来到Activity的<code>ContextImpl</code>，将它赋值给<code>ContextWrapper</code>的成员变量<code>mBase</code>。这样<code>ContextWrapper</code>的功能就可以交由<code>ContextImpl</code>处理，例如：frameworks/base/core/java/android/content/ContextWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Resources.<span class="function">Theme <span class="title">getTheme</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mBase.getTheme();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当调用<code>ContextWrapper</code>的<code>getTheme()</code>时，实际上调用的是<code>COntextImpl</code>的<code>getTheme()</code>。</p>
<p>总结，在启动Activity的过程中创建了<code>ContextImpl</code>，并赋值给了<code>ContextWrapper</code>的成员变量<code>mBase</code>中。Activity继承自<code>ContextWrapper</code>的子类<code>ContextThemeWrapper</code>，这样在Activity中就可以使用<code>ContextImpl</code>了。</p>
<p><code>ActivityThread</code>到<code>ContextImpl</code>的调用时序图：</p>
<img src="/2019/09/09/Android深入理解Context-02/VejzTg.png">

<h1 id="2-Service的Context创建过程"><a href="#2-Service的Context创建过程" class="headerlink" title="2. Service的Context创建过程"></a>2. Service的Context创建过程</h1><p>Service的Context创建过程与Activity的Context创建过程类似，也是在Service的启动过程中被创建。在<a href="https://tylerliu.top/2019/09/03/Andorid深入理解四大组件-03%EF%BC%9AService的启动过程/#more">Andorid深入理解四大组件 03：Service的启动过程</a>第二节中讲到<code>ActivityThread</code>启动Service的过程，现在从这里开始分析。</p>
<p><code>ActivityThread</code>的内部类<code>ApplicationThread</code>会调用<code>scheduleCreateService()</code>来启动Service：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleCreateService</span><span class="params">(IBinder token,</span></span></span><br><span class="line"><span class="function"><span class="params">        ServiceInfo info, CompatibilityInfo compatInfo, <span class="keyword">int</span> processState)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    sendMessage(H.CREATE_SERVICE, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向<code>H</code>类发送类型为<code>CREATE_SERVICE</code>的消息。在<code>H</code>中，<code>handleMessage()</code>的对应<code>case</code>作出处理，在里面调用了<code>handleCreateService()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleCreateService</span><span class="params">(CreateServiceData data)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Creating service "</span> + data.info.name);</span><br><span class="line">        ContextImpl context = ContextImpl.createAppContext(<span class="keyword">this</span>, packageInfo); <span class="comment">// 1</span></span><br><span class="line">        context.setOuterContext(service);</span><br><span class="line">        Application app = packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        service.attach(context, <span class="keyword">this</span>, data.info.name, data.token, app, ActivityManagerNative.getDefault()); <span class="comment">// 2</span></span><br><span class="line">        service.onCreate();</span><br><span class="line">        ......</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    ......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，创建<code>ContextImpl</code>，并将该<code>ContextImpl</code>传入注释2中<code>Service.attach()</code>中：frameworks/base/core/java/android/app/Service.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread thread, String className, IBinder token, Application application, Object activityManager)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context); <span class="comment">// 1</span></span><br><span class="line">    mThread = thread;</span><br><span class="line">    mClassName = className;</span><br><span class="line">    mToken = token;</span><br><span class="line">    mApplication = application;</span><br><span class="line">    mActivityManager = (IActivityManager)activityManager;</span><br><span class="line">    mStartCompatibility = getApplicationInfo().targetSdkVersion &lt; Build.VERSION_CODES.ECLAIR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，调用<code>ContextWrapper</code>的<code>attachBaseContext()</code>：frameworks/base/core/java/android/content/ContextWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法已经在前面讲过。</p>
<p>Service的Context创建过程就讲到这里，由于它和Activity的Context创建过程类似，因此，可以参考前文给出的<code>ActivityThread</code>到<code>ContextWrapper</code>的调用时序图。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Context/">Context</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Android深入理解Context-01" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/07/Android深入理解Context-01/"
    >Android深入理解Context 01</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/07/Android深入理解Context-01/" class="article-date">
  <time datetime="2019-09-07T07:35:49.000Z" itemprop="datePublished">2019-09-07</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解Context/">深入理解Context</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Context</code>：上下文对象，这里基于Andorid 7.0源码进行解析。</p>
<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p><code>Context</code>：一个应用程序的环境信息的接口。</p>
<p>开发中使用场景主要有两类：</p>
<ul>
<li>使用<code>Context</code>调用方法，比如：启动Activity、访问资源、调用系统级服务等。</li>
<li>调用方法传入<code>Context</code>，比如：弹出<code>Toast</code>、创建<code>Dialog</code>等。</li>
</ul>
<p>Activity、Service和Application都间接继承了Context。因此可以计算出一个应用程序进程中有多少个Context，其个数等于Activity、Service的总和加1，这个1是Application。</p>
<p><code>Context</code>是一个抽象类，内部定义了很多方法和静态常量，它的具体实现是<code>ContextImpl</code>。和<code>Context</code>相关联的类，除了<code>ContextImpl</code>，还有<code>ContextWrapper</code>、<code>ContextThemeWrapper</code>和<code>Activity</code>等。下面是<code>Context</code>的关系图：</p>
<img src="/2019/09/07/Android深入理解Context-01/VejqSI.png">

<p>图中可以看出，<code>ContextImpl</code>和<code>ContextWrapper</code>继承自<code>Context</code>，<code>ContextWrapper</code>内部包含有<code>Context</code>类型的<code>mBase</code>对象，<code>mBase</code>具体的指向是<code>ContextImpl</code>。<code>ContextImpl</code>提供了很多功能，但外界还需要使用和拓展<code>ContextImpl</code>，所以将其设计成装饰模式，<code>ContextWrapper</code>是装饰类，它对<code>ContextImpl</code>类进行了包装，<code>ContextWrapper</code>主要起方法传递作用，<code>ContextWrapper</code>中几乎所有的方法实现都是调用<code>ContextImpl</code>的相应方法来实现的。</p>
<p><code>ContextThemeWrapper</code>、<code>Service</code>和<code>Applicaiton</code>继承自<code>ContextWrapper</code>，它们都可以通过<code>mBase</code>来使用<code>Context</code>的方法，同时它们也都是装饰类，在<code>ContextWrapper</code>的基础上又添加了不同的功能。</p>
<p><code>ContextThemeWrapper</code>中包含了和主题相关的方法，比如：<code>getTheme()</code>。因此，需要主题的<code>Activity</code>继承自<code>ContextThemeWrapper</code>，而不需要主题的<code>Service</code>继承自<code>ContextWrapper</code>。</p>
<h1 id="2-Application-Context的创建过程"><a href="#2-Application-Context的创建过程" class="headerlink" title="2. Application Context的创建过程"></a>2. Application Context的创建过程</h1><p>通常使用<code>getApplicationContext()</code>来获取全局的Application Context，那么Application Context是如何创建的？</p>
<p>在<a href="https://tylerliu.top/2019/09/02/Andorid深入理解四大组件-02%EF%BC%9A应用程序启动过程%EF%BC%88下%EF%BC%89/">Andorid深入理解四大组件 02：应用程序启动过程（下）</a>中最后讲到<code>ActivityThread</code>启动Activity。<code>ActivityThread</code>作为应用程序进程的核心类，它会调用其内部的<code>ApplicationThread</code>的<code>scheduleLaunchActivity()</code>来启动Activity：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">    r.token = token;</span><br><span class="line">    r.ident = ident;</span><br><span class="line">    r.intent = intent;</span><br><span class="line">    r.referrer = referrer;</span><br><span class="line">    r.voiceInteractor = voiceInteractor;</span><br><span class="line">    r.activityInfo = info;</span><br><span class="line">    r.compatInfo = compatInfo;</span><br><span class="line">    r.state = state;</span><br><span class="line">    r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">    r.pendingResults = pendingResults;</span><br><span class="line">    r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">    r.startsNotResumed = notResumed;</span><br><span class="line">    r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">    r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">    r.overrideConfig = overrideConfig;</span><br><span class="line">    updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ApplicationThread</code>的<code>scheduleLaunchActivity()</code>向<code>H</code>类发送类型为<code>LAUNCH_ACTIVITY</code>的消息，目的是将启动Activity的逻辑放到主线程中的消息列里中，这样启动Activity的逻辑就会在主线程中执行。再来查看<code>H</code>中对于<code>LAUNCH_ACTIVITY</code>的处理：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line">        r.packageInfo = getPackageInfoNoCheck(r.activityInfo.applicationInfo, r.compatInfo); <span class="comment">// 1</span></span><br><span class="line">        handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>); <span class="comment">// 2</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125; </span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>注释1，通过<code>getPackageInfo()</code>获得<code>LoadedApk</code>的对象，并将该值赋值给<code>ActivityClientRecord.packageInfo</code>，<code>LoadedApk</code>是用来描述已加载的APK文件。</p>
<p>注释2，调用<code>handleLaunchActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查看<code>performLaunchActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">        ......</span><br><span class="line">    &#125; </span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里只保留与Application Context相关的逻辑。从前面知道，这里的<code>r.packageInfo</code>是<code>LoadedApk</code>类型的，下面查看其<code>makeApplication()</code>：frameworks/base/core/java/android/app/LoadedApk.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass, Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123; <span class="comment">// 1</span></span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        ......</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>); <span class="comment">// 2</span></span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(cl, appClass, appContext); <span class="comment">// 3</span></span><br><span class="line">        appContext.setOuterContext(app); <span class="comment">// 4</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app; <span class="comment">// 5</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，如果<code>mApplication</code>不为空，就返回<code>mApplication</code>。这里假设是第一次启动应用程序，所以<code>mApplication</code>为空。</p>
<p>注释2，通过<code>ContextImpl</code>的<code>createAppContext()</code>创建其实例。</p>
<p>注释3，创建<code>Application</code>，在<code>Instrumentation</code>的<code>newApplication()</code>中传入了<code>ClassLoader</code>类型的对象以及注释2创建的<code>ContextImpl</code>。</p>
<p>注释4，将<code>Application</code>赋值给<code>ContextImpl</code>的<code>Context</code>类型的成员变量<code>mOuterContext</code>。</p>
<p>注释5，将<code>Application</code>赋值给<code>LoadedApk</code>的成员变量<code>mApplication</code>。</p>
<p>再来看看注释3的<code>Application</code>的创建，<code>Instrumentation</code>的<code>newApplication()</code>：frameworks/base/core/java/android/app/Instrumentation.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(Class&lt;?&gt; clazz, Context context)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">    Application app = (Application)clazz.newInstance(); <span class="comment">// 1</span></span><br><span class="line">    app.attach(context);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Instrumentation</code>中有两个<code>newApplication()</code>重载方法，最终都会调用上面的这个重载方法。注释1，通过反射创建<code>Application</code>，并调用<code>Application</code>的<code>attach()</code>，传入<code>ContextImpl</code>：frameworks/base/core/java/android/app/Application.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>attach()</code>中调用了<code>attachBaseContext()</code>，它的实现在<code>Application</code>的父类<code>ContextWrapper</code>中：frameworks/base/core/java/android/content/ContextWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBase != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Base context already set"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mBase = base;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>base</code>指的就是<code>ContextImpl</code>，将<code>ContextImpl</code>赋值给<code>ContextWrapper</code>类型的成员变量<code>mBase</code>。Application Context创建的过程就到这里。</p>
<p>Application Context创建过程的时序图：</p>
<img src="/2019/09/07/Android深入理解Context-01/VejLlt.png">

<h1 id="3-Application-Context的获取过程"><a href="#3-Application-Context的获取过程" class="headerlink" title="3. Application Context的获取过程"></a>3. Application Context的获取过程</h1><p>通过<code>getApplicationContext()</code>来获取Application Context，<code>getApplicationContext()</code>的实现是在<code>ContextWrapper</code>中：frameworks/base/core/java/android/content/ContextWrapper.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mBase.getApplicationContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从前面得知，<code>mBase</code>指的就是<code>ContextImpl</code>，再来查看<code>ComtextImpl</code>的<code>getApplicationContext()</code>：frameworks/base/core/java/android/app/ContextImpl.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (mPackageInfo != <span class="keyword">null</span>) ? mPackageInfo.getApplication() : mMainThread.getApplication();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果<code>LoadedApk</code>不为空，就调用<code>LoadedApk</code>的<code>getApplication()</code>，否则就调用<code>ActivityThread</code>的<code>getApplication()</code>。由于应用程序进程已经启动，所以<code>LoadedApk</code>不会为空，就会调用<code>LoadedApk.getApplication()</code>：frameworks/base/core/java/android/app/LoadedApk.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的<code>mApplication</code>就是在<code>LoadedApk.makeApplication()</code>中注释5被赋值。这样就通过<code>getApplicationContext()</code>获取Application Context了。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Context/">Context</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
    <article id="post-Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2019/09/07/Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）/"
    >Andorid深入理解四大组件 08：Android 8.0 根Activity启动过程（下）</a> 
</h2>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2019/09/07/Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）/" class="article-date">
  <time datetime="2019-09-07T03:08:35.000Z" itemprop="datePublished">2019-09-07</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android进阶/">Android进阶</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/">框架层</a> / <a class="article-category-link" href="/categories/Android进阶/框架层/深入理解四大组件/">深入理解四大组件</a>
  </div>

      
      
      
    </div>
    

    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="1-ActivityThread启动Activity过程"><a href="#1-ActivityThread启动Activity过程" class="headerlink" title="1. ActivityThread启动Activity过程"></a>1. ActivityThread启动Activity过程</h1><p><a href="https://tylerliu.top/2019/09/04/Andorid深入理解四大组件-07%EF%BC%9AAndroid-8-0-根Activity启动过程%EF%BC%88上%EF%BC%89/#more">Andorid深入理解四大组件 07：Android 8.0 根Activity启动过程（上）</a>中已经介绍到代码逻辑运行在应用程序进程中。先来查看<code>ActivityThread</code>启动Activity的过程的时序图。</p>
<img src="/2019/09/07/Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）/VeqcKU.png">

<p>接着查看<code>ApplicationThread</code>的<code>scheduleLaunchActivity()</code>，其中<code>ApplicationThread</code>是<code>ActivityThread</code>的内部类，应用程序进程创建后会运行代表主线程的实例<code>ActivityThread</code>，它会管理当前应用程序进程的线程。frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line">    updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line">    r.token = token;</span><br><span class="line">    r.ident = ident;</span><br><span class="line">    r.intent = intent;</span><br><span class="line">    r.referrer = referrer;</span><br><span class="line">    ......</span><br><span class="line">    updatePendingConfiguration(curConfig);</span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>scheduleLaunchActivity()</code>会将启动Activity的参数封装成<code>ActivityClientRecord</code>，<code>sendMessage()</code>会向<code>H</code>发送类型为<code>LAUNCH_ACTIVITY</code>的消息，并将<code>ActivityClientRecord</code>的对象发送出去：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">int</span> what, Object obj, <span class="keyword">int</span> arg1, <span class="keyword">int</span> arg2, <span class="keyword">boolean</span> async)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    Message msg = Message.obtain();</span><br><span class="line">    msg.what = what;</span><br><span class="line">    msg.obj = obj;</span><br><span class="line">    msg.arg1 = arg1;</span><br><span class="line">    msg.arg2 = arg2;</span><br><span class="line">    <span class="keyword">if</span> (async) &#123;</span><br><span class="line">        msg.setAsynchronous(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mH.sendMessage(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终会调用<code>H</code>的方法，现在查看<code>H</code>的<code>handleMessage()</code>中对于<code>LAUNCH_ACTIVITY</code>的处理：frameworks/base/core/java/android/app/ActivityThread.H.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">        <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj; <span class="comment">// 1</span></span><br><span class="line">        r.packageInfo = getPackageInfoNoCheck(r.activityInfo.applicationInfo, r.compatInfo); <span class="comment">// 2</span></span><br><span class="line">        handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>); <span class="comment">// 3</span></span><br><span class="line">        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    &#125; </span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>注释1，将传来的<code>msg.obj</code>转成<code>ActivityCLientRecord</code>。</p>
<p>注释2，通过<code>getPackageInfoNoCheck()</code>获得<code>LoadedApk</code>类型的对象并赋值给<code>ActivityClientRecord</code>的成员变量<code>packageInfo</code>。应用程序进程要启动Activity时需要将该Activity所属的APK加载进来，而<code>LoadedApk</code>就是用来描述已加载的APK文件。</p>
<p>注释3，调用<code>handleLaunchActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line">    <span class="comment">// 启动Activity</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent); <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        reportSizeConfigurations(r);</span><br><span class="line">        Bundle oldState = r.state;</span><br><span class="line">        <span class="comment">// 将Activity的状态设置为Resume</span></span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason); <span class="comment">// 2</span></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">            performPauseActivityIfNeeded(r, reason);</span><br><span class="line">            <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">                r.state = oldState;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 停止Activity启动</span></span><br><span class="line">            ActivityManager.getService().finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，<code>performLaunchActivity()</code>用来启动Activity。</p>
<p>注释2，用来将Activity的状态设置为Resume。</p>
<p>如果该Activity为空，就通知AMS停止启动Activity。</p>
<p>先看看<code>performLaunchActivity()</code>：frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ActivityInfo aInfo = r.activityInfo; <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo, Context.CONTEXT_INCLUDE_CODE); <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">    ComponentName component = r.intent.getComponent(); <span class="comment">// 3</span></span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 创建要启动Activity的上下文环境</span></span><br><span class="line">    ContextImpl appContext = createBaseContextForActivity(r); <span class="comment">// 4</span></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">        <span class="comment">// 用类加载器创建该Activity的实例</span></span><br><span class="line">        activity = mInstrumentation.newActivity(cl, component.getClassName(), r.intent); <span class="comment">// 5</span></span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation); <span class="comment">// 6</span></span><br><span class="line">        ......</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ......</span><br><span class="line">            <span class="comment">// 7</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line">            ......</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); <span class="comment">// 8</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            ......</span><br><span class="line">        &#125;</span><br><span class="line">        r.paused = <span class="keyword">true</span>;</span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注释1，获取<code>ActivityInfo</code>，用于存储代码和<code>AndroidManifest</code>设置的Activity和<code>receiver</code>节点信息，比如Activity的<code>theme</code>和<code>launchMode</code>。</p>
<p>注释2，获取APK文件的描述类<code>LoadedApk</code>。</p>
<p>注释3，获取要启动的Activity的<code>ComponentName</code>类，在其中保存了该Activity的包名和类名。</p>
<p>注释4，创建要启动Activity的上下文环境。</p>
<p>注释5，根据<code>ComponentName</code>中存储的Activity类名，用类加载器创建该Activity的实例。</p>
<p>注释6，创建<code>Applicaiton</code>，<code>nakeApplication()</code>内部会调用<code>Application</code>的<code>onCreate()</code>。</p>
<p>注释7，调用Activity的<code>attach()</code>初始化Activity，<code>attach()</code>中会创建Window对象（<code>PhoneWindow</code>）并与Activity自身进行关联。</p>
<p>注释8，调用<code>Instrumentation</code>的<code>callActivityOnCreate()</code>来启动Activity：frameworks/base/core/java/android/app/Instrumentation.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在里面调用了Activity的<code>performCreate()</code>：frameworks/base/core/java/android/app/Activity.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    onCreate(icicle);</span><br><span class="line">    mActivityTransitionState.readState(icicle);</span><br><span class="line">    performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>performCreate()</code>中会调用Activity的<code>onCreate()</code>。这样根Activity就启动了，即应用程序启动了。</p>
<h1 id="2-根Activity启动过程中涉及的进程"><a href="#2-根Activity启动过程中涉及的进程" class="headerlink" title="2. 根Activity启动过程中涉及的进程"></a>2. 根Activity启动过程中涉及的进程</h1><p>在应用程序进程没有创建的情况下，根Activity启动过程会涉及到4个进程，分别是Zygote进程、Launcher进程、AMS所在的进程（SystemServer进程）和应用程序进程。它们之间的关系如下：</p>
<img src="/2019/09/07/Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）/VeqyvT.png">

<p>首先Launcher进程向AMS请求创建根Activity，AMS会判断根Activity所需的应用程序进程是否存在并启动，如果不存在就会请求Zygote进程创建应用程序进程。应用程序进程准备就绪后会通知AMS，AMS会请求应用程序进程创建根Activity。上图中步骤2采用的是Stock通信，步骤1和步骤4采用的是Binder通信。</p>
<p>下面是四个进程调用的时序图：</p>
<img src="/2019/09/07/Andorid深入理解四大组件-08：Android-8-0-根Activity启动过程（下）/Veqs2V.png">

<p>普通Activity启动过程会涉及两个进程，AMS所在的进程和应用程序进程。</p>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/四大组件/">四大组件</a></li></ul>


    </footer>

  </div>

  

  
  
  

  
  
  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2020
        <i class="ri-heart-fill heart_icon"></i> Tyler Liu
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered by <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Theme - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Tyler的博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<!-- Subtitle -->

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['人生是一场难得的修行，不要轻易交白卷', '', ''],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
    console.log(err)
  }
</script>

<!-- Tocbot -->

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>
<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom -->

<!-- CodeCopy -->

<link rel="stylesheet" href="/css/clipboard.css">
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>



    
  </div>
</body>

</html>