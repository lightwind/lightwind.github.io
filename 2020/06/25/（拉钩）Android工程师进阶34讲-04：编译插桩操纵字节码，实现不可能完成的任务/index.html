<!DOCTYPE html>


<html lang="zh-Hans">


<head>
  <meta charset="utf-8" />
    
  <meta name="description" content="人生是一场难得的修行，不要轻易交白卷" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
    （拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务 |  Tyler的博客
  </title>
  <meta name="generator" content="hexo-theme-ayer">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  <link rel="stylesheet" href="/dist/main.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/css/remixicon.min.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  <script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>
  
  

  

</head>

</html>

<body>
  
  <canvas width="1777" height="841" style="position: fixed; left: 0px; top: 0px; z-index: 999; pointer-events: none;"></canvas>
  
  <div id="app">
    <main class="content on">
      <section class="outer">
  <article id="post-（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  （拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务
</h1>
 

    </header>
    

    
    <div class="article-meta">
      <a href="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/" class="article-date">
  <time datetime="2020-06-25T06:39:50.000Z" itemprop="datePublished">2020-06-25</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a> / <a class="article-category-link" href="/categories/Android/进阶/">进阶</a>
  </div>

      
      
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> Word count:</span>
            <span class="post-count">4.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> Reading time≈</span>
            <span class="post-count">19 min</span>
        </span>
    </span>
</div>

      
    </div>
    

    
    
    <div class="tocbot"></div>





    

    
    <div class="article-entry" itemprop="articleBody">
      
      

      
      <h1 id="0-前言"><a href="#0-前言" class="headerlink" title="0. 前言"></a>0. 前言</h1><p>前面介绍了Java字节码文件的格式，并通过一个Demo手动模拟了JVM解析class文件的过程。</p>
<p>本节看看，对于class文件还有其他什么玩法。</p>
<p>需求：</p>
<blockquote>
<p>记录每个页面的打开和关闭事件，并通过各种Data Tracking的框架上传到服务器，用来日后做数据分析。</p>
</blockquote>
<p>面对这样的需求，一般人会想到在每个Activity的<code>onCreate</code>和<code>onDestory</code>方法中，分别添加页面打开和关闭的逻辑。常见的做法有以下两种：</p>
<ul>
<li>1、修改项目中现有的每一个Activity，这样做，如果项目以后需要添加新的页面，这套逻辑需要多次拷贝，容易遗漏。</li>
<li>2、将项目中所有的Activity继承BaseActivity，将页面打开和关闭的逻辑添加在BaseActivity，这样做比1要好一些。但是这种方法对于第三方依赖库中的界面就无法添加。</li>
</ul>
<p>这时有一种更加优雅的处理方式：<strong>编译插桩</strong>。</p>
<h1 id="1-编译插桩是什么"><a href="#1-编译插桩是什么" class="headerlink" title="1. 编译插桩是什么"></a>1. 编译插桩是什么</h1><p>编译插桩就是在代码编译期间修改已有的代码或者生成新的代码。实际上，项目中用到的Dagger、ButterKnife甚至是Kotlin语言，都用到了编译插桩技术。</p>
<p>Android项目中.java文件的编译过程：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/Android中.java文件编译过程.png">

<p>从上图可以看出，在1、2两处对代码进行改造。</p>
<ul>
<li>1、在.java文件编译成.class文件时，ART、AndroidAnnotation等就是在此处触发代码生成。</li>
<li>2、在.class文件进一步优化成.dex文件时，也就是直接操作字节码文件，也是本节的内容。这种方式功能更加强大，应用场景也更多。但是门槛比较高，需要对字节码有一定理解。</li>
</ul>
<p>本节主要介绍第2种实现方式，用一张图描述如下过程，其中红色虚框包含了本节的所有内容。</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/修改.class文件.png">

<p>一般情况下，经常会使用编译插桩实现如下几种功能：</p>
<ul>
<li>日志埋点；</li>
<li>性能监控；</li>
<li>动态权限控制；</li>
<li>业务逻辑跳转时，校验是否已经登录；</li>
<li>甚至是代码调试等。</li>
</ul>
<h1 id="2-插桩工具介绍"><a href="#2-插桩工具介绍" class="headerlink" title="2. 插桩工具介绍"></a>2. 插桩工具介绍</h1><p>目前主要流行两种实现编译插桩的方式：</p>
<ul>
<li><strong>AspectJ</strong>：AspectJ是老牌的AOP(Aspect-Oriented Programming)框架，如果做过J2EE可能会对这个框架更熟悉，经常拿这个框架和Spring AOP进行比较。其主要优势是成熟稳定，使用者也不需要对字节码有深入的理解。</li>
<li><strong>ASM</strong>：通过ASM可以修改现有的字节码文件，也可以动态生成字节码文件，并且它是一款完全以字节码层面来操纵字节码并分析字节码的框架。</li>
</ul>
<p>举例，在Java中实现两个数相加操作，可以如下实现：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/相加.png">

<p>如果直接使用ASM直接编写字节码指令，则有可能是如下几个字节码指令：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/ASM编写字节码指令.png">

<p>有工具可以帮助实现这些字节码指令。</p>
<p>本节就是使用ASM来实现简单的编译插桩效果，通过插桩实现最开始提出的需求，在每个Activity打开时输出相应的log日志。</p>
<h1 id="3-实现思路"><a href="#3-实现思路" class="headerlink" title="3. 实现思路"></a>3. 实现思路</h1><p>主要包含两步：</p>
<ul>
<li>1、<strong>遍历项目中所有的.class文件</strong>：如何找到项目中编译生成的所有.class文件，是需要解决的第一个问题。众所周知，Android Studio使用Gradle编译项目中的.java文件，并且从Gradle 1.5.0之后，可以自定义<code>Transform</code>，来获取所有.class文件引用。但是<code>Transform</code>的使用需要依赖Gradle Plugin。<strong>因此第一步需要创建一个单独的Gradle Plugin，并在Gradle Plugin中使用自定义<code>Transform</code>找出所有的.class文件</strong>。</li>
<li>2、<strong>遍历到目标.class文件(Activity)之后，通过ASM动态注入需要被插桩的字节码</strong>：第一步找到所有的.class文件，<strong>接下来就是过滤出目标Activity文件，并在目标Activity文件的<code>onCreate</code>方法中，通过ASM插入相应的log日志字节码</strong>。</li>
</ul>
<h1 id="4-具体实现"><a href="#4-具体实现" class="headerlink" title="4. 具体实现"></a>4. 具体实现</h1><h2 id="4-1-创建ASMLifeCycleDemo项目"><a href="#4-1-创建ASMLifeCycleDemo项目" class="headerlink" title="4.1 创建ASMLifeCycleDemo项目"></a>4.1 创建ASMLifeCycleDemo项目</h2><p>创建ASMLifeCycleDemo项目：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/创建ASMLifeCycleDemo项目.png">

<h2 id="4-2-创建自定义Gradle插件"><a href="#4-2-创建自定义Gradle插件" class="headerlink" title="4.2 创建自定义Gradle插件"></a>4.2 创建自定义Gradle插件</h2><p>首先在ASMLifeCycleDemo项目中创建一个新的module，并选择Android Library类型，命名为asm_lifecyle_plugin。</p>
<p>并将asm_lifecyle_plugin中除了build.gradle和main文件夹之外的所有内容都删除。然后在main目录下分别创建groovy和java目录。</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/创建groovy和java目录.png">

<p>因为Gradle插件是使用Groovy编写的，所以需要创建一个groovy目录，用来存放插件相关的.groovy类。但是ASM是java层面的框架，所以在java目录里存放ASM相关的类。</p>
<p>然后，在groovy中创建目录tyler.liu.plugin，并在此目录中创建类<code>LifeCyclePlugin.groovy</code>文件。在<code>LifeCyclePlugin</code>中重写<code>apply</code>方法，实现插件逻辑，这里只是简单打印。</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/LifeCyclePlugin.png">

<p>可以看出<code>LifeCyclePlugin</code>实现了gradle api中的<code>Plugin</code>接口。当在build.gradle文件中使用此插件时，其<code>LifeCyclePlugin</code>的<code>apply</code>方法将会被自动调用。</p>
<p>下面将asm_lifecycle_plugin中的build.gradle的内容全部删掉，换成如下内容：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">'groovy'</span></span><br><span class="line">apply plugin: <span class="string">'maven'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">includes</span>: [<span class="string">'*.jar'</span>])</span><br><span class="line"></span><br><span class="line">    implementation gradleApi()</span><br><span class="line">    implementation localGroovy()</span><br><span class="line"></span><br><span class="line">    implementation <span class="string">'com.android.tools.build:gradle:3.4.2'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">group</span> = <span class="string">'tyler.lifecycle.plugin'</span></span><br><span class="line">version = <span class="string">'1.0.0'</span></span><br><span class="line"></span><br><span class="line">uploadArchives &#123;</span><br><span class="line">    <span class="keyword">repositories</span> &#123;</span><br><span class="line">        mavenDeployer &#123;</span><br><span class="line">            <span class="comment">// 本地的Maven地址配置</span></span><br><span class="line">            repository(url: uri(<span class="string">'../asm_lifecycle_repo'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>group</code>和<code>version</code>都需要在app mudule引用此插件时使用。</p>
<p>所有的插件都需要被部署到maven库中，可以选择部署到远程或本地。这里只是演示，所以只是将插件部署到本地目录中。具体地址通过<code>repository</code>属性设置，这里将其配置在项目根目录下的<code>asm_lifecycle_repo</code>目录下。</p>
<p>最后一步，创建properties文件。</p>
<p>在plugin/src/main目录下新建目录resources/META-INF/gradle-plugins，然后在此目录下新建文件：tyler.asm.lifecycle.properties，其中文件名tyler.asm.lifecycle就是自定义插件的名称，后面在app module中会使用到。</p>
<p>在.properties文件中，需要指定自定义的插件类名LifeCyclePlugin，如下：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/properties文件.png">

<p>至此，自定义Gradle插件就已经写完，现在在Android Studio右栏找到Gradle中点击uploadArchives，执行plugin的部署任务。</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/部署plugin.png">

<p>构建成功后，在Project的根目录下将会出现一个repo目录，里面存放的就是插件目标文件。</p>
<h2 id="4-3-测试asm-lifecycle-plugin"><a href="#4-3-测试asm-lifecycle-plugin" class="headerlink" title="4.3 测试asm_lifecycle_plugin"></a>4.3 测试asm_lifecycle_plugin</h2><p>在app module的build.gradle引用此插件。</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/添加插件.png">

<ul>
<li>1、在自定义Gradle插件中properties的文件名(tyler.asm.lifecycle)。</li>
<li>2、<code>dependencies</code>中的<code>classpath</code>是<code>group</code>值 + module名 + version。</li>
</ul>
<p>然后在执行命令行中使用gradlew执行构建命令，如果打印出插件里的log，说明自定义插件可以使用：</p>
<img src="/2020/06/25/（拉钩）Android工程师进阶34讲-04：编译插桩操纵字节码，实现不可能完成的任务/命令测试插件.png">

<blockquote>
<p>也有比较成熟的第三方Gradle插件，如hiBever。</p>
</blockquote>
<h2 id="4-4-自定义Transform，实现遍历-class文件"><a href="#4-4-自定义Transform，实现遍历-class文件" class="headerlink" title="4.4 自定义Transform，实现遍历.class文件"></a>4.4 自定义Transform，实现遍历.class文件</h2><p>自定义Gradle插件已经写好，接下来就需要实现遍历所有.class的逻辑。这部分主要依赖Transform API。</p>
<h3 id="4-4-1-什么是Transform？"><a href="#4-4-1-什么是Transform？" class="headerlink" title="4.4.1 什么是Transform？"></a>4.4.1 什么是Transform？</h3><p>Transform可以被看做是Gradle在编译项目时的一个task，在.class文件转换成.dex的流程中会执行这些Task，对所有.class文件（可包含第三方库的.class）进行转换，转换的逻辑定义在Transform的<code>transform</code>方法中。实际上平时在build.gradle中常用的功能都是通过Transform实现的，比如混淆(proguard)、分包(multi-dex)、jar包合并(jarMerge)。</p>
<h4 id="4-4-2-自定义Transform"><a href="#4-4-2-自定义Transform" class="headerlink" title="4.4.2 自定义Transform"></a>4.4.2 自定义Transform</h4><p>在tyler.liu.plugin目录中，新建<code>LifeCycleTransform.groovy</code>，继承<code>Transform</code>类，并需要实现里面的方法。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tyler.liu.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.QualifiedContent</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.Transform</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> &#123;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    String getName() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;? super QualifiedContent.Scope&gt; getScopes() &#123;</span><br><span class="line">        return null</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    boolean isIncremental() &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    void transform(TransformInvocation transformInvocation) throws TransformException, InterruptedException, IOException &#123;</span><br><span class="line">        super.transform(transformInvocation)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Transform</code>的主要作用是检索项目编译过程中的所有文件。通过这几个方法，可以对自定义Transform设置一些遍历规则，具体如下：</p>
<ul>
<li><p><strong><code>getName()</code></strong>：设置自定义的<code>Transform</code>对应的Task名称。Gradle在编译的时候，会将这个名称显示在控制台上。比如：<code>app:transformClassesWithXXXForDebug</code>。</p>
</li>
<li><p><strong><code>getInputTypes()</code></strong>：在项目中会有各种各样格式的文件，通过<code>getInputType()</code>可以设置<code>LifeCycleTransform</code>接收的文件类型，此方法的返回值类型是<code>Set&lt;QualifiedContent.ContentType&gt;</code>。</p>
<p>  <code>ContentType</code>有以下两种取值：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The type of of the content.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> DefaultContentType implements ContentType &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The content is compiled Java code. This can be in a Jar file or in a folder. If</span></span><br><span class="line"><span class="comment">     * in a folder, it is expected to in sub-folders matching package names.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CLASSES(<span class="number">0x01</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** The content is standard Java resources. */</span></span><br><span class="line">    RESOURCES(<span class="number">0x02</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> value;</span><br><span class="line"></span><br><span class="line">    DefaultContentType(<span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>CLASSES</code>：表示只检索.class文件。</li>
<li><code>RESOURCES</code>：表示检索java标准资源文件。</li>
</ul>
</li>
<li><p><strong><code>getScopes()</code></strong>：这个方法规定自定义<code>Transform</code>检索的范围。<br>  有以下取值：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PROJECT                 // 只有项目内容</span><br><span class="line">SUB_PROJECTS            // 只有子项目</span><br><span class="line">EXTERNAL_LIBRARIES      // 只有外部库</span><br><span class="line">TESTED_CODE             // 由当前变量（包括依赖项）测试的代码</span><br><span class="line">PROVIDED_ONLY           // 只提供本地或远程依赖项</span><br><span class="line">PROJECT_LOCAL_DEPS      // 只有项目的本地依赖（本地jar）</span><br><span class="line">SUB_PROJECTS_LOCAL_DEPS // 只有子项目的本地依赖项（本地jar）</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>isIncremental</code></strong>：表示当前<code>Transform</code>是否支持增量编译，不需要增量编译，就直接返回<code>false</code>。</p>
</li>
<li><p><strong><code>transform()</code></strong>：在自定义<code>Transform</code>中最重要的方法。在这个方法中可以获取两个数据的流向。</p>
<ul>
<li><code>inputs</code>：<code>inputs</code>中传过来的输入流，其中有两种格式，一种是jar包格式，一种是directory（目录格式）。</li>
<li><code>outputProvider</code>：<code>outputProvider</code>获取到输出目录，最后将修改的文件复制到输出目录，这一步必须做，否则编译报错。</li>
</ul>
</li>
</ul>
<p>下面实现了一个简单的<code>LifeCycleTransform</code>，功能是打印出所有.class文件。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tyler.liu.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.DirectoryInput</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.QualifiedContent</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.Transform</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.TransformException</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.TransformInput</span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.TransformInvocation</span><br><span class="line"><span class="keyword">import</span> com.android.build.gradle.internal.pipeline.TransformManager</span><br><span class="line"><span class="keyword">import</span> groovy.io.FileType</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> &#123;</span></span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    String getName() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"LifeCycleTransform"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> TransformManager.CONTENT_CLASS</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;? super QualifiedContent.Scope&gt; getScopes() &#123;</span><br><span class="line">        return TransformManager.PROJECT_ONLY</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    boolean isIncremental() &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 4</span><br><span class="line">    @Override</span><br><span class="line">    void transform(TransformInvocation transformInvocation) throws TransformException, InterruptedException, IOException &#123;</span><br><span class="line">        // 拿到所有的class文件</span><br><span class="line">        Collection&lt;TransformInput&gt; transformInputs = transformInvocation.inputs</span><br><span class="line">        transformInputs.each &#123; TransformInput transformInput -&gt;</span><br><span class="line">            // directoryInputs代表以源码方式参与项目编译的所有目录结构及其目录下的源码文件</span><br><span class="line">            // 比如手写的类以及R.class、BuildConfig.class以及MainActivity.class等</span><br><span class="line">            transformInput.directoryInputs.each &#123; DirectoryInput directoryInput -&gt;</span><br><span class="line">                File dir = directoryInput.file</span><br><span class="line">                if (dir) &#123;</span><br><span class="line">                    dir.traverse(type: FileType.FILES, <span class="string">nameFilter:</span> <span class="regexp">~/.*\.class/</span>) &#123; File file -&gt;</span><br><span class="line">                        System.out.println(<span class="string">"find class: "</span> + file.name)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>1、自定义的<code>Transform</code>的名称为<code>LifeCycleTransform</code>。</li>
<li>2、检索项目中的.class类型的目录或者文件。</li>
<li>3、设置当前<code>Transform</code>检索范围为当前项目。</li>
<li>4、设置过滤文件为.class文件（去除文件夹类型），并打印文件名称。</li>
</ul>
<h3 id="4-4-2-将自定义的LifeCycleTransform注册到Gradle插件中"><a href="#4-4-2-将自定义的LifeCycleTransform注册到Gradle插件中" class="headerlink" title="4.4.2  将自定义的LifeCycleTransform注册到Gradle插件中"></a>4.4.2  将自定义的LifeCycleTransform注册到Gradle插件中</h3><p>在<code>LifeCyclePlugin</code>中添加如下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCyclePlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line">    <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">        System.out.println(<span class="string">"==LifeCyclePlugin gradle plugin=="</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">        println <span class="string">'------------- registering AutoTrackTransform -------------'</span></span><br><span class="line">        LifeCycleTransform transform = <span class="keyword">new</span> LifeCycleTransform()</span><br><span class="line">        android.registerTransform(transform)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次执行build，可以看到<code>LifeCycleTransform</code>检索出的所有.class文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Executing tasks: [clean, :app:assembleDebug] in project E:\Project\MyStudyDemo\ASMLifeCycleDemo</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt; Configure project :app</span><br><span class="line">==LifeCyclePlugin gradle plugin==</span><br><span class="line">------------- registering AutoTrackTransform -------------</span><br><span class="line"></span><br><span class="line">&gt; Task :clean</span><br><span class="line">&gt; Task :app:clean UP-TO-DATE</span><br><span class="line">&gt; Task :asm_lifecycle_plugin:clean UP-TO-DATE</span><br><span class="line">&gt; Task :app:preBuild UP-TO-DATE</span><br><span class="line">&gt; Task :app:preDebugBuild UP-TO-DATE</span><br><span class="line">&gt; Task :app:generateDebugBuildConfig</span><br><span class="line">&gt; Task :app:compileDebugAidl NO-SOURCE</span><br><span class="line">&gt; Task :app:compileDebugRenderscript NO-SOURCE</span><br><span class="line">&gt; Task :app:javaPreCompileDebug</span><br><span class="line">&gt; Task :app:generateDebugResValues</span><br><span class="line">&gt; Task :app:generateDebugResources</span><br><span class="line">&gt; Task :app:createDebugCompatibleScreenManifests</span><br><span class="line">&gt; Task :app:extractDeepLinksDebug</span><br><span class="line">&gt; Task :app:processDebugManifest</span><br><span class="line">&gt; Task :app:mergeDebugResources</span><br><span class="line">&gt; Task :app:processDebugResources</span><br><span class="line">&gt; Task :app:compileDebugJavaWithJavac</span><br><span class="line">&gt; Task :app:compileDebugSources</span><br><span class="line">&gt; Task :app:mergeDebugShaders</span><br><span class="line">&gt; Task :app:compileDebugShaders NO-SOURCE</span><br><span class="line">&gt; Task :app:generateDebugAssets UP-TO-DATE</span><br><span class="line">&gt; Task :app:mergeDebugAssets</span><br><span class="line">&gt; Task :app:processDebugJavaRes NO-SOURCE</span><br><span class="line"></span><br><span class="line">&gt; Task :app:transformClassesWithLifeCycleTransformForDebug</span><br><span class="line">find class: BuildConfig.class</span><br><span class="line">find class: MainActivity.class</span><br><span class="line"></span><br><span class="line">&gt; Task :app:checkDebugDuplicateClasses</span><br><span class="line">&gt; Task :app:dexBuilderDebug</span><br><span class="line">&gt; Task :app:mergeDebugJavaResource</span><br><span class="line">&gt; Task :app:mergeDebugJniLibFolders</span><br><span class="line">&gt; Task :app:validateSigningDebug</span><br><span class="line">&gt; Task :app:mergeExtDexDebug</span><br><span class="line">&gt; Task :app:mergeDebugNativeLibs</span><br><span class="line">&gt; Task :app:stripDebugDebugSymbols NO-SOURCE</span><br><span class="line">&gt; Task :app:mergeDexDebug</span><br><span class="line">&gt; Task :app:packageDebug</span><br><span class="line">&gt; Task :app:assembleDebug</span><br><span class="line"></span><br><span class="line">Deprecated Gradle features were used in this build, making it incompatible with Gradle 7.0.</span><br><span class="line">Use &apos;--warning-mode all&apos; to show the individual deprecation warnings.</span><br><span class="line">See https://docs.gradle.org/6.1.1/userguide/command_line_interface.html#sec:command_line_warnings</span><br><span class="line"></span><br><span class="line">BUILD SUCCESSFUL in 5s</span><br><span class="line">24 actionable tasks: 22 executed, 2 up-to-date</span><br><span class="line"></span><br><span class="line">Build Analyzer results available</span><br></pre></td></tr></table></figure>

<p>可以看到，Gradle编译时，多了一个自定义的<code>LifeCycleTransform</code>类型的任务，并且将所有.class文件打印出来，其中包含目标文件MainActivity.class。</p>
<h2 id="4-5-使用ASM，插入字节码到Activity中"><a href="#4-5-使用ASM，插入字节码到Activity中" class="headerlink" title="4.5 使用ASM，插入字节码到Activity中"></a>4.5 使用ASM，插入字节码到Activity中</h2><p>ASM是一套开源框架，其中几个常见的API如下：</p>
<ul>
<li><code>ClassReader</code>：负责解析.class文件中的字节码，并将所有字节码传递给<code>ClassWriter</code>。</li>
<li><code>ClassVisitor</code>：负责访问.class文件中的各个元素，<code>ClassVisitor</code>就是用来解析上节说到的.class文件结构，当解析到某些特定结构时（比如类变量、方法），它会自动调用内部相应的<code>FieldVisitor</code>和<code>MethodVisitor</code>的方法，进一步解析或修改.class文件内容。</li>
<li><code>ClassWriter</code>：继承自<code>ClassVisitor</code>，它是生成字节码的工具类，负责将修改后的字节码输出为byte数组。</li>
</ul>
<h3 id="4-5-1-添加ASM依赖"><a href="#4-5-1-添加ASM依赖" class="headerlink" title="4.5.1 添加ASM依赖"></a>4.5.1 添加ASM依赖</h3><p>在<code>asm_lifecycle_pligun</code>的build.gradle中，添加ASM的依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    ...</span><br><span class="line">    // ASM依赖</span><br><span class="line">    implementation &quot;org.ow2.asm:asm:7.1&quot;</span><br><span class="line">    implementation &quot;org.ow2.asm:asm-commons:7.1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-2-创建自定义ASM-Visitor类"><a href="#4-5-2-创建自定义ASM-Visitor类" class="headerlink" title="4.5.2 创建自定义ASM Visitor类"></a>4.5.2 创建自定义ASM Visitor类</h3><p>在<code>asm_lifecycle_plugin</code>中的src/main/java目录下创建包tyler.liu.asm，并分别创建<code>LifeCycleClassVisitor.java</code>和<code>LifeCycleMethodVisitor.java</code>。</p>
<p><strong><code>LifeCycleClassVisitor.java</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tyler.liu.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Liuyang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleClassVisitor</span> <span class="keyword">extends</span> <span class="title">ClassVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="keyword">private</span> String superName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleClassVisitor</span><span class="params">(ClassVisitor classVisitor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Opcodes.ASM5, classVisitor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visit</span><span class="params">(<span class="keyword">int</span> version, <span class="keyword">int</span> access, String name, String signature, String superName, String[] interfaces)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visit(version, access, name, signature, superName, interfaces);</span><br><span class="line">        <span class="keyword">this</span>.className = className;</span><br><span class="line">        <span class="keyword">this</span>.superName = superName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodVisitor <span class="title">visitMethod</span><span class="params">(<span class="keyword">int</span> access, String name, String descriptor, String signature, String[] exceptions)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"ClassVisitor visitMethod name -----"</span> + name + <span class="string">", superName is"</span> + superName);</span><br><span class="line">        MethodVisitor mv = cv.visitMethod(access, name, descriptor, signature, exceptions);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">"android/support/v7/app/AppCompatActivity"</span>.equals(superName)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (name.startsWith(<span class="string">"onCreate"</span>)) &#123;</span><br><span class="line">                <span class="comment">// 处理onCreate方法</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> LifeCycleMethodVisitor(mv, className, name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mv;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitEnd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visitEnd();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&quot;android/support/v7/app/AppCompatActivity&quot;.equals(superName)</code>，用来过滤出继承<code>AppCompatActivity</code>的文件，并在<code>LifeCycleMethodVisitor.java</code>中对<code>onCreate</code>进行改造。</p>
<p><strong><code>LifeCycleMethodVisitor.java</code></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tyler.liu.asm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.MethodVisitor;</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.Opcodes;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Liuyang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/29</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleMethodVisitor</span> <span class="keyword">extends</span> <span class="title">MethodVisitor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String className;</span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifeCycleMethodVisitor</span><span class="params">(MethodVisitor methodVisitor, String className, String methodName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Opcodes.ASM5, methodVisitor);</span><br><span class="line">        <span class="keyword">this</span>.className = className;</span><br><span class="line">        <span class="keyword">this</span>.methodName = methodName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 方法执行前插入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">visitCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.visitCode();</span><br><span class="line">        System.out.println(<span class="string">"MethodVisitor visitCode ----------------"</span>);</span><br><span class="line"></span><br><span class="line">        mv.visitLdcInsn(<span class="string">"TAG"</span>);</span><br><span class="line">        mv.visitLdcInsn(className + <span class="string">"-----&gt;"</span> + methodName);</span><br><span class="line">        mv.visitMethodInsn(Opcodes.INVOKESTATIC, <span class="string">"android/util/Log"</span>, <span class="string">"i"</span>, <span class="string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, <span class="keyword">false</span>);</span><br><span class="line">        mv.visitInsn(Opcodes.POP);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>visitCode()</code>中，是真正执行插入字节码的逻辑。可以看出ASM都是直接以字节码指令的方式进行操作的，所以如果想使用ASM，需要对字节码由一定了解。如果对字节码不是很了解，也可以使用第三方工具ASM ByteCode Outline来生成想要的字节码。</p>
<h2 id="4-5-3-修改LifeCycleTransform的tranform方法，使用ASM"><a href="#4-5-3-修改LifeCycleTransform的tranform方法，使用ASM" class="headerlink" title="4.5.3 修改LifeCycleTransform的tranform方法，使用ASM"></a>4.5.3 修改LifeCycleTransform的tranform方法，使用ASM</h2><p>各种Visitor定义好之后，就可以修改<code>LifeCycleTransform</code>的<code>transform</code>方法，并将需要插桩的字节码插入到<code>MainActivity.class</code>文件中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> tyler.liu.plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.build.api.transform.*</span><br><span class="line"><span class="keyword">import</span> com.android.build.gradle.internal.pipeline.TransformManager</span><br><span class="line"><span class="keyword">import</span> com.android.utils.FileUtils</span><br><span class="line"><span class="keyword">import</span> groovy.io.FileType</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassReader</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassVisitor</span><br><span class="line"><span class="keyword">import</span> org.objectweb.asm.ClassWriter</span><br><span class="line"><span class="keyword">import</span> tyler.liu.asm.LifecycleClassVisitor</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LifeCycleTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"LifeCycleTransform"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> TransformManager.CONTENT_CLASS</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    Set&lt;? <span class="keyword">super</span> QualifiedContent.Scope&gt; getScopes() &#123;</span><br><span class="line">        <span class="keyword">return</span> TransformManager.PROJECT_ONLY</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isIncremental</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">transform</span><span class="params">(TransformInvocation transformInvocation)</span> <span class="keyword">throws</span> TransformException, InterruptedException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到所有的class文件</span></span><br><span class="line">        Collection&lt;TransformInput&gt; transformInputs = transformInvocation.inputs</span><br><span class="line">        TransformOutputProvider outputProvider = transformInvocation.outputProvider</span><br><span class="line"></span><br><span class="line">        transformInputs.each &#123; TransformInput transformInput -&gt;</span><br><span class="line">            <span class="comment">// directoryInputs代表以源码方式参与项目编译的所有目录结构及其目录下的源码文件</span></span><br><span class="line">            <span class="comment">// 比如手写的类以及R.class、BuildConfig.class以及MainActivity.class等</span></span><br><span class="line">            transformInput.directoryInputs.each &#123; DirectoryInput directoryInput -&gt;</span><br><span class="line">                File dir = directoryInput.file</span><br><span class="line">                <span class="keyword">if</span> (dir) &#123;</span><br><span class="line">                    dir.traverse(type: FileType.FILES, nameFilter: ~/.*\.class/) &#123; File file -&gt;</span><br><span class="line">                        System.out.println(<span class="string">"find class: "</span> + file.name)</span><br><span class="line">                        <span class="comment">// 对class文件进行读取和解析</span></span><br><span class="line">                        ClassReader classReader = <span class="keyword">new</span> ClassReader(file.bytes)</span><br><span class="line">                        <span class="comment">// 对class文件的写入</span></span><br><span class="line">                        ClassWriter classWriter = <span class="keyword">new</span> ClassWriter(classReader, ClassWriter.COMPUTE_MAXS)</span><br><span class="line">                        <span class="comment">// 访问class文件相应的内容，解析到某一个结构就会通知到ClassVisitor的相应方法</span></span><br><span class="line">                        ClassVisitor classVisitor = <span class="keyword">new</span> LifecycleClassVisitor(classWriter)</span><br><span class="line">                        <span class="comment">// 依次调用ClassVisitor接口的各个方法</span></span><br><span class="line">                        classReader.accept(classVisitor, ClassReader.EXPAND_FRAMES)</span><br><span class="line">                        <span class="comment">// toByteArray方法会将最终修改的字节码以byte数组形式返回</span></span><br><span class="line">                        <span class="keyword">byte</span>[] bytes = classWriter.toByteArray()</span><br><span class="line">                        <span class="comment">// 通过文件流写入方式覆盖掉原先的内容，实现class文件的改写</span></span><br><span class="line">                        FileOutputStream outputStream = <span class="keyword">new</span> FileOutputStream(file.path)</span><br><span class="line">                        outputStream.write(<span class="keyword">byte</span>)</span><br><span class="line">                        outputStream.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 处理完传输文件后，把输出传给下一个文件</span></span><br><span class="line">                def dest = outputProvider.getContentLocation(directoryInput.name, directoryInput.contentTypes,</span><br><span class="line">                        directoryInput.scopes, Format.DIRECTORY)</span><br><span class="line">                FileUtils.copyDirectory(directoryInput.file, dest)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-5-4-重新部署自定义Gradle插件，并运行主项目"><a href="#4-5-4-重新部署自定义Gradle插件，并运行主项目" class="headerlink" title="4.5.4 重新部署自定义Gradle插件，并运行主项目"></a>4.5.4 重新部署自定义Gradle插件，并运行主项目</h3><p>重新点击uploadAtchives重新部署LifeCyclePlugin。</p>
<p>部署成功后，重新运行APP主项目，当MainActivity被打开时，会在logcat看到如下日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-06-30 10:00:10.333 5421-5421/com.ly.asmlifecycledemo I/TAG: com/ly/asmlifecycledemo/MainActivity----&gt;onCreate</span><br></pre></td></tr></table></figure>

<p>如果后续有新的Activity，如<code>BActivity.java</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ly.asmlifecycledemo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Liuyang</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2020/6/30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在<code>MainActivity</code>中实现点击按钮跳转到<code>BActivity</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        Button btn = findViewById(R.id.btn);</span><br><span class="line">        btn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                startActivity(<span class="keyword">new</span> Intent(MainActivity.<span class="keyword">this</span>, BActivity.class));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印日志如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-06-30 10:13:21.105 5647-5647/com.ly.asmlifecycledemo I/TAG: com/ly/asmlifecycledemo/MainActivity----&gt;onCreate</span><br><span class="line">2020-06-30 10:13:31.546 5647-5647/com.ly.asmlifecycledemo I/TAG: com/ly/asmlifecycledemo/BActivity----&gt;onCreate</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>如果在项目中打开混淆，注入的字节码还能正常工作吗？混淆其实也是一个<code>Transform</code>，叫做<code>ProguardTransform</code>，它是在自定义的<code>Transform</code>之后执行。</strong></p>
</blockquote>

      
      <!-- reward -->
      
    </div>
    
    
      <!-- copyright -->
      
    <footer class="article-footer">
      
          
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASYAAAEmCAAAAADqr2IGAAAElklEQVR42u3a244iORAFwP7/n2ZfR0LAOZnV2jId9YR6CmyHR3Je/PMTP4+n59+/P39OfuH5/Uf55KPk81w9mDBhwoTplkz5T+fLy3Gff+fV59kcklGibcCECRMmTIcztZN+9d091vvF5EHG+2/la8eECRMmTH+TKQFKCNqpJ9uQzxwTJkyYMGFqD/7k/Rx0drTPEDFhwoQJ03czXXWsvl9MjtiGCy3WL9bCMWHChAnTzZjyI/n7Pv/K/SZMmDBhwnQbpkf55Ad8PmLe8nwsntWqMWHChAnTsUz5Itvh28BiH5RcNcOXb2LChAkTpgOZ8kbmtYXg9gJQ3p78lcYqJkyYMGE6lqm9lJNPa9M+fL957aE+C0qiuAkTJkyYMN2eaVZC3SS0bRAw42i36sPMMWHChAnTsUx5mpoPn0+9RZyVdNtvfYibMGHChAnTsUyb8m5+LaZtT+YbsGmLJjPEhAkTJkwnMuXHdrKMJK3Nr/VsfqFtiH5ItjFhwoQJ0+FM7WGcF2o3B3O7MfkG1C1VTJgwYcJ0ONO+c9emsvkRnoy7T9SLizuYMGHChOkopjatnV2UmZVuW5rNmxErJkyYMGE6kOmqkmveYpwVXtswpcX6EKBgwoQJE6avYJqVbtuCbDK5vFDbBhNtWBNFTJgwYcKE6fZMVzUF95dpZsHELOMvGqiYMGHChOlwpmsbljlfm77OSrQXNDgxYcKECdOxTMU/X7S8GeLmStDP6Il6v5gwYcKE6fZMm8ujm5ZnXmDdXwnK1/WSGBMmTJgwHc70fup5orsvuV6bhO9boVGRFxMmTJgw3Zgpv4IzO243AcQssEiWugk+MGHChAnTWUzvD848dbz24M+XXR/nI1BMmDBhwnQuU/vqpkGYl1nzAzsPGvIC8QWimDBhwoTpNkz5EZgf8zn3Pp3OW5Kzz3XchAkTJkyYbsk0u1KzaSW2F3ryWvUmMf5Q5MWECRMmTAcyJcdtHihs0umkTLxPaFdpMCZMmDBhOpCpnVBylLYbkB/SeRrcJrofth8TJkyYMB3OlP9EvuwWPd+YvKTb/uXl6Y8JEyZMmL6CaX8A50+eQiffbVuYbfCBCRMmTJjOZZpdrJk1QTdBxiyhnRWvP8wZEyZMmDAdxZQfsXlLct9unB3274u8mzIxJkyYMGE6nWnWdGyXWrQPyyuwmxAhmiEmTJgwYfoKpra0uvlWcsnmN0acbR4mTJgwYTqdqW0c5ribdummSdkm1R/mjwkTJkyYvoKpTW73382v4+xHTxLgl3/BhAkTJkzHMu2H2YQR+SHdFpHbUfLRMWHChAnTWUyP8tkkqznirBmZJ8P5WD/J/wtMmDBhwnRjplnCOfu5vJF5VaCQX+VpW6SYMGHChOkspjwIyBffXpTZX8FJUvRZ4xYTJkyYMH0H01Vl0336em04ko/4YbMxYcKECdOfYdonn23aOWuazoKSl+9gwoQJE6Y/xtSmwW1hNw8jZsXcvOWJCRMmTJi+g6m9rJMM8H81OxPo9/N8GRBgwoQJE6YDmdohN6Xb2QWavNTbbvnwHhMmTJgwYTqD6T/3py/gEA5/bQAAAABJRU5ErkJggg==" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JVM与DVM必知必会/">JVM与DVM必知必会</a></li></ul>


    </footer>

  </div>

  
  
  <nav class="article-nav">
    
    
      <a href="/2020/06/21/（拉钩）Android工程师进阶34讲-03：字节码层面分析class类文件结构/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">（拉钩）Android工程师进阶34讲-03：字节码层面分析class类文件结构</div>
      </a>
    
  </nav>


  

  
  
<!-- valine评论 -->
<div id="vcomments-box">
    <div id="vcomments">
    </div>
</div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script>
    new Valine({
        el: '#vcomments',
        app_id: '',
        app_key: '',
        path: window.location.pathname,
        notify: 'false',
        verify: 'false',
        avatar: 'monsterid',
        placeholder: '给我的文章加点评论吧~',
        recordIP: true
    });
    const infoEle = document.querySelector('#vcomments .info');
    if (infoEle && infoEle.childNodes && infoEle.childNodes.length > 0) {
        infoEle.childNodes.forEach(function (item) {
            item.parentNode.removeChild(item);
        });
    }
</script>
<style>
    #vcomments-box {
        padding: 5px 30px;
    }

    @media screen and (max-width: 800px) {
        #vcomments-box {
            padding: 5px 0px;
        }
    }

    #vcomments-box #vcomments {
        background-color: #fff;
    }

    .v .vlist .vcard .vh {
        padding-right: 20px;
    }

    .v .vlist .vcard {
        padding-left: 10px;
    }
</style>

  

  
  
  
  
  

</article>
</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2019-2020
        <i class="ri-heart-fill heart_icon"></i> Tyler Liu
      </li>
    </ul>
    <ul>
      <li>
        
        
        
        Powered by <a href="https://hexo.io" target="_blank">Hexo</a>
        <span class="division">|</span>
        Theme - <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
      <div class="float_btns">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

      </div>
    </main>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="Tyler的博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="ri-rss-line"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <script>
      if (window.matchMedia("(max-width: 768px)").matches) {
        document.querySelector('.content').classList.remove('on');
        document.querySelector('.sidebar').classList.remove('on');
      }
    </script>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="https://cdn.jsdelivr.net/gh/Shen-Yu/cdn/img/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<!-- Subtitle -->

<script>
  try {
    var typed = new Typed("#subtitle", {
      strings: ['人生是一场难得的修行，不要轻易交白卷', '', ''],
      startDelay: 0,
      typeSpeed: 200,
      loop: true,
      backSpeed: 100,
      showCursor: true
    });
  } catch (err) {
    console.log(err)
  }
</script>

<!-- Tocbot -->

<script src="/js/tocbot.min.js"></script>
<script>
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: 'main',
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto'
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">
<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js"></script>
<script src="/dist/main.js"></script>
<!-- ImageViewer -->

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>

<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<script src="/js/clickLove.js"></script>

<!-- ClickBoom -->

<script src="/js/clickBoom.js"></script>

<!-- CodeCopy -->

<link rel="stylesheet" href="/css/clipboard.css">
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>



    
  </div>
</body>

</html>